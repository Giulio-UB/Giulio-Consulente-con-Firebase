import React, { useState, useEffect } from 'react';
import { initializeApp } from 'firebase/app';
import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from 'firebase/auth';
import { getFirestore, collection, addDoc, updateDoc, doc, query, onSnapshot, deleteDoc, orderBy, where } from 'firebase/firestore';
import { 
  Trash2, Edit, Plus, Save, Printer, Share2, Search, FileText, 
  LayoutGrid, List, Loader2, ExternalLink, Factory, Home, Trophy,
  Menu, X, PieChart, Settings, Users, LogOut, ChevronRight, ChevronLeft,
  Bell, CheckSquare, TrendingUp, DollarSign, Calendar as CalendarIcon, 
  CheckCircle2, Circle, Clock, BarChart3, Gauge, CalendarDays, AlertCircle, MapPin, Zap, Sparkles, Calculator, Flame, UserCircle, Kanban, ArrowRight, ArrowLeft,
  StickyNote, Sun, Thermometer, Box, Battery, UserCheck, Phone, Mail
} from 'lucide-react';

// --- CONFIGURAZIONE FIREBASE ---
const firebaseConfig = JSON.parse(__firebase_config);
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

// --- GEMINI API SETUP ---
const apiKey = ""; 

// --- COMPONENTE PRINCIPALE (LAYOUT) ---
export default function App() {
  const [user, setUser] = useState(null);
  const [loading, setLoading] = useState(true);
  const [activeModule, setActiveModule] = useState('dashboard'); 
  const [moduleData, setModuleData] = useState(null); 
  const [isSidebarOpen, setIsSidebarOpen] = useState(false);

  // Auth Init
  useEffect(() => {
    const initAuth = async () => {
      try {
        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
          await signInWithCustomToken(auth, __initial_auth_token);
        } else {
          await signInAnonymously(auth);
        }
      } catch (err) { console.error("Auth Error", err); }
    };
    initAuth();
    const unsubscribe = onAuthStateChanged(auth, (u) => { setUser(u); if(!u) setLoading(false); });
    return () => unsubscribe();
  }, []);

  const toggleSidebar = () => setIsSidebarOpen(!isSidebarOpen);

  const navigateToModule = (moduleName, data = null) => {
      setActiveModule(moduleName);
      setModuleData(data);
      setIsSidebarOpen(false);
  };

  if (loading) return <div className="flex h-screen items-center justify-center bg-slate-50 text-blue-600 gap-2"><Loader2 className="animate-spin" /> Caricamento Gestionale...</div>;

  return (
    <div className="flex h-screen bg-slate-100 font-sans text-slate-800 overflow-hidden">
      
      {/* SIDEBAR */}
      <aside className={`
        fixed inset-y-0 left-0 z-50 w-64 bg-slate-900 text-white transform transition-transform duration-300 ease-in-out shadow-2xl
        ${isSidebarOpen ? 'translate-x-0' : '-translate-x-full'} md:translate-x-0 md:static md:flex-shrink-0
      `}>
        <div className="h-16 flex items-center px-6 border-b border-slate-700 bg-slate-950">
          <div className="flex items-center gap-2 font-bold text-lg tracking-tight">
            <div className="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center text-white">G</div>
            <span className="text-blue-100">Giulio Consulente</span>
          </div>
          <button onClick={toggleSidebar} className="md:hidden ml-auto text-slate-400 hover:text-white"><X size={24} /></button>
        </div>

        <nav className="p-4 space-y-2 flex-1 overflow-y-auto">
          <div className="text-xs font-bold text-green-400 uppercase tracking-wider mb-2 px-2">Panoramica</div>
          
          <MenuItem 
            icon={<Gauge size={20} />} 
            label="Pannello di Controllo" 
            active={activeModule === 'dashboard'} 
            onClick={() => navigateToModule('dashboard')} 
          />

          <MenuItem 
            icon={<Kanban size={20} />} 
            label="Pipeline Lead" 
            active={activeModule === 'pipeline'} 
            onClick={() => navigateToModule('pipeline')} 
            badge="Vendite"
          />

          <div className="mt-6 text-xs font-bold text-red-400 uppercase tracking-wider mb-2 px-2">OperativitÃ </div>

          <MenuItem 
            icon={<LayoutGrid size={20} />} 
            label="Audit Manager" 
            active={activeModule === 'audits'} 
            onClick={() => navigateToModule('audits')} 
          />

          <MenuItem 
            icon={<Calculator size={20} />} 
            label="Simulazioni Veloci" 
            active={activeModule === 'simulations'} 
            onClick={() => navigateToModule('simulations')} 
          />

          <MenuItem 
            icon={<Bell size={20} />} 
            label="Promemoria" 
            active={activeModule === 'reminders'} 
            onClick={() => navigateToModule('reminders')} 
          />

          <MenuItem 
            icon={<StickyNote size={20} />} 
            label="Appunti Rapidi" 
            active={activeModule === 'quicknotes'} 
            onClick={() => navigateToModule('quicknotes')} 
          />
          
          <div className="mt-6 text-xs font-semibold text-slate-500 uppercase tracking-wider mb-2 px-2">Analisi & Config</div>

          <MenuItem 
            icon={<Users size={20} />} 
            label="Clienti" 
            active={activeModule === 'clients'} 
            onClick={() => navigateToModule('clients')} 
          />

          <MenuItem 
            icon={<PieChart size={20} />} 
            label="Calcolatore ROI" 
            active={activeModule === 'roi'} 
            onClick={() => navigateToModule('roi')} 
            badge="Presto"
          />

          <MenuItem 
            icon={<Settings size={20} />} 
            label="Impostazioni" 
            active={activeModule === 'settings'} 
            onClick={() => navigateToModule('settings')} 
          />
        </nav>

        <div className="p-4 border-t border-slate-800 bg-slate-950">
          <div className="flex items-center gap-3">
            <div className="w-10 h-10 rounded-full bg-slate-700 flex items-center justify-center text-slate-300"><span className="font-bold">GC</span></div>
            <div className="flex-1 min-w-0">
              <p className="text-sm font-medium text-white truncate">Giulio C.</p>
              <p className="text-xs text-slate-400 truncate">Pro Account</p>
            </div>
          </div>
        </div>
      </aside>

      {isSidebarOpen && <div className="fixed inset-0 bg-black/50 z-40 md:hidden" onClick={toggleSidebar}></div>}

      <main className="flex-1 flex flex-col min-w-0 overflow-hidden">
        <header className="md:hidden bg-white border-b border-slate-200 h-16 flex items-center justify-between px-4 sticky top-0 z-30">
          <div className="flex items-center gap-2">
            <button onClick={toggleSidebar} className="text-slate-600 hover:bg-slate-100 p-2 rounded-lg"><Menu size={24} /></button>
            <h1 className="font-bold text-slate-800">Pannello di Controllo</h1>
          </div>
        </header>

        <div className="flex-1 overflow-y-auto p-4 md:p-8">
          {activeModule === 'dashboard' && <DashboardOverview user={user} appId={appId} navigateToModule={navigateToModule} />}
          {activeModule === 'pipeline' && <PipelineModule user={user} appId={appId} navigateToModule={navigateToModule} />}
          {(activeModule === 'audits' || activeModule === 'audits-new') && <AuditManager key={activeModule} user={user} appId={appId} initialMode={activeModule === 'audits-new' ? 'new' : 'list'} setActiveModule={setActiveModule} />}
          {activeModule === 'reminders' && <RemindersManager user={user} appId={appId} initialData={moduleData} />}
          {activeModule === 'quicknotes' && <QuickNotesManager user={user} appId={appId} />}
          {activeModule === 'simulations' && <QuickSimulationsModule />}
          {activeModule === 'clients' && <ClientsModule user={user} appId={appId} navigateToModule={navigateToModule} />}
          
          {['roi', 'settings'].includes(activeModule) && (
            <PlaceholderModule title="Modulo in Sviluppo" icon={<Settings size={48} />} desc="Questa funzionalitÃ  sarÃ  disponibile nel prossimo aggiornamento." />
          )}
        </div>
      </main>
    </div>
  );
}

// --- MODULO: CLIENTI (NUOVO) ---
function ClientsModule({ user, appId, navigateToModule }) {
    const [clients, setClients] = useState([]);
    const [loading, setLoading] = useState(true);
    const [searchTerm, setSearchTerm] = useState('');
    const [dialog, setDialog] = useState(null); // NUOVO STATO MODALE
    const [editingClient, setEditingClient] = useState(null); // NUOVO STATO EDIT SCHEDA
    const [isSaving, setIsSaving] = useState(false); // STATO SALVATAGGIO

    useEffect(() => {
        if (!user) return;
        const unsubscribe = onSnapshot(collection(db, 'artifacts', appId, 'users', user.uid, 'clients'), (snapshot) => {
            const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            data.sort((a, b) => new Date(b.convertedAt || b.createdAt) - new Date(a.convertedAt || a.createdAt));
            setClients(data);
            setLoading(false);
        });
        return () => unsubscribe();
    }, [user, appId]);

    const handleDelete = async (id, companyName) => {
        setDialog({
            title: "Elimina Cliente",
            message: `Sei sicuro di voler eliminare il cliente ${companyName}? L'operazione Ã¨ irreversibile.`,
            type: 'confirm',
            onConfirm: async () => {
                setDialog(null);
                await deleteDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'clients', id));
            },
            onCancel: () => setDialog(null)
        });
    };

    // LOGICA DI SALVATAGGIO SCHEDA CLIENTE
    const handleSaveClient = async () => {
        if (!editingClient.company) {
            setDialog({ title: "Attenzione", message: "Ragione Sociale / Cliente obbligatorio", type: 'alert', onConfirm: () => setDialog(null) });
            return;
        }
        setIsSaving(true);
        try {
            const { id, ...data } = editingClient;
            await updateDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'clients', id), data);
            setEditingClient(null);
            setDialog({ title: "Successo", message: "âœ… Scheda cliente aggiornata correttamente!", type: 'alert', onConfirm: () => setDialog(null) });
        } catch (error) {
            console.error("Errore salvataggio", error);
            setDialog({ title: "Errore", message: "Si Ã¨ verificato un errore durante il salvataggio.", type: 'alert', onConfirm: () => setDialog(null) });
        } finally {
            setIsSaving(false);
        }
    };

    const filteredClients = clients.filter(c => 
        (c.company && c.company.toLowerCase().includes(searchTerm.toLowerCase())) ||
        (c.name && c.name.toLowerCase().includes(searchTerm.toLowerCase())) ||
        (c.city && c.city.toLowerCase().includes(searchTerm.toLowerCase()))
    );

    if (loading) return <div className="p-10 text-center"><Loader2 className="animate-spin mx-auto text-blue-500"/></div>;

    return (
        <div className="max-w-6xl mx-auto h-full flex flex-col space-y-6 relative">
            {/* --- RENDER MODALE CUSTOM CLIENTI --- */}
            {dialog && (
                <div className="fixed inset-0 bg-black/50 z-[100] flex items-center justify-center p-4">
                    <div className="bg-white rounded-xl p-6 max-w-sm w-full shadow-2xl animate-in fade-in zoom-in duration-200">
                        <h3 className="font-bold text-lg text-slate-800 mb-2">{dialog.title}</h3>
                        <p className="text-slate-600 mb-6 whitespace-pre-wrap">{dialog.message}</p>
                        <div className="flex justify-end gap-3">
                            {dialog.type === 'confirm' && (
                                <button onClick={dialog.onCancel} className="px-4 py-2 rounded-lg font-medium text-slate-600 hover:bg-slate-100 transition">Annulla</button>
                            )}
                            <button onClick={dialog.onConfirm} className="px-4 py-2 rounded-lg font-bold bg-blue-600 text-white hover:bg-blue-700 transition">OK</button>
                        </div>
                    </div>
                </div>
            )}
            
            <div className="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                <div>
                    <h2 className="text-2xl font-bold text-slate-800 flex items-center gap-2"><Users className="text-blue-600"/> Anagrafica Clienti</h2>
                    <p className="text-slate-500 mt-1">Gestisci i tuoi clienti acquisiti e mantieni lo storico contatti.</p>
                </div>
                <div className="relative w-full md:w-64">
                    <Search className="absolute left-3 top-1/2 transform -translate-y-1/2 text-slate-400" size={18} />
                    <input 
                        type="text" 
                        placeholder="Cerca cliente..." 
                        value={searchTerm}
                        onChange={e => setSearchTerm(e.target.value)}
                        className="w-full pl-10 pr-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none"
                    />
                </div>
            </div>

            <div className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden flex-1 flex flex-col">
                <div className="overflow-x-auto">
                    <table className="w-full text-left border-collapse">
                        <thead>
                            <tr className="bg-slate-50 border-b border-slate-200 text-xs uppercase tracking-wider text-slate-500 font-bold">
                                <th className="p-4">Azienda / Cliente</th>
                                <th className="p-4">Contatti</th>
                                <th className="p-4 hidden md:table-cell">Luogo</th>
                                <th className="p-4">Tipo</th>
                                <th className="p-4 hidden sm:table-cell">Acquisito Il</th>
                                <th className="p-4 text-right">Azioni</th>
                            </tr>
                        </thead>
                        <tbody className="divide-y divide-slate-100">
                            {filteredClients.length === 0 ? (
                                <tr>
                                    <td colSpan="6" className="p-8 text-center text-slate-400">
                                        {searchTerm ? 'Nessun cliente trovato con questa ricerca.' : 'Nessun cliente in anagrafica. Converti un Lead dalla Pipeline per iniziare.'}
                                    </td>
                                </tr>
                            ) : (
                                filteredClients.map(client => (
                                    <tr key={client.id} className="hover:bg-slate-50 transition">
                                        <td className="p-4">
                                            <div className="font-bold text-slate-800">{client.company}</div>
                                            {client.source === 'Audit' && <span className="text-[10px] bg-blue-100 text-blue-700 px-1.5 py-0.5 rounded mt-1 inline-block">Da Audit</span>}
                                        </td>
                                        <td className="p-4">
                                            <div className="text-sm font-medium text-slate-700 flex items-center gap-1.5"><UserCircle size={14} className="text-slate-400"/> {client.name}</div>
                                            <div className="text-xs text-slate-500 flex items-center gap-1.5 mt-0.5"><Phone size={12} className="text-slate-400"/> {client.phone}</div>
                                        </td>
                                        <td className="p-4 hidden md:table-cell text-sm text-slate-600">
                                            <div className="flex items-center gap-1.5"><MapPin size={14} className="text-slate-400"/> {client.city || '-'}</div>
                                        </td>
                                        <td className="p-4">
                                            <span className={`text-xs font-bold px-2 py-1 rounded-full ${client.type === 'ASD' ? 'bg-yellow-100 text-yellow-700' : client.type === 'Residenziale' ? 'bg-green-100 text-green-700' : 'bg-blue-100 text-blue-700'}`}>
                                                {client.type}
                                            </span>
                                        </td>
                                        <td className="p-4 hidden sm:table-cell text-sm text-slate-500">
                                            {client.convertedAt ? new Date(client.convertedAt).toLocaleDateString() : '-'}
                                        </td>
                                        <td className="p-4 text-right">
                                            <div className="flex items-center justify-end gap-2">
                                                <button onClick={() => setEditingClient({ ...client })} className="p-1.5 text-slate-400 hover:text-blue-500 hover:bg-blue-50 rounded transition" title="Modifica Scheda Cliente">
                                                    <Edit size={18}/>
                                                </button>
                                                <button onClick={() => handleDelete(client.id, client.company)} className="p-1.5 text-slate-400 hover:text-red-500 hover:bg-red-50 rounded transition" title="Elimina Cliente">
                                                    <Trash2 size={18}/>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                ))
                            )}
                        </tbody>
                    </table>
                </div>
            </div>

            {/* --- RENDER MODALE EDIT CLIENTE --- */}
            {editingClient && (
                <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
                    <div className="bg-white rounded-xl p-6 w-full max-w-2xl shadow-2xl max-h-[90vh] overflow-y-auto custom-scrollbar">
                        <div className="flex justify-between items-center mb-6 border-b border-slate-100 pb-4">
                            <h3 className="font-bold text-xl text-slate-800 flex items-center gap-2"><UserCheck className="text-blue-600"/> Modifica Scheda Cliente</h3>
                            <button onClick={() => setEditingClient(null)} className="text-slate-400 hover:bg-slate-100 p-2 rounded-lg transition"><X/></button>
                        </div>
                        <div className="space-y-5">
                            <div className="grid md:grid-cols-2 gap-4">
                                <Input label="Ragione Sociale / Cliente" value={editingClient.company || ''} onChange={v => setEditingClient({...editingClient, company: v})} placeholder="Es. Mario Rossi SRL" />
                                <Input label="Referente" value={editingClient.name || ''} onChange={v => setEditingClient({...editingClient, name: v})} placeholder="Nome Referente" />
                            </div>
                            <div className="grid md:grid-cols-2 gap-4">
                                <Input label="Telefono" value={editingClient.phone || ''} onChange={v => setEditingClient({...editingClient, phone: v})} placeholder="333..." />
                                <Input label="Email" value={editingClient.email || ''} onChange={v => setEditingClient({...editingClient, email: v})} placeholder="email@dominio.it" />
                            </div>
                            <div className="grid md:grid-cols-2 gap-4">
                                <Input label="Indirizzo Impianto / Sede" value={editingClient.address || ''} onChange={v => setEditingClient({...editingClient, address: v})} placeholder="Via Roma 1..." />
                                <Input label="CittÃ " value={editingClient.city || ''} onChange={v => setEditingClient({...editingClient, city: v})} placeholder="Es. Torino" />
                            </div>
                            <div className="grid md:grid-cols-2 gap-4">
                                <Input label="P.IVA / C.F." value={editingClient.vatNumber || ''} onChange={v => setEditingClient({...editingClient, vatNumber: v})} placeholder="IT..." />
                                <Select label="Tipo Cliente" value={editingClient.type || ''} onChange={v => setEditingClient({...editingClient, type: v})} options={['Azienda', 'Residenziale', 'ASD']} />
                            </div>
                            
                            <div className="pt-4 mt-2 border-t border-slate-100">
                                <p className="text-xs font-bold text-blue-600 uppercase tracking-wide mb-4 flex items-center gap-2"><MapPin size={14}/> Documenti & Cloud</p>
                                <div className="space-y-4">
                                    <Input label="Cartella Google Drive" value={editingClient.linkDrive || ''} onChange={v => setEditingClient({...editingClient, linkDrive: v})} placeholder="Incolla il link della cartella Drive..." isLink={true} />
                                    <Input label="Link Google Earth / Maps" value={editingClient.linkGoogleEarth || ''} onChange={v => setEditingClient({...editingClient, linkGoogleEarth: v})} placeholder="Incolla il link di Google Earth..." isLink={true} />
                                </div>
                            </div>

                            <div className="flex justify-end gap-3 mt-8 pt-4 border-t border-slate-100">
                                <button onClick={() => setEditingClient(null)} className="px-5 py-2.5 text-slate-600 font-medium hover:bg-slate-100 rounded-lg transition">Annulla</button>
                                <button onClick={handleSaveClient} disabled={isSaving} className="flex items-center gap-2 bg-blue-600 text-white px-6 py-2.5 rounded-lg font-bold hover:bg-blue-700 transition shadow-md disabled:opacity-50">
                                    {isSaving ? <Loader2 size={18} className="animate-spin"/> : <Save size={18}/>}
                                    Salva Modifiche
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            )}
        </div>
    );
}

// --- MODULO: SIMULAZIONI VELOCI ---
function QuickSimulationsModule() {
    // Stato Fotovoltaico
    const [pvInputType, setPvInputType] = useState('kw'); // 'kw' o 'mq'
    const [pvValue, setPvValue] = useState('');
    const [pvSurface, setPvSurface] = useState('inclinata'); // 'inclinata' o 'piana'
    
    // Stato PDC
    const [pdcMq, setPdcMq] = useState('');
    const [pdcInsulation, setPdcInsulation] = useState('medio'); // ottimo, medio, scarso
    const [pdcPeople, setPdcPeople] = useState('');

    // Stato Batterie
    const [batCons, setBatCons] = useState('');
    const [batProd, setBatProd] = useState('');
    const [batStrategy, setBatStrategy] = useState('autoconsumo'); // autoconsumo, backup
    const [batBackupLoad, setBatBackupLoad] = useState('');
    const [batBackupHours, setBatBackupHours] = useState('');

    // Calcoli Fotovoltaico
    const calculatePV = () => {
        const val = parseFloat(pvValue) || 0;
        if (val === 0) return { result: 0, label: '-' };
        const kInclined = 5.5; 
        const kFlat = 9.0;
        const k = pvSurface === 'inclinata' ? kInclined : kFlat;
        if (pvInputType === 'kw') {
            return { result: (val * k).toFixed(1), label: 'mq necessari' };
        } else {
            return { result: (val / k).toFixed(1), label: 'kWp installabili' };
        }
    };

    // Calcoli PDC
    const calculatePDC = () => {
        const mq = parseFloat(pdcMq) || 0;
        const people = parseInt(pdcPeople) || 0;
        if (mq === 0) return { power: 0, tank: 0 };
        let wPerMq = 75; // Medio
        if (pdcInsulation === 'ottimo') wPerMq = 35;
        if (pdcInsulation === 'scarso') wPerMq = 110;
        const powerKw = (mq * wPerMq) / 1000;
        const tankSize = people * 50; 
        return { power: powerKw.toFixed(1), tank: tankSize };
    };

    // Calcoli Batteria
    const calculateBattery = () => {
        if (batStrategy === 'autoconsumo') {
            const cons = parseFloat(batCons) || 0;
            const prod = parseFloat(batProd) || 0;
            if (cons === 0) return { cap: 0, msg: 'Inserisci consumo' };
            const nightNeed = cons * 0.5;
            const availableSolar = prod * 0.7; 
            const capacity = Math.min(nightNeed, availableSolar);
            return { cap: capacity.toFixed(1), msg: 'kWh per coprire la sera/notte' };
        } else {
            const load = parseFloat(batBackupLoad) || 0;
            const hours = parseFloat(batBackupHours) || 0;
            if (load === 0 || hours === 0) return { cap: 0, msg: 'Inserisci carico e ore' };
            return { cap: (load * hours).toFixed(1), msg: `kWh per ${hours}h di autonomia` };
        }
    };

    const pvRes = calculatePV();
    const pdcRes = calculatePDC();
    const batRes = calculateBattery();

    return (
        <div className="max-w-5xl mx-auto space-y-8">
            <div className="flex flex-col md:flex-row gap-4 justify-between items-start md:items-center">
                <div>
                    <h2 className="text-2xl font-bold text-slate-800 flex items-center gap-2"><Calculator className="text-blue-600" size={28} /> Simulazioni Veloci</h2>
                    <p className="text-slate-500">Strumenti rapidi per dimensionamento in tempo reale.</p>
                </div>
            </div>

            <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
                
                {/* CALCOLATORE FOTOVOLTAICO */}
                <div className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                    <div className="bg-orange-50 p-4 border-b border-orange-100 flex items-center gap-2">
                        <Sun className="text-orange-500" />
                        <h3 className="font-bold text-slate-800">Dimensionamento Fotovoltaico</h3>
                    </div>
                    <div className="p-6 space-y-6">
                        <div className="flex bg-slate-100 p-1 rounded-lg">
                            <button onClick={() => setPvInputType('kw')} className={`flex-1 py-2 rounded-md text-sm font-bold transition ${pvInputType === 'kw' ? 'bg-white text-orange-600 shadow-sm' : 'text-slate-500 hover:text-slate-700'}`}>Ho i kW, cerco i Mq</button>
                            <button onClick={() => setPvInputType('mq')} className={`flex-1 py-2 rounded-md text-sm font-bold transition ${pvInputType === 'mq' ? 'bg-white text-orange-600 shadow-sm' : 'text-slate-500 hover:text-slate-700'}`}>Ho i Mq, cerco i kW</button>
                        </div>
                        <div className="grid grid-cols-2 gap-4">
                            <div>
                                <label className="block text-xs font-bold text-slate-500 uppercase mb-2">Superficie</label>
                                <div className="flex flex-col gap-2">
                                    <label className={`flex items-center gap-2 p-3 rounded-lg border cursor-pointer transition ${pvSurface === 'inclinata' ? 'bg-orange-50 border-orange-300 text-orange-800' : 'border-slate-200 hover:bg-slate-50'}`}>
                                        <input type="radio" name="surf" className="hidden" checked={pvSurface === 'inclinata'} onChange={() => setPvSurface('inclinata')} />
                                        <div className="w-4 h-4 rounded-full border border-current flex items-center justify-center">{pvSurface === 'inclinata' && <div className="w-2 h-2 bg-current rounded-full"/>}</div>
                                        <span className="font-bold text-sm">Inclinata (30-35Â°)</span>
                                    </label>
                                    <label className={`flex items-center gap-2 p-3 rounded-lg border cursor-pointer transition ${pvSurface === 'piana' ? 'bg-orange-50 border-orange-300 text-orange-800' : 'border-slate-200 hover:bg-slate-50'}`}>
                                        <input type="radio" name="surf" className="hidden" checked={pvSurface === 'piana'} onChange={() => setPvSurface('piana')} />
                                        <div className="w-4 h-4 rounded-full border border-current flex items-center justify-center">{pvSurface === 'piana' && <div className="w-2 h-2 bg-current rounded-full"/>}</div>
                                        <span className="font-bold text-sm">Piana (Lastrico)</span>
                                    </label>
                                </div>
                            </div>
                            <div>
                                <label className="block text-xs font-bold text-slate-500 uppercase mb-2">{pvInputType === 'kw' ? 'Potenza Desiderata (kW)' : 'Spazio Disponibile (mq)'}</label>
                                <input type="number" value={pvValue} onChange={(e) => setPvValue(e.target.value)} className="w-full p-3 border border-slate-300 rounded-lg text-lg font-bold text-slate-800 focus:ring-2 focus:ring-orange-500 outline-none" placeholder="0" />
                            </div>
                        </div>
                        <div className="bg-orange-600 text-white p-6 rounded-xl text-center shadow-lg transform transition hover:scale-[1.02]">
                            <p className="text-orange-100 text-sm uppercase font-bold mb-1">Risultato Stima</p>
                            <div className="text-4xl font-extrabold">{pvRes.result} <span className="text-xl">{pvInputType === 'kw' ? 'mq' : 'kWp'}</span></div>
                            <p className="text-xs opacity-80 mt-2">{pvInputType === 'kw' ? `Spazio stimato per ${pvValue || 0} kW` : `Potenza stimata su ${pvValue || 0} mq`}</p>
                        </div>
                    </div>
                </div>

                {/* CALCOLATORE BATTERIE */}
                <div className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                    <div className="bg-green-50 p-4 border-b border-green-100 flex items-center gap-2">
                        <Battery className="text-green-600" />
                        <h3 className="font-bold text-slate-800">Dimensionamento Batterie</h3>
                    </div>
                    
                    <div className="p-4 bg-green-50/30 text-xs text-slate-600 border-b border-green-50 leading-relaxed">
                        <p className="font-bold mb-1">ðŸ’¡ Guida Rapida:</p>
                        <ul className="list-disc pl-4 space-y-1">
                            <li>Parti sempre dai <strong>kWh</strong>, non dai kW.</li>
                            <li>Definisci l'obiettivo: <strong>Autoconsumo</strong> o <strong>Backup</strong>.</li>
                            <li>Tetto piano o inclinato non cambia la capacitÃ  in kWh, ma solo la produzione FV disponibile.</li>
                        </ul>
                    </div>

                    <div className="p-6 space-y-6">
                        <div>
                            <label className="block text-xs font-bold text-slate-500 uppercase mb-2">Strategia</label>
                            <div className="flex bg-slate-100 p-1 rounded-lg">
                                <button onClick={() => setBatStrategy('autoconsumo')} className={`flex-1 py-2 rounded-md text-sm font-bold transition ${batStrategy === 'autoconsumo' ? 'bg-white text-green-600 shadow-sm' : 'text-slate-500 hover:text-slate-700'}`}>Autoconsumo</button>
                                <button onClick={() => setBatStrategy('backup')} className={`flex-1 py-2 rounded-md text-sm font-bold transition ${batStrategy === 'backup' ? 'bg-white text-green-600 shadow-sm' : 'text-slate-500 hover:text-slate-700'}`}>Backup / Blackout</button>
                            </div>
                        </div>

                        {batStrategy === 'autoconsumo' ? (
                            <div className="grid grid-cols-2 gap-4">
                                <div>
                                    <label className="block text-xs font-bold text-slate-500 uppercase mb-2">Consumo Medio (kWh/gg)</label>
                                    <input type="number" value={batCons} onChange={(e) => setBatCons(e.target.value)} className="w-full p-3 border border-slate-300 rounded-lg text-slate-800 focus:ring-2 focus:ring-green-500 outline-none" placeholder="Es. 15" />
                                </div>
                                <div>
                                    <label className="block text-xs font-bold text-slate-500 uppercase mb-2">Prod. FV Stimata (kWh/gg)</label>
                                    <input type="number" value={batProd} onChange={(e) => setBatProd(e.target.value)} className="w-full p-3 border border-slate-300 rounded-lg text-slate-800 focus:ring-2 focus:ring-green-500 outline-none" placeholder="Es. 20" />
                                </div>
                            </div>
                        ) : (
                            <div className="grid grid-cols-2 gap-4">
                                <div>
                                    <label className="block text-xs font-bold text-slate-500 uppercase mb-2">Carico Critico (kW)</label>
                                    <input type="number" value={batBackupLoad} onChange={(e) => setBatBackupLoad(e.target.value)} className="w-full p-3 border border-slate-300 rounded-lg text-slate-800 focus:ring-2 focus:ring-green-500 outline-none" placeholder="Es. 3 kW" />
                                </div>
                                <div>
                                    <label className="block text-xs font-bold text-slate-500 uppercase mb-2">Ore Autonomia (h)</label>
                                    <input type="number" value={batBackupHours} onChange={(e) => setBatBackupHours(e.target.value)} className="w-full p-3 border border-slate-300 rounded-lg text-slate-800 focus:ring-2 focus:ring-green-500 outline-none" placeholder="Es. 4 h" />
                                </div>
                            </div>
                        )}

                        <div className="bg-green-600 text-white p-6 rounded-xl text-center shadow-lg transform transition hover:scale-[1.02]">
                            <p className="text-green-100 text-sm uppercase font-bold mb-1">CapacitÃ  Consigliata</p>
                            <div className="text-4xl font-extrabold">{batRes.cap} <span className="text-xl">kWh</span></div>
                            <p className="text-xs opacity-80 mt-2">{batRes.msg}</p>
                        </div>
                    </div>
                </div>

                {/* CALCOLATORE PDC */}
                <div className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden lg:col-span-2">
                    <div className="bg-blue-50 p-4 border-b border-blue-100 flex items-center gap-2">
                        <Thermometer className="text-blue-500" />
                        <h3 className="font-bold text-slate-800">Dimensionamento Pompa di Calore</h3>
                    </div>
                    <div className="p-6 space-y-6">
                        <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <div className="col-span-1">
                                <label className="block text-xs font-bold text-slate-500 uppercase mb-2">Mq</label>
                                <input type="number" value={pdcMq} onChange={(e) => setPdcMq(e.target.value)} className="w-full p-3 border border-slate-300 rounded-lg text-lg font-bold text-slate-800 focus:ring-2 focus:ring-blue-500 outline-none" placeholder="120" />
                            </div>
                            <div className="col-span-1">
                                <label className="block text-xs font-bold text-slate-500 uppercase mb-2">Persone</label>
                                <input type="number" value={pdcPeople} onChange={(e) => setPdcPeople(e.target.value)} className="w-full p-3 border border-slate-300 rounded-lg text-lg font-bold text-slate-800 focus:ring-2 focus:ring-blue-500 outline-none" placeholder="4" />
                            </div>
                            <div className="col-span-2">
                                <label className="block text-xs font-bold text-slate-500 uppercase mb-2">Isolamento</label>
                                <div className="grid grid-cols-3 gap-2">
                                    <button onClick={() => setPdcInsulation('ottimo')} className={`p-2 rounded-lg border text-xs font-bold transition ${pdcInsulation === 'ottimo' ? 'bg-green-100 border-green-300 text-green-800' : 'border-slate-200 hover:bg-slate-50 text-slate-600'}`}>Ottimo (A)</button>
                                    <button onClick={() => setPdcInsulation('medio')} className={`p-2 rounded-lg border text-xs font-bold transition ${pdcInsulation === 'medio' ? 'bg-yellow-100 border-yellow-300 text-yellow-800' : 'border-slate-200 hover:bg-slate-50 text-slate-600'}`}>Medio</button>
                                    <button onClick={() => setPdcInsulation('scarso')} className={`p-2 rounded-lg border text-xs font-bold transition ${pdcInsulation === 'scarso' ? 'bg-red-100 border-red-300 text-red-800' : 'border-slate-200 hover:bg-slate-50 text-slate-600'}`}>Scarso (G)</button>
                                </div>
                            </div>
                        </div>

                        <div className="grid grid-cols-2 gap-4">
                            <div className="bg-blue-600 text-white p-4 rounded-xl text-center shadow-md">
                                <p className="text-blue-100 text-[10px] uppercase font-bold mb-1">Potenza Termica</p>
                                <div className="text-2xl font-extrabold">{pdcRes.power} <span className="text-lg">kW</span></div>
                            </div>
                            <div className="bg-cyan-600 text-white p-4 rounded-xl text-center shadow-md">
                                <p className="text-cyan-100 text-[10px] uppercase font-bold mb-1">Accumulo ACS</p>
                                <div className="text-2xl font-extrabold">{pdcRes.tank} <span className="text-lg">L</span></div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    );
}

// --- MODULO: QUICK NOTES MANAGER (FULL PAGE) ---
function QuickNotesManager({ user, appId }) {
    const [notes, setNotes] = useState([]);
    const [newNote, setNewNote] = useState('');
    const [isAdding, setIsAdding] = useState(false);
    const [editingId, setEditingId] = useState(null);
    const [loading, setLoading] = useState(true);

    useEffect(() => {
        if (!user) return;
        const q = query(collection(db, 'artifacts', appId, 'users', user.uid, 'quicknotes'));
        const unsubscribe = onSnapshot(q, (snapshot) => {
            const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            data.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
            setNotes(data);
            setLoading(false);
        });
        return () => unsubscribe();
    }, [user]);

    const handleSaveNote = async (e) => {
        e.preventDefault();
        if (!newNote.trim()) return;
        setIsAdding(true);
        try {
            if (editingId) {
                await updateDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'quicknotes', editingId), {
                    text: newNote,
                    updatedAt: new Date().toISOString()
                });
                setEditingId(null);
            } else {
                await addDoc(collection(db, 'artifacts', appId, 'users', user.uid, 'quicknotes'), {
                    text: newNote,
                    createdAt: new Date().toISOString()
                });
            }
            setNewNote('');
        } catch (error) { console.error("Errore nota", error); } finally { setIsAdding(false); }
    };

    const startEdit = (note) => { setNewNote(note.text); setEditingId(note.id); window.scrollTo({ top: 0, behavior: 'smooth' }); };
    const handleDeleteNote = async (id) => { if (editingId === id) { setEditingId(null); setNewNote(''); } await deleteDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'quicknotes', id)); };

    if (loading) return <div className="text-center p-10 text-slate-500">Caricamento Appunti...</div>;

    return (
        <div className="max-w-5xl mx-auto space-y-6">
            <div className="bg-white p-8 rounded-xl shadow-sm border border-slate-200">
                <div className="mb-8 flex items-center justify-between">
                    <div>
                        <h2 className="text-2xl font-bold text-slate-800 flex items-center gap-2"><StickyNote className="text-yellow-500" size={24} /> Appunti Rapidi</h2>
                        <p className="text-slate-500 mt-1">Spazio libero per note veloci, idee e appunti da sopralluogo.</p>
                    </div>
                </div>

                <form onSubmit={handleSaveNote} className="mb-8 relative bg-yellow-50/50 p-6 rounded-xl border border-yellow-200">
                    <label className="block text-xs font-bold text-yellow-700 uppercase mb-2">{editingId ? 'Modifica Appunto' : 'Nuovo Appunto'}</label>
                    <textarea 
                        value={newNote}
                        onChange={(e) => setNewNote(e.target.value)}
                        onKeyDown={(e) => { if(e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); handleSaveNote(e); } }}
                        placeholder="Scrivi qui..."
                        className="w-full bg-white border border-yellow-300 rounded-lg p-4 text-base focus:outline-none focus:ring-2 focus:ring-yellow-400 placeholder:text-slate-400 resize-none min-h-[120px] shadow-sm"
                    />
                    <div className="flex justify-end gap-2 mt-3">
                        {editingId && (
                            <button type="button" onClick={() => { setEditingId(null); setNewNote(''); }} className="bg-white hover:bg-slate-50 text-slate-600 px-4 py-2 rounded-lg font-medium transition shadow-sm border border-slate-200 flex items-center gap-2">
                                <X size={18} /> Annulla
                            </button>
                        )}
                        <button type="submit" disabled={isAdding || !newNote.trim()} className="bg-yellow-500 hover:bg-yellow-600 text-white px-6 py-2 rounded-lg font-bold transition shadow-md disabled:opacity-50 flex items-center gap-2">
                            {isAdding ? <Loader2 size={18} className="animate-spin"/> : (editingId ? <><Save size={18}/> Salva Modifiche</> : <><Plus size={18}/> Aggiungi Nota</>)}
                        </button>
                    </div>
                </form>

                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    {notes.length === 0 && <div className="col-span-full text-center py-12 text-slate-400 border-2 border-dashed border-slate-100 rounded-xl">Nessun appunto presente.</div>}
                    {notes.map(note => (
                        <div key={note.id} className={`group flex flex-col justify-between p-5 bg-white rounded-xl border shadow-sm hover:shadow-md transition relative ${editingId === note.id ? 'border-blue-400 ring-2 ring-blue-50' : 'border-slate-200'}`}>
                            <div>
                                <p className="text-slate-800 whitespace-pre-wrap leading-relaxed text-sm mb-4">{note.text}</p>
                            </div>
                            <div className="flex items-center justify-between pt-4 border-t border-slate-50 mt-auto">
                                <span className="text-xs font-medium text-slate-400 bg-slate-50 px-2 py-1 rounded">
                                    {new Date(note.createdAt).toLocaleDateString()} {new Date(note.createdAt).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}
                                </span>
                                <div className="flex gap-1">
                                    <button onClick={() => startEdit(note)} className="p-2 text-slate-400 hover:text-blue-600 hover:bg-blue-50 rounded-lg transition" title="Modifica"><Edit size={16} /></button>
                                    <button onClick={() => handleDeleteNote(note.id)} className="p-2 text-slate-400 hover:text-red-600 hover:bg-red-50 rounded-lg transition" title="Elimina"><Trash2 size={16} /></button>
                                </div>
                            </div>
                        </div>
                    ))}
                </div>
            </div>
        </div>
    );
}

// --- WIDGET: APPUNTI RAPIDI (DASHBOARD) ---
function QuickNotesWidget({ user, appId }) {
    const [notes, setNotes] = useState([]);
    const [newNote, setNewNote] = useState('');
    const [isAdding, setIsAdding] = useState(false);
    const [editingId, setEditingId] = useState(null);

    useEffect(() => {
        if (!user) return;
        const q = query(collection(db, 'artifacts', appId, 'users', user.uid, 'quicknotes'));
        const unsubscribe = onSnapshot(q, (snapshot) => {
            const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            data.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
            setNotes(data);
        });
        return () => unsubscribe();
    }, [user]);

    const handleSaveNote = async (e) => {
        e.preventDefault();
        if (!newNote.trim()) return;
        setIsAdding(true);
        try {
            if (editingId) {
                await updateDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'quicknotes', editingId), {
                    text: newNote,
                    updatedAt: new Date().toISOString()
                });
                setEditingId(null);
            } else {
                await addDoc(collection(db, 'artifacts', appId, 'users', user.uid, 'quicknotes'), {
                    text: newNote,
                    createdAt: new Date().toISOString()
                });
            }
            setNewNote('');
        } catch (error) { console.error("Errore nota", error); } finally { setIsAdding(false); }
    };

    const startEdit = (note) => { setNewNote(note.text); setEditingId(note.id); };
    const handleDeleteNote = async (id) => { if (editingId === id) { setEditingId(null); setNewNote(''); } await deleteDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'quicknotes', id)); };

    return (
        <div className="bg-white rounded-xl shadow-sm border border-slate-200 p-6 h-full flex flex-col">
             <div className="flex justify-between items-center mb-6">
                 <h3 className="font-bold text-lg text-slate-800">Appunti Rapidi</h3>
             </div>

             <form onSubmit={handleSaveNote} className="mb-6 relative">
                 <div className="relative">
                    <textarea 
                        value={newNote}
                        onChange={(e) => setNewNote(e.target.value)}
                        onKeyDown={(e) => { if(e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); handleSaveNote(e); } }}
                        placeholder={editingId ? "Modifica appunto..." : "Scrivi nota veloce..."}
                        className={`w-full bg-slate-50 border rounded-lg p-3 text-sm focus:outline-none focus:ring-2 focus:ring-yellow-400/50 resize-none min-h-[80px] transition text-slate-700 ${editingId ? 'border-blue-300 ring-blue-100' : 'border-slate-200'}`}
                    />
                    <div className="absolute bottom-2 right-2 flex gap-1">
                        {editingId && (
                            <button type="button" onClick={() => { setEditingId(null); setNewNote(''); }} className="bg-white hover:bg-slate-100 text-slate-500 p-1.5 rounded-md transition shadow-sm border border-slate-200"><X size={14} /></button>
                        )}
                        <button type="submit" disabled={isAdding || !newNote.trim()} className={`p-1.5 rounded-md transition shadow-sm disabled:opacity-50 flex items-center justify-center ${editingId ? 'bg-blue-600 hover:bg-blue-700 text-white' : 'bg-yellow-400 hover:bg-yellow-500 text-yellow-900'}`}>
                            {isAdding ? <Loader2 size={14} className="animate-spin"/> : (editingId ? <Save size={14} /> : <Plus size={14} />)}
                        </button>
                    </div>
                 </div>
             </form>

             <div className="flex-1 overflow-y-auto space-y-3 custom-scrollbar">
                 {notes.length === 0 && <p className="text-sm text-slate-400 text-center italic mt-4">Nessun appunto recente.</p>}
                 {notes.map(note => (
                     <div key={note.id} className="flex items-center justify-between p-4 bg-slate-50 rounded-lg group hover:bg-slate-100 transition">
                         <div className="flex items-start gap-4 flex-1 min-w-0">
                             <div className="p-2 rounded-md bg-yellow-100 text-yellow-600 flex-shrink-0 mt-0.5">
                                 <StickyNote size={20} />
                             </div>
                             <div className="min-w-0 flex-1">
                                 <p className="font-bold text-slate-800 text-sm break-words leading-snug">{note.text}</p>
                                 <p className="text-xs text-slate-400 mt-1">{new Date(note.createdAt).toLocaleDateString()} â€¢ {new Date(note.createdAt).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</p>
                             </div>
                         </div>
                         <div className="flex items-center gap-2 ml-3">
                             <div className="opacity-0 group-hover:opacity-100 flex gap-1 transition">
                                 <button onClick={() => startEdit(note)} className="p-1.5 text-slate-400 hover:text-blue-600 hover:bg-blue-50 rounded transition"><Edit size={16} /></button>
                                 <button onClick={() => handleDeleteNote(note.id)} className="p-1.5 text-slate-400 hover:text-red-600 hover:bg-red-50 rounded transition"><Trash2 size={16} /></button>
                             </div>
                             <span className="text-xs font-bold text-slate-400 bg-white px-2 py-1 rounded border border-slate-200 whitespace-nowrap hidden sm:block">
                                {new Date(note.createdAt).toLocaleDateString()} {new Date(note.createdAt).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}
                             </span>
                         </div>
                     </div>
                 ))}
             </div>
        </div>
    );
}

// --- MODULO: DASHBOARD OVERVIEW ---
function DashboardOverview({ user, appId, navigateToModule }) {
    const [stats, setStats] = useState({ audits: 0, pipeline: 0, reminders: 0, quickNotes: 0, recentAudits: [], recentReminders: [], nextEvents: [] });
    const [loading, setLoading] = useState(true);

    useEffect(() => {
        if (!user) return;

        // FETCH AUDITS (NO ORDERBY)
        const unsubAudits = onSnapshot(collection(db, 'artifacts', appId, 'users', user.uid, 'audits'), (snap) => {
            const auditData = snap.docs.map(d => ({...d.data(), id: d.id, type: 'audit'}));
            auditData.sort((a, b) => {
                const dateA = a.dataRilievo || '1970-01-01';
                const dateB = b.dataRilievo || '1970-01-01';
                return new Date(dateB) - new Date(dateA);
            });
            
            setStats(prev => ({ ...prev, audits: snap.size, recentAudits: auditData.slice(0, 3) }));
            updateNextEvents(auditData, null); 
        });

        // FETCH OPPORTUNITIES
        const unsubOpps = onSnapshot(collection(db, 'artifacts', appId, 'users', user.uid, 'leads'), (snap) => {
            setStats(prev => ({ ...prev, pipeline: snap.size }));
        });

        // FETCH REMINDERS
        const unsubReminders = onSnapshot(collection(db, 'artifacts', appId, 'users', user.uid, 'reminders'), (snap) => {
            const allReminders = snap.docs.map(d => ({id: d.id, ...d.data()}));
            const activeReminders = allReminders
                .filter(r => !r.completed)
                .sort((a, b) => (a.dueDate || '9999-99-99').localeCompare(b.dueDate || '9999-99-99'));
            setStats(prev => ({ ...prev, reminders: activeReminders.length, recentReminders: activeReminders.slice(0, 5) }));
        });

        // FETCH QUICK NOTES
        const unsubNotes = onSnapshot(collection(db, 'artifacts', appId, 'users', user.uid, 'quicknotes'), (snap) => {
            setStats(prev => ({ ...prev, quickNotes: snap.size }));
        });

        // FETCH APPOINTMENTS
        const unsubAppts = onSnapshot(collection(db, 'artifacts', appId, 'users', user.uid, 'appointments'), (snap) => {
            const apptData = snap.docs.map(d => ({...d.data(), id: d.id, type: 'appuntamento'}));
            updateNextEvents(null, apptData);
        });

        let cachedAudits = [];
        let cachedAppts = [];
        
        const updateNextEvents = (newAudits, newAppts) => {
            if (newAudits) cachedAudits = newAudits;
            if (newAppts) cachedAppts = newAppts;

            const today = new Date().toISOString().split('T')[0];
            
            // Logica Aggiornata: Mappa sia Rilievi che Incontri
            const auditEvents = cachedAudits.flatMap(a => {
                const events = [];
                // 1. Evento Rilievo (Verde)
                if (a.dataRilievo) {
                    events.push({ 
                        id: `${a.id}_rilievo`, 
                        title: `ðŸ” Rilievo: ${a.nomeSocieta || 'Senza Nome'}`, 
                        date: a.dataRilievo, 
                        time: '09:00', 
                        type: 'audit', 
                        color: 'bg-green-50 text-green-700' 
                    });
                }
                // 2. Evento Prossimo Incontro (Viola)
                if (a.prossimoIncontro) {
                    events.push({ 
                        id: `${a.id}_incontro`, 
                        title: `ðŸ¤ Incontro: ${a.nomeSocieta || 'Senza Nome'}`, 
                        date: a.prossimoIncontro, 
                        time: '09:00', 
                        type: 'meeting', 
                        color: 'bg-purple-50 text-purple-700' 
                    });
                }
                return events;
            });

            const allEvents = [
                ...auditEvents,
                ...(cachedAppts || []).map(a => ({ 
                    id: a.id, 
                    title: `ðŸ“… ${a.title || 'Appuntamento'}`, 
                    date: a.date || today, 
                    time: a.time || '09:00', 
                    type: 'appt', 
                    color: 'bg-blue-50 text-blue-700' 
                }))
            ];

            const upcoming = allEvents
                .filter(e => e.date >= today)
                .sort((a, b) => {
                    if (a.date !== b.date) return a.date.localeCompare(b.date);
                    return (a.time || '00:00').localeCompare(b.time || '00:00');
                })
                .slice(0, 5); 

            setStats(prev => ({ ...prev, nextEvents: upcoming }));
            setLoading(false);
        };
        return () => { unsubAudits(); unsubOpps(); unsubReminders(); unsubNotes(); unsubAppts(); };
    }, [user]);

    const toggleReminder = async (id, currentStatus) => { await updateDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'reminders', id), { completed: !currentStatus }); };
    const deleteReminder = async (id) => { await deleteDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'reminders', id)); };
    const getPriorityStyle = (priority) => { switch(priority) { case 'red': return 'bg-red-50 border-red-100 text-red-700'; case 'green': return 'bg-green-50 border-green-100 text-green-700'; default: return 'bg-blue-50 border-blue-100 text-blue-700'; } };

    if (loading) return <div className="p-8 text-center text-slate-500">Caricamento KPI...</div>;

    return (
        <div className="space-y-8">
            <div className="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                <div><h1 className="text-2xl md:text-3xl font-bold text-slate-800">Bentornato, Giulio! ðŸ‘‹</h1><p className="text-slate-500">Ecco il polso della situazione.</p></div>
                <div className="flex gap-2">
                    <button onClick={() => navigateToModule('audits-new')} className="bg-blue-600 text-white px-4 py-2 rounded-lg font-bold shadow-md hover:bg-blue-700 flex items-center gap-2"><Plus size={18} /> Nuovo Audit</button>
                </div>
            </div>
            
            {/* KPI CARDS - TOP ROW */}
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-200 flex items-center justify-between group hover:border-blue-300 transition cursor-pointer" onClick={() => navigateToModule('pipeline')}><div><p className="text-sm font-bold text-slate-500 uppercase tracking-wide">Lead in Pipeline</p><p className="text-2xl font-bold text-slate-800 mt-1">{stats.pipeline}</p></div><div className="bg-blue-50 p-3 rounded-lg text-blue-600 group-hover:bg-blue-100 transition"><TrendingUp size={24} /></div></div>
                <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-200 flex items-center justify-between group hover:border-green-300 transition cursor-pointer" onClick={() => navigateToModule('audits')}><div><p className="text-sm font-bold text-slate-500 uppercase tracking-wide">Audit Totali</p><p className="text-2xl font-bold text-slate-800 mt-1">{stats.audits}</p></div><div className="bg-green-50 p-3 rounded-lg text-green-600 group-hover:bg-green-100 transition"><LayoutGrid size={24} /></div></div>
                <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-200 flex items-center justify-between group hover:border-orange-300 transition cursor-pointer" onClick={() => navigateToModule('reminders')}><div><p className="text-sm font-bold text-slate-500 uppercase tracking-wide">Task Aperti</p><p className="text-2xl font-bold text-slate-800 mt-1">{stats.reminders}</p></div><div className="bg-orange-50 p-3 rounded-lg text-orange-600 group-hover:bg-orange-100 transition"><Bell size={24} /></div></div>
                <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-200 flex items-center justify-between group hover:border-yellow-300 transition cursor-pointer" onClick={() => navigateToModule('quicknotes')}><div><p className="text-sm font-bold text-slate-500 uppercase tracking-wide">Appunti</p><p className="text-2xl font-bold text-slate-800 mt-1">{stats.quickNotes}</p></div><div className="bg-yellow-50 p-3 rounded-lg text-yellow-600 group-hover:bg-yellow-100 transition"><StickyNote size={24} /></div></div>
            </div>

            <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <div className="lg:col-span-2 space-y-8">
                    
                    {/* SEZIONE AUDIT RECENTI */}
                    <div className="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                        <div className="flex justify-between items-center mb-6">
                            <h3 className="font-bold text-lg text-slate-800">Ultimi Sopralluoghi</h3>
                            <button onClick={() => navigateToModule('audits')} className="text-sm text-blue-600 font-bold hover:underline">Vedi tutti</button>
                        </div>
                        <div className="space-y-3">
                            {stats.recentAudits.length === 0 ? <p className="text-slate-400 text-sm">Nessun audit recente.</p> : stats.recentAudits.map((a, i) => (
                                <div key={i} className="flex items-center justify-between p-4 bg-slate-50 rounded-lg hover:bg-slate-100 transition cursor-pointer" onClick={() => navigateToModule('audits')}>
                                    <div className="flex items-center gap-4">
                                        <div className={`p-2 rounded-md flex-shrink-0 ${a.tipoCliente==='Azienda'?'bg-blue-100 text-blue-700':a.tipoCliente==='Residenziale'?'bg-green-100 text-green-700':'bg-orange-100 text-orange-700'}`}>
                                            {a.tipoCliente==='Azienda' ? <Factory size={20} /> : a.tipoCliente==='Residenziale' ? <Home size={20} /> : <Trophy size={20} />}
                                        </div>
                                        <div>
                                            <p className="font-bold text-slate-800 text-sm uppercase tracking-tight">{a.nomeSocieta || 'Nuovo Cliente'}</p>
                                            <p className="text-xs text-slate-500 uppercase">{a.indirizzo}</p>
                                        </div>
                                    </div>
                                    <span className="text-xs font-bold text-slate-400 bg-white px-3 py-1 rounded-md border border-slate-200 whitespace-nowrap">
                                        {a.dataRilievo}
                                    </span>
                                </div>
                            ))}
                        </div>
                    </div>

                    {/* WIDGET TASK PRIORITARI */}
                    <div className="bg-white rounded-xl shadow-sm border border-slate-200 p-6 flex flex-col h-full">
                        <div className="flex justify-between items-center mb-6">
                            <h3 className="font-bold text-lg text-slate-800 flex items-center gap-2"><Bell className="text-orange-500" size={20}/> Task Prioritari</h3>
                            <button onClick={() => navigateToModule('reminders')} className="text-sm text-blue-600 font-bold hover:underline">Gestisci</button>
                        </div>
                        <div className="space-y-2 flex-1 overflow-y-auto custom-scrollbar pr-1">
                            {stats.recentReminders.length === 0 ? <p className="text-slate-400 text-sm italic">Nessun task in sospeso.</p> : stats.recentReminders.map((rem) => (
                                <div key={rem.id} className={`flex items-start gap-3 p-3 rounded-lg border shadow-sm transition ${rem.completed ? 'bg-slate-50 opacity-60' : getPriorityStyle(rem.priority || 'blue')}`}>
                                    <button onClick={() => toggleReminder(rem.id, rem.completed)} className="mt-0.5 hover:opacity-70 transition">{rem.completed ? <CheckCircle2 size={20} className="text-slate-400" /> : <Circle size={20} />}</button>
                                    <div className="flex-1 min-w-0">
                                        <span className={`text-sm font-bold block truncate ${rem.completed ? 'text-slate-500 line-through' : ''}`}>{rem.text}</span>
                                        {rem.dueDate && <span className="text-xs text-slate-400 flex items-center gap-1 mt-1 opacity-80"><CalendarIcon size={10} /> {rem.dueDate} {rem.dueTime && ` alle ${rem.dueTime}`}</span>}
                                    </div>
                                    <div className="flex items-center gap-1">
                                        <button onClick={() => navigateToModule('reminders', { editId: rem.id })} className="p-1 text-slate-400 hover:text-blue-500 hover:bg-blue-50 rounded transition"><Edit size={16}/></button>
                                        <button onClick={() => deleteReminder(rem.id)} className="p-1 text-slate-400 hover:text-red-500 hover:bg-red-50 rounded transition"><X size={16} /></button>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>

                </div>
                <div className="space-y-8 flex flex-col h-full">
                    <div className="bg-white rounded-xl shadow-sm border border-slate-200 p-6 flex-1"><div className="flex justify-between items-center mb-4"><h3 className="font-bold text-lg text-slate-800 flex items-center gap-2"><CalendarIcon size={20} className="text-blue-600"/> Agenda</h3><button onClick={() => navigateToModule('calendar')} className="text-xs bg-slate-100 hover:bg-slate-200 px-2 py-1 rounded transition">Vedi</button></div><div className="space-y-3">{stats.nextEvents.length === 0 ? <p className="text-slate-400 text-sm">Nessun evento imminente.</p> : stats.nextEvents.map((ev, i) => (<div key={i} className={`p-3 rounded-lg border-l-4 ${ev.type === 'audit' ? 'border-green-500 bg-green-50/50' : ev.type === 'meeting' ? 'border-purple-500 bg-purple-50/50' : 'border-blue-500 bg-blue-50/50'}`}><p className="text-xs font-bold text-slate-500 mb-1">{ev.date.split('-').reverse().join('/')} â€¢ {ev.time}</p><p className="text-sm font-bold text-slate-800 leading-tight">{ev.title}</p></div>))}</div></div>
                </div>
            </div>
        </div>
    );
}

// --- MODULO: PIPELINE LEAD ---
function PipelineModule({ user, appId, navigateToModule }) {
    const [leads, setLeads] = useState([]);
    const [loading, setLoading] = useState(true);
    const [showModal, setShowModal] = useState(false);
    const [newLead, setNewLead] = useState({ company: '', name: '', phone: '', city: '', stage: 'Da Contattare', type: 'Azienda' });
    const [dialog, setDialog] = useState(null); // NUOVO STATO MODALE

    const stages = ['Da Contattare', 'In Contatto', 'Offerta Personalizzata in corso', 'In Chiusura'];
    const stageColors = {
        'Da Contattare': 'border-blue-500 bg-blue-50',
        'In Contatto': 'border-yellow-500 bg-yellow-50',
        'Offerta Personalizzata in corso': 'border-purple-500 bg-purple-50',
        'In Chiusura': 'border-green-500 bg-green-50'
    };

    useEffect(() => {
        if (!user) return;
        const unsubscribe = onSnapshot(collection(db, 'artifacts', appId, 'users', user.uid, 'leads'), (snapshot) => {
            const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            data.sort((a, b) => (b.createdAt || '').localeCompare(a.createdAt || ''));
            setLeads(data);
            setLoading(false);
        });
        return () => unsubscribe();
    }, [user]);

    const handleAddLead = async () => {
        if (!newLead.company) {
            setDialog({ title: "Attenzione", message: "Nome Azienda obbligatorio", type: 'alert', onConfirm: () => setDialog(null) });
            return;
        }
        await addDoc(collection(db, 'artifacts', appId, 'users', user.uid, 'leads'), {
            ...newLead, createdAt: new Date().toISOString()
        });
        setShowModal(false);
        setNewLead({ company: '', name: '', phone: '', city: '', stage: 'Da Contattare', type: 'Azienda' });
    };

    const moveLead = async (id, currentStage, direction) => {
        const currentIndex = stages.indexOf(currentStage);
        const nextIndex = direction === 'next' ? currentIndex + 1 : currentIndex - 1;
        if (nextIndex >= 0 && nextIndex < stages.length) {
            await updateDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'leads', id), { stage: stages[nextIndex] });
        }
    };

    // LOGICA DI CONVERSIONE IN CLIENTE
    const handleConvertToClient = async (lead) => {
        setDialog({
            title: "Converti in Cliente",
            message: `Convertire ${lead.company} in Cliente?\nIl lead verrÃ  rimosso dalla pipeline e inserito in anagrafica.`,
            type: 'confirm',
            onConfirm: async () => {
                setDialog(null);
                try {
                    const { id, ...leadData } = lead;
                    await addDoc(collection(db, 'artifacts', appId, 'users', user.uid, 'clients'), {
                        ...leadData,
                        convertedAt: new Date().toISOString(),
                        status: 'Attivo'
                    });
                    await deleteDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'leads', id));
                    
                    setDialog({
                        title: "Operazione Completata",
                        message: "âœ… Cliente inserito in anagrafica!\n\nVuoi visualizzare l'anagrafica clienti ora?",
                        type: 'confirm',
                        onConfirm: () => { setDialog(null); if(navigateToModule) navigateToModule('clients'); },
                        onCancel: () => setDialog(null)
                    });
                } catch (error) {
                    console.error("Errore conversione", error);
                    setDialog({ title: "Errore", message: "Si Ã¨ verificato un errore.", type: 'alert', onConfirm: () => setDialog(null) });
                }
            },
            onCancel: () => setDialog(null)
        });
    };

    const handleDelete = async (id) => {
        setDialog({
            title: "Elimina Lead",
            message: "Sei sicuro di voler eliminare questo Lead?",
            type: 'confirm',
            onConfirm: async () => {
                setDialog(null);
                await deleteDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'leads', id));
            },
            onCancel: () => setDialog(null)
        });
    };

    if (loading) return <div className="p-10 text-center"><Loader2 className="animate-spin mx-auto text-blue-500"/></div>;

    return (
        <div className="h-full flex flex-col relative">
            {/* --- RENDER MODALE CUSTOM PIPELINE --- */}
            {dialog && (
                <div className="fixed inset-0 bg-black/50 z-[100] flex items-center justify-center p-4">
                    <div className="bg-white rounded-xl p-6 max-w-sm w-full shadow-2xl animate-in fade-in zoom-in duration-200">
                        <h3 className="font-bold text-lg text-slate-800 mb-2">{dialog.title}</h3>
                        <p className="text-slate-600 mb-6 whitespace-pre-wrap">{dialog.message}</p>
                        <div className="flex justify-end gap-3">
                            {dialog.type === 'confirm' && (
                                <button onClick={dialog.onCancel} className="px-4 py-2 rounded-lg font-medium text-slate-600 hover:bg-slate-100 transition">Annulla</button>
                            )}
                            <button onClick={dialog.onConfirm} className="px-4 py-2 rounded-lg font-bold bg-blue-600 text-white hover:bg-blue-700 transition">OK</button>
                        </div>
                    </div>
                </div>
            )}
            
            <div className="flex justify-between items-center mb-6">
                <h2 className="text-2xl font-bold text-slate-800 flex items-center gap-2"><Kanban className="text-blue-600"/> Pipeline Lead</h2>
                <button onClick={() => setShowModal(true)} className="bg-red-600 text-white px-4 py-2 rounded-lg font-bold shadow hover:bg-red-700 flex items-center gap-2"><Plus size={18}/> Nuovo Lead</button>
            </div>

            <div className="flex-1 overflow-x-auto overflow-y-hidden pb-4">
                <div className="flex gap-4 h-full min-w-[1000px]">
                    {stages.map(stage => (
                        <div key={stage} className={`flex-1 flex flex-col min-w-[280px] rounded-xl border-t-4 bg-gray-50/50 ${stageColors[stage].split(' ')[0]}`}>
                            <div className="p-3 border-b border-gray-100 flex justify-between items-center bg-white rounded-t-lg">
                                <h3 className="font-bold text-slate-700">{stage}</h3>
                                <span className="bg-slate-100 text-slate-600 text-xs px-2 py-0.5 rounded-full font-bold">{leads.filter(l => l.stage === stage).length}</span>
                            </div>
                            <div className="p-2 flex-1 overflow-y-auto space-y-3">
                                {leads.filter(l => l.stage === stage).map(lead => (
                                    <div key={lead.id} className="bg-white p-4 rounded-lg shadow-sm border border-slate-200 hover:shadow-md transition relative group">
                                        <div className="flex justify-between items-start mb-2">
                                            <span className={`text-[10px] uppercase font-bold px-1.5 py-0.5 rounded ${lead.type === 'ASD' ? 'bg-yellow-100 text-yellow-700' : lead.type === 'Residenziale' ? 'bg-green-100 text-green-700' : 'bg-blue-100 text-blue-700'}`}>{lead.type}</span>
                                            <button onClick={() => handleDelete(lead.id)} className="text-slate-300 hover:text-red-500 opacity-0 group-hover:opacity-100 transition"><Trash2 size={14}/></button>
                                        </div>
                                        <h4 className="font-bold text-slate-800 leading-tight mb-1">{lead.company}</h4>
                                        <p className="text-xs text-slate-500 flex items-center gap-1 mb-1"><UserCircle size={12}/> {lead.name}</p>
                                        <div className="text-xs text-slate-600 space-y-1">
                                            <p className="flex items-center gap-1"><MapPin size={12}/> {lead.city}</p>
                                            <p className="flex items-center gap-1"><Phone size={12}/> {lead.phone}</p>
                                        </div>
                                        
                                        <div className="mt-3 pt-2 border-t border-slate-50 flex justify-between items-center">
                                            <button onClick={() => moveLead(lead.id, stage, 'prev')} disabled={stage === stages[0]} className="text-slate-400 hover:text-blue-600 disabled:opacity-30 p-1"><ArrowLeft size={16}/></button>
                                            
                                            {/* PULSANTE CONVERSIONE CLIENTE */}
                                            {stage === stages[stages.length - 1] ? (
                                                <button onClick={() => handleConvertToClient(lead)} className="flex items-center gap-1 text-[11px] font-bold text-green-700 bg-green-100 px-3 py-1.5 rounded-lg hover:bg-green-200 transition shadow-sm border border-green-300">
                                                    <UserCheck size={14}/> Diventa Cliente
                                                </button>
                                            ) : (
                                                <span className="text-[10px] text-slate-300 font-medium uppercase truncate px-2">{stage}</span>
                                            )}

                                            <button onClick={() => moveLead(lead.id, stage, 'next')} disabled={stage === stages[stages.length-1]} className="text-slate-400 hover:text-blue-600 disabled:opacity-30 p-1"><ArrowRight size={16}/></button>
                                        </div>
                                    </div>
                                ))}
                                {leads.filter(l => l.stage === stage).length === 0 && <div className="text-center py-10 text-slate-300 text-xs italic">Vuoto</div>}
                            </div>
                        </div>
                    ))}
                </div>
            </div>

            {showModal && (
                <div className="absolute inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
                    <div className="bg-white rounded-xl p-6 w-full max-w-md shadow-2xl">
                        <div className="flex justify-between mb-4"><h3 className="font-bold text-lg">Nuovo Lead</h3><button onClick={() => setShowModal(false)}><X/></button></div>
                        <div className="space-y-3">
                            <Input label="Ragione Sociale / Cliente" value={newLead.company} onChange={v => setNewLead({...newLead, company: v})} placeholder="Es. Mario Rossi SRL" />
                            <div className="grid grid-cols-2 gap-3">
                                <Input label="Referente" value={newLead.name} onChange={v => setNewLead({...newLead, name: v})} placeholder="Nome" />
                                <Input label="Telefono" value={newLead.phone} onChange={v => setNewLead({...newLead, phone: v})} placeholder="333..." />
                            </div>
                            <Input label="CittÃ " value={newLead.city} onChange={v => setNewLead({...newLead, city: v})} placeholder="Torino" />
                            <Select label="Tipo" value={newLead.type} onChange={v => setNewLead({...newLead, type: v})} options={['Azienda', 'Residenziale', 'ASD']} />
                            <button onClick={handleAddLead} className="w-full bg-red-600 text-white py-2 rounded-lg font-bold mt-4 hover:bg-red-700">Salva Lead</button>
                        </div>
                    </div>
                </div>
            )}
        </div>
    );
}

// --- MODULO: REMINDERS MANAGER ---
function RemindersManager({ user, appId, initialData }) {
  const [reminders, setReminders] = useState([]);
  const [editingId, setEditingId] = useState(null); 
  const [reminderForm, setReminderForm] = useState({ text: '', priority: 'blue', date: new Date().toISOString().split('T')[0], time: '' });
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    if (!user) return;
    const unsubReminders = onSnapshot(collection(db, 'artifacts', appId, 'users', user.uid, 'reminders'), (snap) => {
        const data = snap.docs.map(d => ({id: d.id, ...d.data()}));
        data.sort((a, b) => (a.dueDate || '9999-99-99').localeCompare(b.dueDate || '9999-99-99'));
        setReminders(data);
        setLoading(false);
    });
    return () => unsubReminders();
  }, [user]);

  // Gestione apertura edit da Dashboard (via props)
  useEffect(() => {
      if(initialData && initialData.editId && reminders.length > 0) {
          const rem = reminders.find(r => r.id === initialData.editId);
          if(rem) startEdit(rem);
      }
  }, [initialData, reminders]);

  const handleSave = async (e) => { 
    e.preventDefault(); 
    if (!reminderForm.text.trim()) return; 
    
    if (editingId) {
        // UPDATE
        await updateDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'reminders', editingId), { 
            text: reminderForm.text, 
            priority: reminderForm.priority, 
            dueDate: reminderForm.date, 
            dueTime: reminderForm.time 
        });
        setEditingId(null);
    } else {
        // ADD
        await addDoc(collection(db, 'artifacts', appId, 'users', user.uid, 'reminders'), { 
            text: reminderForm.text, 
            priority: reminderForm.priority, 
            dueDate: reminderForm.date, 
            dueTime: reminderForm.time, 
            completed: false, 
            createdAt: new Date().toISOString() 
        }); 
    }
    setReminderForm({ text: '', priority: 'blue', date: new Date().toISOString().split('T')[0], time: '' }); 
  };
  
  const startEdit = (rem) => {
      setEditingId(rem.id);
      setReminderForm({
          text: rem.text,
          priority: rem.priority || 'blue',
          date: rem.dueDate || '',
          time: rem.dueTime || ''
      });
      // Scroll to top form
      window.scrollTo({ top: 0, behavior: 'smooth' });
  };

  const cancelEdit = () => {
      setEditingId(null);
      setReminderForm({ text: '', priority: 'blue', date: new Date().toISOString().split('T')[0], time: '' });
  };
  
  const toggleReminder = async (id, currentStatus) => { await updateDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'reminders', id), { completed: !currentStatus }); };
  const deleteReminder = async (id) => { await deleteDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'reminders', id)); };
  const getPriorityStyle = (priority) => { switch(priority) { case 'red': return 'bg-red-50 border-red-200 text-red-700'; case 'green': return 'bg-green-50 border-green-200 text-green-700'; default: return 'bg-blue-50 border-blue-200 text-blue-700'; } };

  if (loading) return <div className="text-center p-10 text-slate-500">Caricamento Promemoria...</div>;

  return (
    <div className="max-w-4xl mx-auto space-y-6">
        <div className="bg-white p-8 rounded-xl shadow-sm border border-slate-200">
            <div className="mb-8"><h2 className="text-2xl font-bold text-slate-800 flex items-center gap-2"><Bell className="text-orange-500" size={24} /> Promemoria & AttivitÃ </h2><p className="text-slate-500 mt-1">Gestisci le tue scadenze e prioritÃ  in un unico posto.</p></div>
            <form onSubmit={handleSave} className="flex flex-col gap-3 mb-8 bg-slate-50 p-5 rounded-xl border border-slate-200 transition-all duration-300 ring-offset-2 ring-2 ring-transparent focus-within:ring-blue-100"><label className="text-xs font-bold text-slate-500 uppercase tracking-wide flex justify-between">{editingId ? <span className="text-blue-600 flex items-center gap-1"><Edit size={12}/> Modifica in corso...</span> : 'Nuovo Promemoria'}</label><div className="flex flex-col md:flex-row gap-3"><input type="text" placeholder="Cosa devi fare oggi?" className="flex-1 bg-white border border-slate-300 rounded-lg px-4 py-2.5 focus:outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-100 transition" value={reminderForm.text} onChange={e => setReminderForm({...reminderForm, text: e.target.value})} /><input type="date" className="bg-white border border-slate-300 rounded-lg px-4 py-2.5 text-slate-600 focus:outline-none focus:border-blue-500" value={reminderForm.date} onChange={e => setReminderForm({...reminderForm, date: e.target.value})} /><input type="time" className="bg-white border border-slate-300 rounded-lg px-4 py-2.5 text-slate-600 focus:outline-none focus:border-blue-500" value={reminderForm.time} onChange={e => setReminderForm({...reminderForm, time: e.target.value})} /><div className="flex bg-white border border-slate-300 rounded-lg p-1 gap-1"><button type="button" onClick={() => setReminderForm({...reminderForm, priority: 'red'})} className={`p-2 rounded-md hover:bg-slate-100 transition ${reminderForm.priority === 'red' ? 'bg-red-50 text-red-600 ring-1 ring-red-500' : 'text-slate-400'}`} title="Alta PrioritÃ "><AlertCircle size={20} /></button><button type="button" onClick={() => setReminderForm({...reminderForm, priority: 'blue'})} className={`p-2 rounded-md hover:bg-slate-100 transition ${reminderForm.priority === 'blue' ? 'bg-blue-50 text-blue-600 ring-1 ring-blue-500' : 'text-slate-400'}`} title="Media PrioritÃ "><Bell size={20} /></button><button type="button" onClick={() => setReminderForm({...reminderForm, priority: 'green'})} className={`p-2 rounded-md hover:bg-slate-100 transition ${reminderForm.priority === 'green' ? 'bg-green-50 text-green-600 ring-1 ring-green-500' : 'text-slate-400'}`} title="Bassa PrioritÃ "><CheckCircle2 size={20} /></button></div>{editingId ? (<div className="flex gap-2"><button type="submit" className="bg-blue-600 text-white px-4 py-2.5 rounded-lg font-bold hover:bg-blue-700 shadow-md transition flex items-center justify-center gap-2"><Save size={18} /> Salva</button><button type="button" onClick={cancelEdit} className="bg-slate-200 text-slate-600 px-4 py-2.5 rounded-lg font-bold hover:bg-slate-300 transition flex items-center justify-center gap-2"><X size={18} /> Annulla</button></div>) : (<button type="submit" className="bg-blue-600 text-white px-6 py-2.5 rounded-lg font-bold hover:bg-blue-700 shadow-md transition flex items-center justify-center gap-2"><Plus size={18} /> Aggiungi</button>)}</div></form>
            <div className="space-y-3">{reminders.length === 0 && (<div className="text-center py-10 text-slate-400 bg-slate-50/50 rounded-xl border border-dashed border-slate-200"><CheckCircle2 size={48} className="mx-auto mb-2 opacity-20" /><p>Nessun promemoria attivo. Sei libero!</p></div>)}{reminders.map(rem => (<div key={rem.id} className={`flex items-center gap-4 p-4 rounded-xl border transition-all hover:shadow-md ${rem.completed ? 'bg-slate-50 border-transparent opacity-60' : `bg-white ${getPriorityStyle(rem.priority || 'blue')}`}`}><button onClick={() => toggleReminder(rem.id, rem.completed)} className="flex-shrink-0 transition hover:scale-110">{rem.completed ? <CheckCircle2 size={24} className="text-slate-400" /> : <Circle size={24} />}</button><div className="flex-1"><span className={`text-base font-medium block ${rem.completed ? 'text-slate-500 line-through' : 'text-slate-800'}`}>{rem.text}</span>{rem.dueDate && <span className="text-xs opacity-70 flex items-center gap-1.5 mt-1"><CalendarIcon size={12}/> Scadenza: {rem.dueDate.split('-').reverse().join('/')} {rem.dueTime && ` alle ${rem.dueTime}`}</span>}</div><div className="flex items-center gap-1"><button onClick={() => startEdit(rem)} className="p-2 text-slate-400 hover:text-blue-500 hover:bg-blue-50 rounded-lg transition" title="Modifica"><Edit size={18} /></button><button onClick={() => deleteReminder(rem.id)} className="p-2 text-slate-400 hover:text-red-500 hover:bg-red-50 rounded-lg transition" title="Elimina"><Trash2 size={18} /></button></div></div>))}</div>
        </div>
    </div>
  );
}

// --- MODULO: AUDIT MANAGER ---
function AuditManager({ user, appId, initialMode, setActiveModule }) {
  const [view, setView] = useState(initialMode === 'new' ? 'form' : 'dashboard');
  const [audits, setAudits] = useState([]);
  const [currentAudit, setCurrentAudit] = useState(null);
  const [isSaving, setIsSaving] = useState(false);
  const [isGenerating, setIsGenerating] = useState(false);
  const [loadingData, setLoadingData] = useState(true);
  const [dialog, setDialog] = useState(null); // NUOVO STATO MODALE

  // Effect per gestire initialMode dal padre (Dashboard)
  useEffect(() => {
    if (initialMode === 'new') {
        handleNewAudit();
    } else {
        setView('dashboard');
    }
  }, [initialMode]);

  useEffect(() => {
    if (!user) return;
    const unsubscribe = onSnapshot(collection(db, 'artifacts', appId, 'users', user.uid, 'audits'), (snapshot) => {
      const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      data.sort((a, b) => new Date(b.dataRilievo) - new Date(a.dataRilievo)); 
      setAudits(data);
      setLoadingData(false);
    }, (err) => { console.error(err); setLoadingData(false); });
    return () => unsubscribe();
  }, [user]);

  const handleNewAudit = () => {
    setCurrentAudit({
      tipoCliente: 'Azienda', dataRilievo: new Date().toISOString().split('T')[0], prossimoIncontro: '', 
      nomeSocieta: '', indirizzo: '', titoloPossesso: '', obiettivoCliente: '',
      referente: '', telefono: '', email: '', noteAnagrafica: '',
      presidente: '', telPresidente: '', emailPresidente: '', 
      segretaria: '', telSegretaria: '', emailSegretaria: '',
      checkFoto: false, checkLuce: false, checkGas: false,
      numFari: '', potenzaFari: '', numDocce1: '', numDocce2: '', numDocce3: '', numDocce4: '', numDocce5: '', numDocce6: '', numDocceArbitri1: '', numDocceArbitri2: '', numDocceArbitri3: '', numUtenti: '', orari: '', noteConsumi: '',
      consumoF1_1: '', consumoF2_1: '', consumoF3_1: '',
      consumoF1_2: '', consumoF2_2: '', consumoF3_2: '',
      consumoF1_3: '', consumoF2_3: '', consumoF3_3: '',
      consumoF1: '', consumoF2: '', consumoF3: '',
      consumoGas1: '', consumoGas2: '',
      nucleoFamiliare: '', abitudini: '', autoElettrica: false, elettrodomestici: '', 
      settoreAttivita: '', turniLavoro: '', macchinari: '', cabinaMT: false, noteAzienda: '',
      tipoTetto: '', impiantoTermico: '', accumulo: 'No', dettagliAccumulo: '', contatore: '', noteTecniche: '',
      metriCubi1: '', sistemaEmissione1: '', numTerminali1: '', contatore1: '', impiantoTermico1: '', 
      metriCubi2: '', sistemaEmissione2: '', numTerminali2: '', contatore2: '', impiantoTermico2: '', 
      metriCubi3: '', sistemaEmissione3: '', numTerminali3: '', contatore3: '', impiantoTermico3: '', 
      accumulo1: '', accumulo2: '',
      superficieTetto: '', orientamento: '',
      propostaFV: '', propostaAccumulo: '', propostaTermico: '', propostaNote: '',
      optLeasing: false, optIncentivi: false, budgetNote: '', noteOpzioni: '', linkDrive: '', linkSito: '', linkGoogleEarth: '', ia: '', ia2: '', ia3: '',
      ombreggianti: ''
    });
    setView('form');
  };

  const handleEditAudit = (audit) => { setCurrentAudit({ ...audit }); setView('form'); };
  
  const handleDeleteAudit = async (id, e) => { 
      e.stopPropagation(); 
      setDialog({
          title: "Elimina Rilievo",
          message: "Vuoi eliminare definitivamente questo report?",
          type: 'confirm',
          onConfirm: async () => {
              await deleteDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'audits', id));
              setDialog(null);
          },
          onCancel: () => setDialog(null)
      });
  };

  const handleSave = async () => { 
      if (!currentAudit.nomeSocieta) {
          setDialog({ title: "Dati Mancanti", message: "Inserisci il Nome Cliente/SocietÃ .", type: 'alert', onConfirm: () => setDialog(null) });
          return;
      }
      setIsSaving(true); 
      try { 
          let isNewAudit = !currentAudit.id;
          let savedAuditId = currentAudit.id;

          if (currentAudit.id) { 
              const { id, ...data } = currentAudit; 
              await updateDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'audits', id), data); 
          } else { 
              const docRef = await addDoc(collection(db, 'artifacts', appId, 'users', user.uid, 'audits'), currentAudit); 
              savedAuditId = docRef.id;
          } 
          
          setIsSaving(false); 

          // --- LOGICA FUNZIONALE: AUTO-CONVERSIONE LEAD ---
          if (isNewAudit) {
              const hasContactInfo = currentAudit.telefono || currentAudit.telPresidente || currentAudit.email || currentAudit.emailPresidente;
              if (hasContactInfo) {
                  const leadData = {
                      company: currentAudit.nomeSocieta,
                      name: currentAudit.referente || currentAudit.presidente || 'N/D',
                      phone: currentAudit.telefono || currentAudit.telPresidente || 'N/D',
                      city: currentAudit.indirizzo || 'N/D',
                      type: currentAudit.tipoCliente,
                      stage: 'Da Contattare',
                      source: 'Audit',
                      linkedAuditId: savedAuditId,
                      createdAt: new Date().toISOString()
                  };
                  
                  setDialog({
                      title: "Ottimo lavoro! ðŸŽ¯",
                      message: `Hai registrato un nuovo Audit per ${currentAudit.nomeSocieta}.\n\nVuoi inserirlo automaticamente nella Pipeline Vendite come Lead "Da Contattare"?`,
                      type: 'confirm',
                      onConfirm: async () => {
                          await addDoc(collection(db, 'artifacts', appId, 'users', user.uid, 'leads'), leadData);
                          setDialog(null);
                          setView('dashboard'); 
                          if(setActiveModule) setActiveModule('audits');
                      },
                      onCancel: () => {
                          setDialog(null);
                          setView('dashboard'); 
                          if(setActiveModule) setActiveModule('audits');
                      }
                  });
                  return; // Interrompe qui, il routing lo gestisce il Modale
              }
          }

          setView('dashboard'); 
          if(setActiveModule) setActiveModule('audits'); 
      } catch (error) { 
          setIsSaving(false);
          setDialog({ title: "Errore", message: "Errore salvataggio: " + error.message, type: 'alert', onConfirm: () => setDialog(null) });
      } 
  };
  
  const handleSendToPipeline = async () => {
      if (!currentAudit.nomeSocieta) {
          setDialog({ title: "Attenzione", message: "Manca il nome cliente!", type: 'alert', onConfirm: () => setDialog(null) });
          return;
      }
      const leadData = {
          company: currentAudit.nomeSocieta,
          name: currentAudit.referente || currentAudit.presidente || 'N/D',
          phone: currentAudit.telefono || currentAudit.telPresidente || 'N/D',
          city: currentAudit.indirizzo || 'N/D',
          type: currentAudit.tipoCliente,
          stage: 'Da Contattare',
          source: 'Audit',
          linkedAuditId: currentAudit.id || 'N/D',
          createdAt: new Date().toISOString()
      };
      
      setDialog({
          title: "Genera Lead",
          message: `Creare un lead in Pipeline per ${leadData.company}?`,
          type: 'confirm',
          onConfirm: async () => {
              await addDoc(collection(db, 'artifacts', appId, 'users', user.uid, 'leads'), leadData);
              setDialog({ title: "Successo", message: "âœ… Lead creato con successo nella Pipeline!", type: 'alert', onConfirm: () => setDialog(null) });
          },
          onCancel: () => setDialog(null)
      });
  };

  const generateAIProposal = async () => {
    if (!apiKey) { 
        setDialog({ title: "API Mancante", message: "Chiave API non configurata.", type: 'alert', onConfirm: () => setDialog(null) });
        return; 
    }
    setIsGenerating(true);
    const c = currentAudit;
    const prompt = `Sei un esperto consulente energetico. Analizza: Cliente: ${c.tipoCliente} - ${c.nomeSocieta}. Obiettivo: ${c.obiettivoCliente}. Consumi: ${c.consumoF1}/${c.consumoF2}/${c.consumoF3}. Tecnica: Tetto ${c.tipoTetto}, Sup. ${c.superficieTetto}mq, Orient. ${c.orientamento}. Genera JSON { "fv": "...", "accumulo": "...", "termico": "...", "note": "..." }`;
    try {
      const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] }) });
      const data = await response.json();
      const text = data.candidates[0].content.parts[0].text.replace(/```json|```/g, '').trim();
      const result = JSON.parse(text);
      setCurrentAudit(prev => ({ ...prev, propostaFV: result.fv, propostaAccumulo: result.accumulo, propostaTermico: result.termico, propostaNote: result.note }));
      setDialog({ title: "Completato", message: "âœ¨ Proposta generata con AI!", type: 'alert', onConfirm: () => setDialog(null) });
    } catch (error) { 
      console.error("AI Error", error); 
      setDialog({ title: "Errore", message: "Errore AI. Riprova piÃ¹ tardi.", type: 'alert', onConfirm: () => setDialog(null) });
    } finally { 
      setIsGenerating(false); 
    }
  };

  const getIcon = (type) => { if (type === 'Azienda') return <Factory size={18} className="text-blue-600" />; if (type === 'Residenziale') return <Home size={18} className="text-green-600" />; return <Trophy size={18} className="text-orange-600" />; };
  
  const generateOutput = () => {
    const c = currentAudit; const val = (k) => c[k] || '-'; const chk = (k) => c[k] ? 'âœ…' : 'âŒ'; let sections = {};
    const totGas = (parseInt(c.consumoGas1) || 0) + (parseInt(c.consumoGas2) || 0);
    const gasDisplay = totGas > 0 ? `â€¢ Gas (Smc): ${val('consumoGas1')} + ${val('consumoGas2')} = ${totGas} Tot.` : '';

    if (c.tipoCliente === 'ASD') { 
        const totDocceGiocatori = [1,2,3,4,5,6].reduce((acc, i) => acc + (parseInt(c[`numDocce${i}`]) || 0), 0);
        const totDocceArbitri = [1,2,3].reduce((acc, i) => acc + (parseInt(c[`numDocceArbitri${i}`]) || 0), 0);
        const totDocce = totDocceGiocatori + totDocceArbitri;
        const docceDisplay = totDocce > 0 ? `Giocatori (${totDocceGiocatori}) + Arbitri (${totDocceArbitri}) = ${totDocce} Tot.` : '-';
        
        const totKwFari = ((parseInt(c.numFari) || 0) * (parseInt(c.potenzaFari) || 0) / 1000).toFixed(1);
        let totalConsumi = 0; let consumptionDetails = '';
        [1, 2, 3].forEach(i => { const sum = (parseInt(c[`consumoF1_${i}`])||0) + (parseInt(c[`consumoF2_${i}`])||0) + (parseInt(c[`consumoF3_${i}`])||0); if (sum > 0) { totalConsumi += sum; consumptionDetails += `\n   âš¡ U${i}: F1:${val(`consumoF1_${i}`)} F2:${val(`consumoF2_${i}`)} F3:${val(`consumoF3_${i}`)} (${sum} kWh)`; }});
        if (totalConsumi > 0) consumptionDetails += `\n   ðŸ“Š TOTALE STRUTTURA: ${totalConsumi} kWh`;
        sections.specific = `*DATI ASD & CONSUMI*\nâ€¢ Docce: ${docceDisplay}\nâ€¢ Utenti/die: ${val('numUtenti')}\nâ€¢ Sup. Tetto: ${val('superficieTetto')} mq\nâ€¢ Orari: ${val('orari')}\nâ€¢ Fari: ${val('numFari')} x ${val('potenzaFari')}W = ${totKwFari} kW Tot.\nâ€¢ Orientamento: ${val('orientamento')}${consumptionDetails}\n${gasDisplay}\nâ€¢ Note Consumi: ${val('noteConsumi')}`; 
    } else if (c.tipoCliente === 'Azienda') { 
        let totalConsumiAz = 0; let consumptionDetailsAz = '';
        [1, 2, 3].forEach(i => { const sum = (parseInt(c[`consumoF1_${i}`])||0) + (parseInt(c[`consumoF2_${i}`])||0) + (parseInt(c[`consumoF3_${i}`])||0); if (sum > 0) { totalConsumiAz += sum; consumptionDetailsAz += `\n   âš¡ U${i}: F1:${val(`consumoF1_${i}`)} F2:${val(`consumoF2_${i}`)} F3:${val(`consumoF3_${i}`)} (${sum} kWh)`; }});
        if (totalConsumiAz > 0) consumptionDetailsAz += `\n   ðŸ“Š TOTALE ELETTRICO: ${totalConsumiAz} kWh`;
        sections.specific = `*DATI PRODUTTIVI*\nâ€¢ Settore: ${val('settoreAttivita')}\nâ€¢ Turni: ${val('turniLavoro')}\nâ€¢ Macchinari: ${val('macchinari')}\nâ€¢ Cabina MT: ${chk('cabinaMT')}${consumptionDetailsAz}\n${gasDisplay}\nâ€¢ Note Prod.: ${val('noteAzienda')}`; 
    } else { 
        const totConsumi = (parseInt(c.consumoF1)||0) + (parseInt(c.consumoF2)||0) + (parseInt(c.consumoF3)||0);
        sections.specific = `*DATI ABITATIVI*\nâ€¢ Nucleo: ${val('nucleoFamiliare')} persone\nâ€¢ Abitudini: ${val('abitudini')}\nâ€¢ Auto EV: ${chk('autoElettrica')}\nâ€¢ Elettrodomestici: ${val('elettrodomestici')}\nâ€¢ Consumi Luce: F1:${val('consumoF1')} F2:${val('consumoF2')} F3:${val('consumoF3')} (Tot: ${totConsumi} kWh)\n${gasDisplay}`; 
    }
    
    let unitMsg = '';
    [1, 2, 3].forEach(i => { 
        if (val(`metriCubi${i}`) !== '-' || val(`contatore${i}`) !== '-' || val(`impiantoTermico${i}`) !== '-') { 
            const qty = val(`numTerminali${i}`) !== '-' ? ` (${val(`numTerminali${i}`)} elem.)` : ''; 
            const termico = val(`impiantoTermico${i}`) !== '-' ? ` | ðŸ”¥ ${val(`impiantoTermico${i}`)}` : ''; 
            unitMsg += `\n   ðŸ“ *UnitÃ  ${i}:* ${val(`metriCubi${i}`)}mc | ${val(`sistemaEmissione${i}`)}${qty} | ${val(`contatore${i}`)}${termico}`; 
        }
    });
    let techExtra = '';
    if (c.tipoCliente === 'Azienda') { techExtra = `â€¢ Sup. Utile: ${val('superficieTetto')} mq\nâ€¢ Orientamento: ${val('orientamento')}\n`; }
    let accMsg = '';
    if (c.tipoCliente === 'ASD' && (c.accumulo1 || c.accumulo2)) { const totAcc = (parseInt(c.accumulo1) || 0) + (parseInt(c.accumulo2) || 0); accMsg = `L1: ${val('accumulo1')}L + L2: ${val('accumulo2')}L = ${totAcc}L Tot.`; } else { accMsg = `${c.accumulo} ${val('dettagliAccumulo')}`; }
    sections.units = unitMsg; sections.accDisplay = accMsg; sections.techExtra = techExtra;
    return { c, val, chk, sections };
  };

  const handleWhatsApp = () => { 
      const { c, val, chk, sections } = generateOutput(); 
      let icon = c.tipoCliente === 'Azienda' ? 'ðŸ­' : c.tipoCliente === 'Residenziale' ? 'ðŸ ' : 'ðŸ†'; 
      let msg = `*REPORT RILIEVO ${c.tipoCliente.toUpperCase()} ${icon}*\n*Cliente:* ${val('nomeSocieta')}\nðŸ“ ${val('indirizzo')}\nðŸ“… ${val('dataRilievo')}\n\n*1ï¸âƒ£ ANAGRAFICA*\nâ€¢ Titolo: ${val('titoloPossesso')}\nâ€¢ Obiettivo: ${val('obiettivoCliente')}\nâ€¢ Presidente: ${val('presidente')} (${val('telPresidente')} | ${val('emailPresidente')})\nâ€¢ Segreteria: ${val('segretaria')} (${val('telSegretaria')} | ${val('emailSegretaria')})\nâ€¢ Referente: ${val('referente')} (${val('telefono')})\nâ€¢ Note Anagrafica: ${val('noteAnagrafica')}\n\n${sections.specific}\n\n*3ï¸âƒ£ TECNICA*\nâ€¢ Tetto: ${val('tipoTetto')}\n${sections.techExtra}â€¢ Imp. Termico: ${val('impiantoTermico')}\nâ€¢ Accumulo: ${sections.accDisplay}\nâ€¢ Note: ${val('noteTecniche')}\n${sections.units}\n\n*4ï¸âƒ£ OPZIONI*\nâ€¢ Leasing: ${chk('optLeasing')} | Incen.: ${chk('optIncentivi')}\nâ€¢ Budget: ${val('budgetNote')}\nâ€¢ Note Generali: ${val('noteOpzioni')}\n\n*5ï¸âƒ£ PROPOSTA TECNICA* ðŸ’¡\nâ€¢ FV: ${val('propostaFV')}\nâ€¢ Accumulo: ${val('propostaAccumulo')}\nâ€¢ Termico: ${val('propostaTermico')}\nâ€¢ Note: ${val('propostaNote')}\n\nâ€¢ Drive: ${val('linkDrive')}\nâ€¢ Earth: ${val('linkGoogleEarth')}\nâ€¢ Sito: ${val('linkSito')}\nâ€¢ IA: ${val('ia')}\nâ€¢ IA 2: ${val('ia2')}\nâ€¢ IA 3: ${val('ia3')}`; 
      window.open(`https://wa.me/?text=${encodeURIComponent(msg)}`, '_blank'); 
  };
  
  const handlePrint = () => { 
      const { c, val, chk, sections } = generateOutput(); 
      const specificHtml = sections.specific.replace(/\*/g, '').split('\n').filter(l => l.trim()).map(l => { if (l.includes('DATI')) return `<h3>${l.trim()}</h3>`; return `<div class="row">${l.replace('â€¢', '<span class="label">').replace(':', ':</span> <span class="value">')}</span></div>`; }).join(''); 
      let unitsHtml = '';
      [1, 2, 3].forEach(i => { 
          if (val(`metriCubi${i}`) !== '-' || val(`contatore${i}`) !== '-' || val(`impiantoTermico${i}`) !== '-') { 
              const qty = val(`numTerminali${i}`) !== '-' ? ` (${val(`numTerminali${i}`)} elem.)` : ''; 
              unitsHtml += `<div style="background:#f9f9f9; padding:5px; margin-bottom:5px; border-left:3px solid #ccc;"><div class="row" style="font-weight:bold; margin-bottom:0;">UnitÃ  ${i}</div><div class="row"><span class="label">Imp. Termico:</span> <span class="value">${val(`impiantoTermico${i}`)}</span></div><div class="row"><span class="label">Volume:</span> <span class="value">${val(`metriCubi${i}`)} mc</span></div><div class="row"><span class="label">Sistema:</span> <span class="value">${val(`sistemaEmissione${i}`)}${qty}</span></div><div class="row"><span class="label">Contatore:</span> <span class="value">${val(`contatore${i}`)}</span></div></div>`; 
          }
      });
      let techFields = `<div class="row"><span class="label">Tetto:</span> <span class="value">${val('tipoTetto')}</span></div>`;
      if (c.tipoCliente === 'Azienda') { techFields += `<div class="grid"><div class="row"><span class="label">Sup. Utile:</span> <span class="value">${val('superficieTetto')} mq</span></div><div class="row"><span class="label">Orientamento:</span> <span class="value">${val('orientamento')}</span></div></div>`; }
      let consumptionHtml = '';
      const totGas = (parseInt(c.consumoGas1) || 0) + (parseInt(c.consumoGas2) || 0);
      const gasBlock = totGas > 0 ? `<div style="margin-top:5px; border-top:1px dashed #ccc; pt-2;"><div class="row" style="margin-bottom:0;"><strong>GAS (Smc):</strong> 1: ${val('consumoGas1')} | 2: ${val('consumoGas2')} -> <strong>Tot: ${totGas} Smc</strong></div></div>` : '';
      if (c.tipoCliente === 'Azienda' || c.tipoCliente === 'ASD') { let grandTotal = 0; consumptionHtml += `<div style="margin: 5px 0;"><strong>DETTAGLIO CONSUMI (Multi-POD)</strong></div>`; [1, 2, 3].forEach(i => { const sum = (parseInt(c[`consumoF1_${i}`])||0) + (parseInt(c[`consumoF2_${i}`])||0) + (parseInt(c[`consumoF3_${i}`])||0); if (sum > 0) { grandTotal += sum; consumptionHtml += `<div style="background:#f0fdf4; padding:5px; margin-bottom:5px; border:1px solid #bbf7d0;"><div class="row" style="margin-bottom:0; font-size:11px;"><strong>POD ${i}:</strong> F1:${val(`consumoF1_${i}`)} | F2:${val(`consumoF2_${i}`)} | F3:${val(`consumoF3_${i}`)}</div><div class="row" style="margin-bottom:0;">Totale Parziale: <strong>${sum} kWh</strong></div></div>`; }}); if (grandTotal > 0) { consumptionHtml += `<div style="background:#dcfce7; padding:8px; border:1px solid #86efac; margin-top:5px;"><div class="row" style="margin-bottom:0; font-weight:bold; font-size:14px;">TOTALE ELETTRICO: ${grandTotal} kWh/anno</div>${gasBlock}</div>`; } else if (gasBlock) { consumptionHtml += `<div style="background:#fff7ed; padding:8px; border:1px solid #fed7aa; margin-top:5px;">${gasBlock}</div>`; } } else if (c.tipoCliente === 'Residenziale') { const totConsumi = (parseInt(c.consumoF1)||0) + (parseInt(c.consumoF2)||0) + (parseInt(c.consumoF3)||0); consumptionHtml = `<div style="background:#f0fdf4; padding:5px; margin:5px 0; border:1px solid #bbf7d0;"><div class="row" style="margin-bottom:0; font-weight:bold;">ELETTRICO: F1:${val('consumoF1')} | F2:${val('consumoF2')} | F3:${val('consumoF3')}</div><div class="row" style="margin-bottom:0;">Totale Annuo: <strong>${totConsumi} kWh</strong></div></div>${gasBlock}`; }

      const html = `<html><head><title>Stampa ${c.tipoCliente}</title><style>body{font-family:Arial,sans-serif;padding:40px;color:#333;line-height:1.4;font-size:13px}h1{color:#0056b3;border-bottom:2px solid #0056b3;padding-bottom:10px;margin-bottom:20px}h3{background:#eee;padding:6px;border-left:5px solid #0056b3;margin-top:25px;margin-bottom:10px;font-size:14px}.row{margin-bottom:6px;display:flex;border-bottom:1px solid #f9f9f9;padding-bottom:2px}.label{font-weight:bold;width:160px;color:#555}.value{font-weight:bold;color:#000;flex-grow:1}.grid{display:grid;grid-template-columns:1fr 1fr;gap:15px}.badge{background:#0056b3;color:white;padding:2px 6px;border-radius:4px;font-size:10px;vertical-align:middle}</style></head><body><h1>âš¡ Report Rilievo <span class="badge">${c.tipoCliente}</span></h1><p><strong>Cliente:</strong> ${val('nomeSocieta')} | <strong>Data:</strong> ${val('dataRilievo')}</p><h3>ANAGRAFICA</h3><div class="row"><span class="label">Indirizzo:</span> <span class="value">${val('indirizzo')}</span></div><div class="grid"><div class="row"><span class="label">Titolo:</span> <span class="value">${val('titoloPossesso')}</span></div><div class="row"><span class="label">Obiettivo:</span> <span class="value">${val('obiettivoCliente')}</span></div></div><div class="row"><span class="label">Presidente:</span> <span class="value">${val('presidente')} (${val('telPresidente')} | ${val('emailPresidente')})</span></div><div class="row"><span class="label">Segreteria:</span> <span class="value">${val('segretaria')} (${val('telSegretaria')} | ${val('emailSegretaria')})</span></div><div class="row"><span class="label">Referente:</span> <span class="value">${val('referente')} (Tel: ${val('telefono')})</span></div><div class="row"><span class="label">Email Gen.:</span> <span class="value">${val('email')}</span></div><div class="row"><span class="label">Note:</span> <span class="value">${val('noteAnagrafica')}</span></div>${specificHtml}<h3>TECNICA & IMPIANTO</h3>${techFields}${consumptionHtml}<div class="grid"><div class="row"><span class="label">Termico:</span> <span class="value">${val('impiantoTermico')}</span></div><div class="row"><span class="label">Accumulo:</span> <span class="value">${sections.accDisplay}</span></div></div><div class="row"><span class="label">Note:</span> <span class="value">${val('noteTecniche')}</span></div>${unitsHtml ? `<h3>DETTAGLIO UNITÃ€</h3>${unitsHtml}` : ''}<h3>PROPOSTA DI DIMENSIONAMENTO</h3><div class="grid"><div class="row"><span class="label">Fotovoltaico:</span> <span class="value">${val('propostaFV')}</span></div><div class="row"><span class="label">Accumulo:</span> <span class="value">${val('propostaAccumulo')}</span></div></div><div class="row"><span class="label">Termico:</span> <span class="value">${val('propostaTermico')}</span></div><div class="row"><span class="label">Note Proposta:</span> <span class="value">${val('propostaNote')}</span></div><h3>DOCUMENTI & OPZIONI</h3><div class="row"><span class="label">Documenti:</span> <span class="value">[${chk('checkFoto')}] Foto | [${chk('checkLuce')}] Luce | [${chk('checkGas')}] Gas</span></div><div class="row"><span class="label">Interessi:</span> <span class="value">[${chk('optLeasing')}] Leasing | [${chk('optIncentivi')}] Incentivi</span></div><div class="row"><span class="label">Budget:</span> <span class="value">${val('budgetNote')}</span></div><div class="row"><span class="label">Note Gen.:</span> <span class="value">${val('noteOpzioni')}</span></div><div class="row"><span class="label">Drive:</span> <span class="value">${val('linkDrive')}</span></div><div class="row"><span class="label">Earth:</span> <span class="value">${val('linkGoogleEarth')}</span></div><div class="row"><span class="label">Sito:</span> <span class="value">${val('linkSito')}</span></div><div class="row"><span class="label">IA Link:</span> <span class="value">${val('ia')}</span></div><div class="row"><span class="label">IA Link 2:</span> <span class="value">${val('ia2')}</span></div><div class="row"><span class="label">IA Link 3:</span> <span class="value">${val('ia3')}</span></div><div style="margin-top:40px;text-align:center;font-size:11px;color:#999;">Generato da Giulio Consulente Energetico</div></body></html>`; const win = window.open('', '_blank', 'height=800,width=800'); if(win) { win.document.write(html); win.document.close(); win.focus(); setTimeout(()=>win.print(),250); } else alert("Sblocca i popup!"); };

  if (view === 'dashboard') {
    return (
      <div className="space-y-6 relative">
        {/* --- RENDER MODALE CUSTOM (DASHBOARD) --- */}
        {dialog && (
            <div className="fixed inset-0 bg-black/50 z-[100] flex items-center justify-center p-4">
                <div className="bg-white rounded-xl p-6 max-w-sm w-full shadow-2xl animate-in fade-in zoom-in duration-200">
                    <h3 className="font-bold text-lg text-slate-800 mb-2">{dialog.title}</h3>
                    <p className="text-slate-600 mb-6 whitespace-pre-wrap">{dialog.message}</p>
                    <div className="flex justify-end gap-3">
                        {dialog.type === 'confirm' && (
                            <button onClick={dialog.onCancel} className="px-4 py-2 rounded-lg font-medium text-slate-600 hover:bg-slate-100 transition">Annulla</button>
                        )}
                        <button onClick={dialog.onConfirm} className="px-4 py-2 rounded-lg font-bold bg-blue-600 text-white hover:bg-blue-700 transition">OK</button>
                    </div>
                </div>
            </div>
        )}
        <div className="flex justify-between items-center bg-white p-6 rounded-xl shadow-sm border border-slate-200">
          <div><h2 className="text-2xl font-bold text-slate-800">I Tuoi Audit</h2><p className="text-slate-500">Gestisci i rilievi di tutti i tuoi clienti da qui.</p></div>
          <button onClick={handleNewAudit} className="bg-blue-600 text-white px-5 py-3 rounded-lg shadow-lg hover:bg-blue-700 flex items-center gap-2 font-bold transition transform hover:-translate-y-0.5"><Plus size={20} /> Nuovo Audit</button>
        </div>
        {loadingData ? <div className="text-center py-10"><Loader2 className="animate-spin mx-auto text-blue-500" size={32} /></div> : audits.length === 0 ? <div className="bg-white p-12 rounded-xl shadow border border-dashed border-slate-300 text-center text-slate-400"><FileText size={64} className="mx-auto mb-4 opacity-20" /><p className="text-lg">Nessun audit presente.</p><p className="text-sm">Clicca "Nuovo Audit" per iniziare.</p></div> : (<div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">{audits.map((a) => (<div key={a.id} onClick={() => handleEditAudit(a)} className="bg-white rounded-xl shadow-sm border border-slate-200 hover:shadow-md hover:border-blue-300 transition cursor-pointer group overflow-hidden relative"><div className={`h-1.5 w-full ${a.tipoCliente==='Azienda'?'bg-blue-500':a.tipoCliente==='Residenziale'?'bg-green-500':'bg-orange-500'}`}></div><div className="p-5"><div className="flex justify-between items-start mb-3"><div className="flex items-center gap-2"><div className={`p-1.5 rounded-md ${a.tipoCliente==='Azienda'?'bg-blue-50 text-blue-600':a.tipoCliente==='Residenziale'?'bg-green-50 text-green-600':'bg-orange-50 text-orange-600'}`}>{getIcon(a.tipoCliente)}</div><span className="text-xs font-bold uppercase text-slate-400">{a.tipoCliente}</span></div><button onClick={(e) => handleDeleteAudit(a.id, e)} className="text-slate-300 hover:text-red-500 transition"><Trash2 size={18} /></button></div><h3 className="font-bold text-lg text-slate-800 mb-1 truncate">{a.nomeSocieta || "Senza Nome"}</h3><p className="text-sm text-slate-500 flex items-center gap-1 mb-4"><span className="opacity-50">ðŸ“…</span> {a.dataRilievo}</p><div className="text-xs text-slate-500 bg-slate-50 p-2 rounded truncate border border-slate-100">ðŸ“ {a.indirizzo || 'Nessun indirizzo'}</div></div><div className="bg-slate-50 p-3 flex justify-between items-center text-xs font-medium text-slate-500 border-t border-slate-100"><span>{a.checkLuce ? 'âœ… Bollette OK' : 'âŒ Manca Luce'}</span><span className="flex items-center gap-1 group-hover:text-blue-600 transition">Apri <ChevronRight size={14} /></span></div></div>))}</div>)}
      </div>
    );
  }

  if (view === 'form' && !currentAudit) {
      return (
          <div className="flex flex-col items-center justify-center h-full text-slate-500">
              <Loader2 className="animate-spin mb-2" size={32}/>
              <p>Caricamento modulo...</p>
          </div>
      );
  }

  return (
    <div className="bg-white rounded-xl shadow-xl overflow-hidden border border-slate-200 flex flex-col h-full relative">
        {/* --- RENDER MODALE CUSTOM (FORM) --- */}
        {dialog && (
            <div className="fixed inset-0 bg-black/50 z-[100] flex items-center justify-center p-4">
                <div className="bg-white rounded-xl p-6 max-w-sm w-full shadow-2xl animate-in fade-in zoom-in duration-200">
                    <h3 className="font-bold text-lg text-slate-800 mb-2">{dialog.title}</h3>
                    <p className="text-slate-600 mb-6 whitespace-pre-wrap">{dialog.message}</p>
                    <div className="flex justify-end gap-3">
                        {dialog.type === 'confirm' && (
                            <button onClick={dialog.onCancel} className="px-4 py-2 rounded-lg font-medium text-slate-600 hover:bg-slate-100 transition">
                                {dialog.title.includes("Ottimo lavoro") ? "No, salva solo" : "Annulla"}
                            </button>
                        )}
                        <button onClick={dialog.onConfirm} className="px-4 py-2 rounded-lg font-bold bg-blue-600 text-white hover:bg-blue-700 transition">
                            {dialog.title.includes("Ottimo lavoro") ? "OK, Vai in Pipeline" : "OK"}
                        </button>
                    </div>
                </div>
            </div>
        )}
        
        <div className="bg-white border-b border-slate-200 p-4 flex flex-col md:flex-row justify-between items-center gap-4 sticky top-0 z-30 shadow-sm">
            <div className="flex bg-slate-100 p-1 rounded-lg">
                {['Azienda', 'Residenziale', 'ASD'].map(type => (
                    <button key={type} onClick={() => setCurrentAudit({...currentAudit, tipoCliente: type})} className={`px-4 py-2 rounded-md text-sm font-bold flex items-center gap-2 transition ${currentAudit.tipoCliente === type ? 'bg-white text-blue-700 shadow-sm ring-1 ring-black/5' : 'text-slate-500 hover:text-slate-700'}`}>{getIcon(type)} <span className="hidden sm:inline">{type}</span></button>
                ))}
            </div>
            <div className="flex items-center gap-2">
                {currentAudit.id && (
                    <button onClick={handleSendToPipeline} className="p-2.5 text-purple-600 bg-purple-50 rounded-lg hover:bg-purple-100 border border-purple-200 transition hidden lg:flex items-center gap-2 font-bold text-sm" title="Genera Lead in Pipeline">
                        <Kanban size={18} /> <span>Genera Lead</span>
                    </button>
                )}
                <button onClick={handleWhatsApp} className="p-2.5 text-green-600 bg-green-50 rounded-lg hover:bg-green-100 border border-green-200 transition" title="WhatsApp"><Share2 size={20} /></button>
                <button onClick={handlePrint} className="p-2.5 text-slate-600 bg-slate-50 rounded-lg hover:bg-slate-100 border border-slate-200 transition" title="Stampa"><Printer size={20} /></button>
                <div className="h-8 w-px bg-slate-300 mx-2 hidden md:block"></div>
                <button onClick={() => { setView('dashboard'); if(setActiveModule) setActiveModule('audits'); }} className="text-slate-500 font-medium hover:text-slate-800 px-3 hidden md:block">Annulla</button>
                <button onClick={handleSave} disabled={isSaving} className={`flex items-center gap-2 text-white px-6 py-2.5 rounded-lg font-bold shadow-md transition ${isSaving ? 'bg-blue-400' : 'bg-blue-600 hover:bg-blue-700'}`}>{isSaving ? <Loader2 size={20} className="animate-spin" /> : <Save size={20} />} Salva</button>
            </div>
        </div>
        <div className="p-6 md:p-8 space-y-8 overflow-y-auto bg-slate-50/50">
            <Section title="1. Anagrafica" icon="user" color="red">
            <div className="grid md:grid-cols-2 gap-5">
                <div className="grid grid-cols-2 gap-2">
                    <Input label="Data Rilievo" type="date" value={currentAudit.dataRilievo || ''} onChange={v => setCurrentAudit({...currentAudit, dataRilievo: v})} />
                    <Input label="Prossimo Incontro" type="date" value={currentAudit.prossimoIncontro || ''} onChange={v => setCurrentAudit({...currentAudit, prossimoIncontro: v})} />
                </div>
                <Input label={currentAudit.tipoCliente === 'Residenziale' ? "Cognome Famiglia" : "Nome SocietÃ /ASD"} value={currentAudit.nomeSocieta || ''} onChange={v => setCurrentAudit({...currentAudit, nomeSocieta: v})} placeholder={currentAudit.tipoCliente === 'Residenziale' ? "Es. Famiglia Rossi" : "Es. Metalmeccanica SPA"} />
            </div>
            <Input label="Indirizzo Impianto" value={currentAudit.indirizzo || ''} onChange={v => setCurrentAudit({...currentAudit, indirizzo: v})} placeholder="Es. Via Torino 15, Collegno (TO)" />
            <div className="grid md:grid-cols-2 gap-5"><Select label="Titolo Possesso" value={currentAudit.titoloPossesso || ''} onChange={v => setCurrentAudit({...currentAudit, titoloPossesso: v})} options={['ProprietÃ ', 'Affitto', 'Concessione', 'Altro']} /><Input label="Obiettivo Dichiarato" value={currentAudit.obiettivoCliente || ''} onChange={v => setCurrentAudit({...currentAudit, obiettivoCliente: v})} placeholder="Es. Risparmio bolletta, Ristrutturazione..." /></div>
            <div className="grid md:grid-cols-3 gap-3"><Input label="Presidente" value={currentAudit.presidente || ''} onChange={v => setCurrentAudit({...currentAudit, presidente: v})} placeholder="Nome" /><Input label="Tel. Presidente" value={currentAudit.telPresidente || ''} onChange={v => setCurrentAudit({...currentAudit, telPresidente: v})} placeholder="333..." /><Input label="Email Presidente" value={currentAudit.emailPresidente || ''} onChange={v => setCurrentAudit({...currentAudit, emailPresidente: v})} placeholder="@" /></div>
            <div className="grid md:grid-cols-3 gap-3"><Input label="Segretaria/o" value={currentAudit.segretaria || ''} onChange={v => setCurrentAudit({...currentAudit, segretaria: v})} placeholder="Nome" /><Input label="Tel. Segretaria/o" value={currentAudit.telSegretaria || ''} onChange={v => setCurrentAudit({...currentAudit, telSegretaria: v})} placeholder="333..." /><Input label="Email Segretaria/o" value={currentAudit.emailSegretaria || ''} onChange={v => setCurrentAudit({...currentAudit, emailSegretaria: v})} placeholder="@" /></div>
            <div className="grid md:grid-cols-2 gap-5"><Input label="Referente (Generico)" value={currentAudit.referente || ''} onChange={v => setCurrentAudit({...currentAudit, referente: v})} placeholder="Nome e Cognome" /><Input label="Telefono" value={currentAudit.telefono || ''} onChange={v => setCurrentAudit({...currentAudit, telefono: v})} placeholder="333..." /></div>
            <Input label="Email" value={currentAudit.email || ''} onChange={v => setCurrentAudit({...currentAudit, email: v})} placeholder="@email.it" />
            <Textarea label="Note Anagrafica" value={currentAudit.noteAnagrafica || ''} onChange={v => setCurrentAudit({...currentAudit, noteAnagrafica: v})} placeholder="Dettagli extra su contatti o orari..." />
            </Section>
            {currentAudit.tipoCliente === 'Azienda' && (<Section title="2. Dati Produttivi (Azienda)" icon="factory" color="purple">
                <Input label="Settore AttivitÃ " value={currentAudit.settoreAttivita || ''} onChange={v => setCurrentAudit({...currentAudit, settoreAttivita: v})} placeholder="Es. Stampaggio Plastica" />
                <Input label="Turni di Lavoro" value={currentAudit.turniLavoro || ''} onChange={v => setCurrentAudit({...currentAudit, turniLavoro: v})} placeholder="Es. Lun-Ven su 2 turni (06-22)" />
                <Input label="Macchinari Energivori" value={currentAudit.macchinari || ''} onChange={v => setCurrentAudit({...currentAudit, macchinari: v})} placeholder="Es. 3 Presse, 1 Forno industriale" />
                <div className="bg-purple-50 p-4 rounded-lg border border-purple-100"><Checkbox label="Presenza Cabina Elettrica (MT/BT)" checked={currentAudit.cabinaMT || false} onChange={c => setCurrentAudit({...currentAudit, cabinaMT: c})} /></div>
                
                {/* CONSUMI MULTI-UNITÃ€ (UNITA 1, 2, 3) - AZIENDA */}
                <div className="space-y-4 my-4">
                    <p className="font-bold text-sm text-purple-800 uppercase border-b border-purple-200 pb-1">Dettaglio Consumi Elettrici per UnitÃ  (POD)</p>
                    {[1, 2, 3].map(i => (
                        <div key={i} className="p-3 bg-purple-50/40 border border-purple-100 rounded-lg">
                                <p className="text-[10px] font-bold text-purple-700 mb-2 uppercase">UnitÃ  / POD {i}</p>
                                <div className="grid grid-cols-4 gap-2 items-end">
                                    <Input label="F1" type="number" value={currentAudit[`consumoF1_${i}`] || ''} onChange={v => setCurrentAudit({...currentAudit, [`consumoF1_${i}`]: v})} placeholder="0" />
                                    <Input label="F2" type="number" value={currentAudit[`consumoF2_${i}`] || ''} onChange={v => setCurrentAudit({...currentAudit, [`consumoF2_${i}`]: v})} placeholder="0" />
                                    <Input label="F3" type="number" value={currentAudit[`consumoF3_${i}`] || ''} onChange={v => setCurrentAudit({...currentAudit, [`consumoF3_${i}`]: v})} placeholder="0" />
                                    <div className="bg-white border border-purple-200 p-2 rounded text-center">
                                        <span className="block text-[9px] text-gray-400">TOTALE</span>
                                        <span className="font-bold text-sm">{(parseInt(currentAudit[`consumoF1_${i}`])||0) + (parseInt(currentAudit[`consumoF2_${i}`])||0) + (parseInt(currentAudit[`consumoF3_${i}`])||0)}</span>
                                    </div>
                                </div>
                        </div>
                    ))}
                    {/* GRANDE TOTALE */}
                    <div className="bg-purple-100 p-3 rounded-lg border border-purple-300 text-center">
                        <span className="block text-xs font-bold text-purple-900 uppercase mb-1">CONSUMO TOTALE ELETTRICO (Tutte le UnitÃ )</span>
                        <div className="text-xl font-bold text-slate-800">
                            {[1, 2, 3].reduce((acc, i) => acc + (parseInt(currentAudit[`consumoF1_${i}`])||0) + (parseInt(currentAudit[`consumoF2_${i}`])||0) + (parseInt(currentAudit[`consumoF3_${i}`])||0), 0)} kWh/anno
                        </div>
                    </div>
                </div>

                {/* CONSUMI GAS */}
                <div className="bg-white border border-red-200 p-3 rounded-lg mt-3 mb-3">
                     <p className="font-bold text-xs text-red-800 mb-2 uppercase flex items-center gap-1"><Flame size={12}/> Consumi Gas/Metano (Smc)</p>
                     <div className="grid grid-cols-3 gap-2 items-end">
                         <Input label="Contatore 1 (Smc)" type="number" value={currentAudit.consumoGas1 || ''} onChange={v => setCurrentAudit({...currentAudit, consumoGas1: v})} placeholder="0" />
                         <Input label="Contatore 2 (Smc)" type="number" value={currentAudit.consumoGas2 || ''} onChange={v => setCurrentAudit({...currentAudit, consumoGas2: v})} placeholder="0" />
                         <div className="bg-red-50 p-2 rounded text-center border border-red-100">
                             <span className="block text-[10px] font-bold text-red-800 uppercase">TOTALE SMC</span>
                             <span className="font-bold text-slate-800">{(parseInt(currentAudit.consumoGas1)||0) + (parseInt(currentAudit.consumoGas2)||0)}</span>
                         </div>
                     </div>
                </div>

                <Textarea label="Note Produttive" value={currentAudit.noteAzienda || ''} onChange={v => setCurrentAudit({...currentAudit, noteAzienda: v})} placeholder="Dettagli su picchi di consumo, ferie estive, ampliamenti futuri..." />
            </Section>)}
            {currentAudit.tipoCliente === 'Residenziale' && (<Section title="2. Dati Abitativi (Residenziale)" icon="home" color="green"><div className="grid md:grid-cols-2 gap-5"><Input label="Nucleo Familiare" type="number" value={currentAudit.nucleoFamiliare || ''} onChange={v => setCurrentAudit({...currentAudit, nucleoFamiliare: v})} placeholder="Es. 4" /><Input label="Abitudini Consumo" value={currentAudit.abitudini || ''} onChange={v => setCurrentAudit({...currentAudit, abitudini: v})} placeholder="Es. Prevalentemente Sera" /></div><Input label="Grandi Elettrodomestici" value={currentAudit.elettrodomestici || ''} onChange={v => setCurrentAudit({...currentAudit, elettrodomestici: v})} placeholder="Es. Induzione, 3 Split Aria Cond., Asciugatrice" /><div className="bg-green-50 p-4 rounded-lg border border-green-100"><Checkbox label="Possiede Auto Elettrica / Wallbox" checked={currentAudit.autoElettrica || false} onChange={c => setCurrentAudit({...currentAudit, autoElettrica: c})} /></div>
            
            <div className="bg-white border border-green-200 p-3 rounded-lg mt-3 mb-3">
                    <p className="font-bold text-xs text-green-800 mb-2 uppercase">Consumi Elettrici (kWh)</p>
                    <div className="grid grid-cols-4 gap-2 items-end">
                        <Input label="F1" type="number" value={currentAudit.consumoF1 || ''} onChange={v => setCurrentAudit({...currentAudit, consumoF1: v})} placeholder="0" />
                        <Input label="F2" type="number" value={currentAudit.consumoF2 || ''} onChange={v => setCurrentAudit({...currentAudit, consumoF2: v})} placeholder="0" />
                        <Input label="F3" type="number" value={currentAudit.consumoF3 || ''} onChange={v => setCurrentAudit({...currentAudit, consumoF3: v})} placeholder="0" />
                        <div className="bg-green-100 p-2 rounded text-center">
                            <span className="block text-[10px] font-bold text-green-800 uppercase">TOTALE</span>
                            <span className="font-bold text-slate-800">{(parseInt(currentAudit.consumoF1)||0) + (parseInt(currentAudit.consumoF2)||0) + (parseInt(currentAudit.consumoF3)||0)}</span>
                        </div>
                    </div>
            </div>

            {/* CONSUMI GAS RESIDENZIALE */}
            <div className="bg-white border border-red-200 p-3 rounded-lg mt-3 mb-3">
                    <p className="font-bold text-xs text-red-800 mb-2 uppercase flex items-center gap-1"><Flame size={12}/> Consumi Gas/Metano (Smc)</p>
                    <div className="grid grid-cols-3 gap-2 items-end">
                        <Input label="Contatore 1" type="number" value={currentAudit.consumoGas1 || ''} onChange={v => setCurrentAudit({...currentAudit, consumoGas1: v})} placeholder="0" />
                        <Input label="Contatore 2" type="number" value={currentAudit.consumoGas2 || ''} onChange={v => setCurrentAudit({...currentAudit, consumoGas2: v})} placeholder="0" />
                        <div className="bg-red-50 p-2 rounded text-center border border-red-100">
                            <span className="block text-[10px] font-bold text-red-800 uppercase">TOTALE SMC</span>
                            <span className="font-bold text-slate-800">{(parseInt(currentAudit.consumoGas1)||0) + (parseInt(currentAudit.consumoGas2)||0)}</span>
                        </div>
                    </div>
            </div>
            
            </Section>)}
            {currentAudit.tipoCliente === 'ASD' && (<Section title="2. Consumi & Superfici (ASD)" icon="trophy" color="yellow">
                
                {/* DOCCE ASD */}
                <div className="bg-yellow-50 p-4 rounded-lg border border-yellow-100 mb-4">
                    <div className="flex justify-between items-center mb-4 border-b border-yellow-200 pb-2">
                         <p className="font-bold text-sm text-yellow-800 flex items-center gap-2"><div className="w-2 h-2 bg-yellow-500 rounded-full"></div>Locali Docce</p>
                         <div className="bg-white px-3 py-1 rounded-md border border-yellow-300 shadow-sm text-sm font-bold text-yellow-800 flex items-center gap-2">
                             Totale: <span className="text-lg">
                                { [1,2,3,4,5,6].reduce((acc, i) => acc + (parseInt(currentAudit[`numDocce${i}`]) || 0), 0) + [1,2,3].reduce((acc, i) => acc + (parseInt(currentAudit[`numDocceArbitri${i}`]) || 0), 0) }
                             </span>
                         </div>
                    </div>
                    
                    <p className="text-xs font-bold text-yellow-700 uppercase mb-2">Locali Giocatori</p>
                    <div className="grid grid-cols-3 md:grid-cols-6 gap-3 mb-5">
                        {[1,2,3,4,5,6].map(i => (
                            <Input key={`g${i}`} label={`Loc. ${i}`} type="number" value={currentAudit[`numDocce${i}`] || ''} onChange={v => setCurrentAudit({...currentAudit, [`numDocce${i}`]: v})} placeholder="0" />
                        ))}
                    </div>

                    <p className="text-xs font-bold text-yellow-700 uppercase mb-2">Spogliatoi Arbitri</p>
                    <div className="grid grid-cols-3 md:grid-cols-6 gap-3">
                        {[1,2,3].map(i => (
                            <Input key={`a${i}`} label={`Arb. ${i}`} type="number" value={currentAudit[`numDocceArbitri${i}`] || ''} onChange={v => setCurrentAudit({...currentAudit, [`numDocceArbitri${i}`]: v})} placeholder="0" />
                        ))}
                    </div>
                </div>

                <div className="grid md:grid-cols-3 gap-5">
                    <Input label="Utenti/Die (Media)" type="number" value={currentAudit.numUtenti || ''} onChange={v => setCurrentAudit({...currentAudit, numUtenti: v})} placeholder="Es. 40" />
                    <Input label="Superficie Tetto Utile (mq)" type="number" value={currentAudit.superficieTetto || ''} onChange={v => setCurrentAudit({...currentAudit, superficieTetto: v})} placeholder="Es. 200" />
                    <Select label="Orientamento FV" value={currentAudit.orientamento || ''} onChange={v => setCurrentAudit({...currentAudit, orientamento: v})} options={['Sud', 'Est/Ovest', 'Sud-Est', 'Sud-Ovest', 'Nord', 'Piano']} />
                </div>
                
                {/* CONSUMI MULTI-UNITÃ€ (UNITA 1, 2, 3) */}
                <div className="space-y-4 my-4">
                    <p className="font-bold text-sm text-yellow-800 uppercase border-b border-yellow-200 pb-1">Dettaglio Consumi Elettrici per UnitÃ  (POD)</p>
                    {[1, 2, 3].map(i => (
                        <div key={i} className="p-3 bg-yellow-50/40 border border-yellow-100 rounded-lg">
                             <p className="text-[10px] font-bold text-yellow-700 mb-2 uppercase">UnitÃ  / POD {i}</p>
                             <div className="grid grid-cols-4 gap-2 items-end">
                                 <Input label="F1" type="number" value={currentAudit[`consumoF1_${i}`] || ''} onChange={v => setCurrentAudit({...currentAudit, [`consumoF1_${i}`]: v})} placeholder="0" />
                                 <Input label="F2" type="number" value={currentAudit[`consumoF2_${i}`] || ''} onChange={v => setCurrentAudit({...currentAudit, [`consumoF2_${i}`]: v})} placeholder="0" />
                                 <Input label="F3" type="number" value={currentAudit[`consumoF3_${i}`] || ''} onChange={v => setCurrentAudit({...currentAudit, [`consumoF3_${i}`]: v})} placeholder="0" />
                                 <div className="bg-white border border-yellow-200 p-2 rounded text-center">
                                     <span className="block text-[9px] text-gray-400">TOTALE</span>
                                     <span className="font-bold text-sm">{(parseInt(currentAudit[`consumoF1_${i}`])||0) + (parseInt(currentAudit[`consumoF2_${i}`])||0) + (parseInt(currentAudit[`consumoF3_${i}`])||0)}</span>
                                 </div>
                             </div>
                        </div>
                    ))}
                    {/* GRANDE TOTALE */}
                    <div className="bg-yellow-100 p-3 rounded-lg border border-yellow-300 text-center">
                        <span className="block text-xs font-bold text-yellow-900 uppercase mb-1">CONSUMO TOTALE ELETTRICO (Tutte le UnitÃ )</span>
                        <div className="text-xl font-bold text-slate-800">
                            {[1, 2, 3].reduce((acc, i) => acc + (parseInt(currentAudit[`consumoF1_${i}`])||0) + (parseInt(currentAudit[`consumoF2_${i}`])||0) + (parseInt(currentAudit[`consumoF3_${i}`])||0), 0)} kWh/anno
                        </div>
                    </div>
                </div>

                {/* CONSUMI GAS ASD */}
                <div className="bg-white border border-red-200 p-3 rounded-lg mt-3 mb-3">
                        <p className="font-bold text-xs text-red-800 mb-2 uppercase flex items-center gap-1"><Flame size={12}/> Consumi Gas/Metano (Smc)</p>
                        <div className="grid grid-cols-3 gap-2 items-end">
                            <Input label="Contatore 1" type="number" value={currentAudit.consumoGas1 || ''} onChange={v => setCurrentAudit({...currentAudit, consumoGas1: v})} placeholder="0" />
                            <Input label="Contatore 2" type="number" value={currentAudit.consumoGas2 || ''} onChange={v => setCurrentAudit({...currentAudit, consumoGas2: v})} placeholder="0" />
                            <div className="bg-red-50 p-2 rounded text-center border border-red-100">
                                <span className="block text-[10px] font-bold text-red-800 uppercase">TOTALE SMC</span>
                                <span className="font-bold text-slate-800">{(parseInt(currentAudit.consumoGas1)||0) + (parseInt(currentAudit.consumoGas2)||0)}</span>
                            </div>
                        </div>
                </div>

                <Textarea label="Orari Utilizzo" value={currentAudit.orari || ''} onChange={v => setCurrentAudit({...currentAudit, orari: v})} placeholder="Es. Lun-Ven 17-23" />
                <div className="bg-yellow-50 p-4 rounded-lg border border-yellow-100 mt-2">
                    <p className="font-bold text-sm text-yellow-800 mb-3 flex items-center gap-2"><div className="w-2 h-2 bg-yellow-500 rounded-full"></div>Illuminazione Campo</p>
                    <div className="grid md:grid-cols-2 gap-5">
                        <Input label="N. Fari" type="number" value={currentAudit.numFari || ''} onChange={v => setCurrentAudit({...currentAudit, numFari: v})} placeholder="Es. 4" />
                        <Input label="Potenza (W)" value={currentAudit.potenzaFari || ''} onChange={v => setCurrentAudit({...currentAudit, potenzaFari: v})} placeholder="Es. 2000W" />
                    </div>
                    <div className="bg-yellow-100/50 p-2.5 rounded-lg border border-yellow-200 flex flex-col justify-center mt-3">
                        <label className="block text-xs font-bold text-yellow-800 mb-1 uppercase">Totale Potenza</label>
                        <div className="text-lg font-bold text-slate-700">{((parseInt(currentAudit.numFari) || 0) * (parseInt(currentAudit.potenzaFari) || 0) / 1000).toFixed(1)} kW</div>
                    </div>
                </div>
                <Textarea label="Note Consumi" value={currentAudit.noteConsumi || ''} onChange={v => setCurrentAudit({...currentAudit, noteConsumi: v})} placeholder="Dettagli su utilizzo extra, tornei..." />
            </Section>)}
            
            {/* 3. DATI TECNICI & UNITÃ€ */}
            <Section title="3. Dati Tecnici & UnitÃ " icon="tool" color="orange">
                <div className="grid md:grid-cols-2 gap-5"><Select label="Tipo Tetto" value={currentAudit.tipoTetto || ''} onChange={v => setCurrentAudit({...currentAudit, tipoTetto: v})} options={['Piano - Guaina', 'Piano - Ghiaia', 'Falda - Tegole', 'Falda - Lamiera', 'Shed (Industriale)', 'Altro']} /><Input label="Ombreggianti" value={currentAudit.ombreggianti || ''} onChange={v => setCurrentAudit({...currentAudit, ombreggianti: v})} placeholder="Es. Camini, Antenne, Alberi, Edifici..." /></div>
                
                {/* CAMPi AGGIUNTIVI PER AZIENDA */}
                {currentAudit.tipoCliente === 'Azienda' && (
                    <div className="grid md:grid-cols-2 gap-5 bg-orange-50 p-3 rounded-lg border border-orange-100 mb-2">
                         <Input label="Superficie Tetto Utile (mq)" type="number" value={currentAudit.superficieTetto || ''} onChange={v => setCurrentAudit({...currentAudit, superficieTetto: v})} placeholder="Es. 500" />
                         <Select label="Orientamento FV" value={currentAudit.orientamento || ''} onChange={v => setCurrentAudit({...currentAudit, orientamento: v})} options={['Sud', 'Est/Ovest', 'Sud-Est', 'Sud-Ovest', 'Nord (Sconsigliato)', 'Piano (360Â°)']} />
                    </div>
                )}

                {/* LOOP UNITÃ€ CON TOTALI CALCOLATI AL VOLO */}
                <div className="space-y-4 my-2">
                    {[1, 2, 3].map(i => (
                        <div key={i} className="p-4 bg-orange-50/50 border border-orange-100 rounded-lg relative">
                            <span className="absolute top-0 left-0 bg-orange-200 text-orange-800 text-[10px] font-bold px-2 py-0.5 rounded-br-lg">UNITÃ€ {i}</span>
                            <div className="mt-4">
                                <div className="mb-3">
                                    <Input label={`Imp. Termico Attuale U${i}`} value={currentAudit[`impiantoTermico${i}`] || ''} onChange={v => setCurrentAudit({...currentAudit, [`impiantoTermico${i}`]: v})} placeholder="Es. Caldaia 24kW / Pompa di Calore" />
                                </div>
                                <div className="grid md:grid-cols-4 gap-3">
                                    <Input label={`Volume (mc)`} type="number" value={currentAudit[`metriCubi${i}`] || ''} onChange={v => setCurrentAudit({...currentAudit, [`metriCubi${i}`]: v})} placeholder="Es. 500" />
                                    <Select label={`Sistema Emissione`} value={currentAudit[`sistemaEmissione${i}`] || ''} onChange={v => setCurrentAudit({...currentAudit, [`sistemaEmissione${i}`]: v})} options={['Radiatori', 'Fan Coil', 'Pavimento', 'Split', 'Altro']} />
                                    <Input label={`N. Elementi`} type="number" value={currentAudit[`numTerminali${i}`] || ''} onChange={v => setCurrentAudit({...currentAudit, [`numTerminali${i}`]: v})} placeholder="Es. 10" />
                                    <Input label={`Contatore`} value={currentAudit[`contatore${i}`] || ''} onChange={v => setCurrentAudit({...currentAudit, [`contatore${i}`]: v})} placeholder="Es. 15kW" />
                                </div>
                            </div>
                        </div>
                    ))}
                    {/* TOTALI */}
                    <div className="grid md:grid-cols-3 gap-4 bg-orange-100/50 p-3 rounded-lg border border-orange-200 mt-2">
                         <div className="text-center">
                             <label className="block text-xs font-bold text-orange-800 mb-1 uppercase">Totale Volume</label>
                             <div className="text-lg font-bold text-slate-700">{[1,2,3].reduce((acc, i) => acc + (parseFloat(currentAudit[`metriCubi${i}`]) || 0), 0)} mc</div>
                         </div>
                         <div className="text-center">
                             <label className="block text-xs font-bold text-orange-800 mb-1 uppercase">Totale Elementi</label>
                             <div className="text-lg font-bold text-slate-700">{[1,2,3].reduce((acc, i) => acc + (parseInt(currentAudit[`numTerminali${i}`]) || 0), 0)}</div>
                         </div>
                         <div className="text-center">
                             <label className="block text-xs font-bold text-orange-800 mb-1 uppercase">Totale Potenza</label>
                             <div className="text-lg font-bold text-slate-700">{[1,2,3].reduce((acc, i) => acc + (parseFloat(currentAudit[`contatore${i}`]) || 0), 0)} kW</div>
                         </div>
                    </div>
                </div>

                {/* ACCUMULO DIFFERENZIATO PER ASD */}
                {currentAudit.tipoCliente === 'ASD' ? (
                    <div className="grid md:grid-cols-3 gap-4 mb-4">
                        <Input label="Accumulo Locale 1 (L)" type="number" value={currentAudit.accumulo1 || ''} onChange={v => setCurrentAudit({...currentAudit, accumulo1: v})} placeholder="Es. 300" />
                        <Input label="Accumulo Locale 2 (L)" type="number" value={currentAudit.accumulo2 || ''} onChange={v => setCurrentAudit({...currentAudit, accumulo2: v})} placeholder="Es. 200" />
                        <div className="bg-orange-50/50 p-2.5 rounded-lg border border-orange-200">
                            <label className="block text-xs font-bold text-orange-800 mb-1 uppercase">Totale Litri</label>
                            <div className="text-lg font-bold text-slate-700">{(parseInt(currentAudit.accumulo1) || 0) + (parseInt(currentAudit.accumulo2) || 0)} L</div>
                        </div>
                    </div>
                ) : (
                    <div className="grid md:grid-cols-2 gap-5">
                        <Select label="Accumulo" value={currentAudit.accumulo || ''} onChange={v => setCurrentAudit({...currentAudit, accumulo: v})} options={['No', 'SÃ¬']} />
                        <Input label="Dettagli Accumulo" value={currentAudit.dettagliAccumulo || ''} onChange={v => setCurrentAudit({...currentAudit, dettagliAccumulo: v})} placeholder="Es. 200L" />
                    </div>
                )}
                
                <Textarea label="Note Tecniche (Amianto, Accessi...)" value={currentAudit.noteTecniche || ''} onChange={v => setCurrentAudit({...currentAudit, noteTecniche: v})} placeholder="Dettagli tecnici rilevanti..." />
            </Section>
            
            {/* 4. OPZIONI & DOCS (Aggiornato: spostato dopo per lasciare spazio alla 5) */}
            <Section title="4. Opzioni & Documenti" icon="file" color="blue"><div className="flex flex-col md:flex-row gap-4 p-4 bg-blue-50/50 rounded-lg border border-blue-100 mb-4"><Checkbox label="Foto Tetto / Planimetria" checked={currentAudit.checkFoto || false} onChange={c => setCurrentAudit({...currentAudit, checkFoto: c})} /><Checkbox label="Ultime 3 Bollette LUCE" checked={currentAudit.checkLuce || false} onChange={c => setCurrentAudit({...currentAudit, checkLuce: c})} /><Checkbox label={`Ultime 3 Bollette GAS ${currentAudit.tipoCliente === 'Residenziale' ? '(o CI)' : ''}`} checked={currentAudit.checkGas || false} onChange={c => setCurrentAudit({...currentAudit, checkGas: c})} /></div><div className="flex gap-6 mb-4 px-2"><Checkbox label="Interesse Leasing/Finanz." checked={currentAudit.optLeasing || false} onChange={c => setCurrentAudit({...currentAudit, optLeasing: c})} /><Checkbox label="Incentivi / CER" checked={currentAudit.optIncentivi || false} onChange={c => setCurrentAudit({...currentAudit, optIncentivi: c})} /></div><Textarea label="Note Budget" value={currentAudit.budgetNote || ''} onChange={v => setCurrentAudit({...currentAudit, budgetNote: v})} placeholder="Es. Budget prefissato..." /><Input label="Link Drive" value={currentAudit.linkDrive || ''} onChange={v => setCurrentAudit({...currentAudit, linkDrive: v})} placeholder="Link Cloud..." isLink={true} /><Input label="Link Google Earth" value={currentAudit.linkGoogleEarth || ''} onChange={v => setCurrentAudit({...currentAudit, linkGoogleEarth: v})} placeholder="Link Maps/Earth..." isLink={true} /><Input label="Sito Web" value={currentAudit.linkSito || ''} onChange={v => setCurrentAudit({...currentAudit, linkSito: v})} placeholder="www..." isLink={true} /><Input label="IA" value={currentAudit.ia || ''} onChange={v => setCurrentAudit({...currentAudit, ia: v})} placeholder="Link analisi AI..." isLink={true} /><Input label="IA Link 2" value={currentAudit.ia2 || ''} onChange={v => setCurrentAudit({...currentAudit, ia2: v})} placeholder="Link analisi AI 2..." isLink={true} /><Input label="IA Link 3" value={currentAudit.ia3 || ''} onChange={v => setCurrentAudit({...currentAudit, ia3: v})} placeholder="Link analisi AI 3..." isLink={true} /><Textarea label="Note Generali / Documenti" value={currentAudit.noteOpzioni || ''} onChange={v => setCurrentAudit({...currentAudit, noteOpzioni: v})} placeholder="Note aggiuntive su documenti mancanti o dettagli..." /></Section>

            {/* 5. LA MIA PROPOSTA (NUOVO) */}
            <Section title="5. La mia proposta per il Dimensionamento" icon="zap" color="indigo"><div className="flex justify-between items-center mb-4"><span className="text-sm text-indigo-700 font-medium">Compila tu o chiedi all'AI</span><button onClick={generateAIProposal} disabled={isGenerating} className="bg-indigo-600 text-white px-3 py-1.5 rounded-lg text-xs font-bold flex items-center gap-2 hover:bg-indigo-700 shadow-sm transition disabled:opacity-50">{isGenerating ? <Loader2 size={14} className="animate-spin" /> : <Sparkles size={14} />} {isGenerating ? 'Analizzando...' : 'Genera con AI'}</button></div><div className="grid md:grid-cols-2 gap-5"><Input label="Potenza Fotovoltaico (kW)" value={currentAudit.propostaFV || ''} onChange={v => setCurrentAudit({...currentAudit, propostaFV: v})} placeholder="Es. 20 kWp (50 pannelli)" /><Input label="Accumulo (kWh)" value={currentAudit.propostaAccumulo || ''} onChange={v => setCurrentAudit({...currentAudit, propostaAccumulo: v})} placeholder="Es. 30 kWh LFP" /></div><Input label="Soluzione Termica" value={currentAudit.propostaTermico || ''} onChange={v => setCurrentAudit({...currentAudit, propostaTermico: v})} placeholder="Es. 2x Pompa di Calore ACS 300L" /><Textarea label="Note di Dimensionamento / Dettagli Tecnici" value={currentAudit.propostaNote || ''} onChange={v => setCurrentAudit({...currentAudit, propostaNote: v})} placeholder="Es. Installazione su falda sud, Inverter ibrido, Linea vita necessaria..." /></Section>
            <div className="h-10"></div>
        </div>
    </div>
  );
}

// --- UTILS & PLACEHOLDERS ---
const MenuItem = ({ icon, label, active, onClick, badge }) => (<button onClick={onClick} className={`w-full flex items-center gap-3 px-3 py-2.5 rounded-lg transition-all duration-200 ${active ? 'bg-blue-600 text-white shadow-lg shadow-blue-900/20' : 'text-slate-400 hover:text-white hover:bg-slate-800'}`}>{icon} <span className="font-medium text-sm flex-1 text-left">{label}</span> {badge && <span className="text-[10px] uppercase font-bold bg-slate-800 text-slate-300 px-1.5 py-0.5 rounded border border-slate-700">{badge}</span>}</button>);
const PlaceholderModule = ({ title, icon, desc }) => (<div className="flex flex-col items-center justify-center h-full text-center p-8 bg-white rounded-xl shadow-sm border border-slate-200"><div className="bg-slate-50 p-6 rounded-full mb-4 text-slate-400">{icon}</div><h2 className="text-2xl font-bold text-slate-800 mb-2">{title}</h2><p className="text-slate-500 max-w-md">{desc}</p></div>);
const Section = ({ title, color, children }) => { const colors = { red: 'border-l-red-500', yellow: 'border-l-yellow-500', orange: 'border-l-orange-500', blue: 'border-l-blue-500', purple: 'border-l-purple-500', green: 'border-l-green-500', indigo: 'border-l-indigo-500' }; return (<div className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden"><div className={`p-4 border-b border-slate-100 flex items-center gap-2 bg-white ${colors[color] || colors.blue} border-l-4`}><h3 className="font-bold text-slate-800">{title}</h3></div><div className="p-6 space-y-5">{children}</div></div>); };
const Input = ({ label, type = "text", value, onChange, placeholder, isLink = false }) => { const openLink = () => { if (!value) return; let url = value.trim(); if (!/^https?:\/\//i.test(url)) url = 'https://' + url; window.open(url, '_blank'); }; return (<div><label className="block text-xs font-bold text-slate-500 mb-1.5 uppercase tracking-wide">{label}</label><div className="relative"><input type={type} value={value} onChange={e => onChange(e.target.value)} placeholder={placeholder} className={`w-full p-2.5 bg-white border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition text-slate-700 ${isLink ? 'pr-10 text-blue-600 underline' : ''}`} />{isLink && value && (<button onClick={openLink} className="absolute right-2 top-1/2 transform -translate-y-1/2 text-blue-600 bg-blue-50 hover:bg-blue-100 p-1.5 rounded-md transition" type="button"><ExternalLink size={16} /></button>)}</div></div>); };
const Textarea = ({ label, value, onChange, placeholder }) => (<div><label className="block text-xs font-bold text-slate-500 mb-1.5 uppercase tracking-wide">{label}</label><textarea rows={2} value={value} onChange={e => onChange(e.target.value)} placeholder={placeholder} className="w-full p-2.5 bg-white border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition text-slate-700" /></div>);
const Select = ({ label, value, onChange, options }) => (<div><label className="block text-xs font-bold text-slate-500 mb-1.5 uppercase tracking-wide">{label}</label><div className="relative"><select value={value} onChange={e => onChange(e.target.value)} className="w-full p-2.5 bg-white border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition text-slate-700 appearance-none"><option value="">-- Seleziona --</option>{options.map(o => <option key={o} value={o}>{o}</option>)}</select><div className="absolute right-3 top-1/2 transform -translate-y-1/2 pointer-events-none text-slate-400"><svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 9l-7 7-7-7"></path></svg></div></div></div>);
const Checkbox = ({ label, checked, onChange }) => (<label className="flex items-center cursor-pointer select-none group"><div className={`w-5 h-5 rounded border flex items-center justify-center mr-3 transition ${checked ? 'bg-blue-600 border-blue-600 text-white' : 'bg-white border-slate-300 text-transparent group-hover:border-blue-400'}`}><svg className="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="3" d="M5 13l4 4L19 7"></path></svg></div><input type="checkbox" checked={checked} onChange={e => onChange(e.target.checked)} className="hidden" /><span className={`text-sm font-medium transition ${checked ? 'text-slate-800' : 'text-slate-600'}`}>{label}</span></label>);
