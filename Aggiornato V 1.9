import React, { useState, useEffect, useMemo } from 'react';
import { initializeApp } from 'firebase/app';
import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from 'firebase/auth';
import { getFirestore, collection, addDoc, updateDoc, doc, query, onSnapshot, deleteDoc, setDoc, getDoc } from 'firebase/firestore';
import { 
  Trash2, Edit, Plus, Save, Printer, Share2, Search, FileText, 
  LayoutGrid, List, Loader2, ExternalLink, Factory, Home, Trophy,
  Menu, X, PieChart, Settings, Users, LogOut, ChevronRight, ChevronLeft,
  Bell, CheckSquare, TrendingUp, DollarSign, Calendar as CalendarIcon, 
  CheckCircle2, Circle, Clock, BarChart3, Gauge, CalendarDays, AlertCircle, MapPin, Zap, Sparkles, Calculator, Flame, UserCircle, Kanban, ArrowRight, ArrowLeft,
  StickyNote, Sun, Thermometer, Box, Battery, UserCheck, Phone, Mail, Folder, Globe, Link as LinkIcon, Check, Activity, Target
} from 'lucide-react';

// --- CONFIGURAZIONE FIREBASE ---
const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
const app = Object.keys(firebaseConfig).length > 0 ? initializeApp(firebaseConfig) : null;
const auth = app ? getAuth(app) : null;
const db = app ? getFirestore(app) : null;
const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

// --- GEMINI API SETUP ---
const apiKey = ""; 

// --- COMPONENTE PRINCIPALE (LAYOUT) ---
export default function App() {
  const [user, setUser] = useState(null);
  const [loading, setLoading] = useState(true);
  const [activeModule, setActiveModule] = useState('dashboard'); 
  const [moduleData, setModuleData] = useState(null); 
  const [isSidebarOpen, setIsSidebarOpen] = useState(false);
  
  // STATO NOTIFICHE
  const [showNotifications, setShowNotifications] = useState(false);
  const [notifications, setNotifications] = useState([
      { id: 1, text: "Nuovo Lead assegnato: EcoSolar SRL", time: "10 min fa", read: false, type: 'info' },
      { id: 2, text: "Scadenza offerta: Condominio I Pini", time: "1 ora fa", read: false, type: 'alert' },
      { id: 3, text: "Audit completato per Cenisia ASD", time: "Ieri", read: true, type: 'success' }
  ]);

  // Auth Init
  useEffect(() => {
    if (!auth) {
        setLoading(false);
        return;
    }
    const initAuth = async () => {
      try {
        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
          await signInWithCustomToken(auth, __initial_auth_token);
        } else {
          await signInAnonymously(auth);
        }
      } catch (err) { console.error("Auth Error", err); }
    };
    initAuth();
    const unsubscribe = onAuthStateChanged(auth, (u) => { setUser(u); if(!u) setLoading(false); });
    return () => unsubscribe();
  }, []);

  const toggleSidebar = () => setIsSidebarOpen(!isSidebarOpen);

  const navigateToModule = (moduleName, data = null) => {
      setActiveModule(moduleName);
      setModuleData(data);
      setIsSidebarOpen(false);
  };

  const markAllRead = () => {
      setNotifications(notifications.map(n => ({...n, read: true})));
  };

  const unreadCount = notifications.filter(n => !n.read).length;

  // Mappa Titoli Moduli
  const getModuleTitle = () => {
      switch(activeModule) {
          case 'dashboard': return 'Pannello di Controllo';
          case 'pipeline': return 'Pipeline Lead';
          case 'audits': return 'Audit Manager';
          case 'audits-new': return 'Nuovo Audit';
          case 'calendar': return 'Calendario Eventi';
          case 'reminders': return 'Promemoria';
          case 'quicknotes': return 'Appunti Rapidi';
          case 'clients': return 'Gestione Clienti';
          case 'simulations': return 'Simulazioni Veloci';
          default: return 'Gestionale';
      }
  };

  if (loading) return <div className="flex h-screen items-center justify-center bg-slate-50 text-blue-600 gap-2"><Loader2 className="animate-spin" /> Caricamento Gestionale...</div>;

  return (
    <div className="flex h-screen bg-slate-100 font-sans text-slate-800 overflow-hidden">
      
      {/* SIDEBAR */}
      <aside className={`
        fixed inset-y-0 left-0 z-50 w-64 bg-[#214263] text-white transform transition-transform duration-300 ease-in-out shadow-2xl
        ${isSidebarOpen ? 'translate-x-0' : '-translate-x-full'} md:translate-x-0 md:static md:flex-shrink-0
      `}>
        <div className="h-16 flex items-center px-6 border-b border-[#1a3550] bg-[#1a3550]">
          <div className="flex items-center gap-2 font-bold text-lg tracking-tight">
            <div className="w-8 h-8 bg-blue-500 rounded-lg flex items-center justify-center text-white shadow-sm">G</div>
            <span className="text-white">Giulio Consulente</span>
          </div>
          <button onClick={toggleSidebar} className="md:hidden ml-auto text-slate-300 hover:text-white"><X size={24} /></button>
        </div>

        <nav className="p-4 space-y-2 flex-1 overflow-y-auto">
          <div className="text-xs font-bold text-green-400 uppercase tracking-wider mb-2 px-2">Panoramica</div>
          
          <MenuItem 
            icon={<Gauge size={20} />} 
            label="Pannello di Controllo" 
            active={activeModule === 'dashboard'} 
            onClick={() => navigateToModule('dashboard')} 
          />

          <MenuItem 
            icon={<Kanban size={20} />} 
            label="Pipeline Lead" 
            active={activeModule === 'pipeline'} 
            onClick={() => navigateToModule('pipeline')} 
            badge="Vendite"
          />

          <div className="mt-6 text-xs font-bold text-red-400 uppercase tracking-wider mb-2 px-2">OperativitÃ </div>

          <MenuItem 
            icon={<CalendarDays size={20} />} 
            label="Calendario" 
            active={activeModule === 'calendar'} 
            onClick={() => navigateToModule('calendar')} 
          />

          <MenuItem 
            icon={<LayoutGrid size={20} />} 
            label="Audit Manager" 
            active={activeModule === 'audits'} 
            onClick={() => navigateToModule('audits')} 
          />

          <MenuItem 
            icon={<Calculator size={20} />} 
            label="Simulazioni Veloci" 
            active={activeModule === 'simulations'} 
            onClick={() => navigateToModule('simulations')} 
          />

          <MenuItem 
            icon={<Bell size={20} />} 
            label="Promemoria" 
            active={activeModule === 'reminders'} 
            onClick={() => navigateToModule('reminders')} 
          />

          <MenuItem 
            icon={<StickyNote size={20} />} 
            label="Appunti Rapidi" 
            active={activeModule === 'quicknotes'} 
            onClick={() => navigateToModule('quicknotes')} 
          />
          
          <div className="mt-6 text-xs font-semibold text-slate-500 uppercase tracking-wider mb-2 px-2">Analisi & Config</div>

          <MenuItem 
            icon={<Users size={20} />} 
            label="Gestione Clienti" 
            active={activeModule === 'clients'} 
            onClick={() => navigateToModule('clients')} 
          />

          <MenuItem 
            icon={<PieChart size={20} />} 
            label="Calcolatore ROI" 
            active={activeModule === 'roi'} 
            onClick={() => navigateToModule('roi')} 
            badge="Presto"
          />

          <MenuItem 
            icon={<Settings size={20} />} 
            label="Impostazioni" 
            active={activeModule === 'settings'} 
            onClick={() => navigateToModule('settings')} 
          />
        </nav>

        <div className="p-4 border-t border-[#1a3550] bg-[#1a3550]">
          <div className="flex items-center gap-3">
            <div className="w-10 h-10 rounded-full bg-[#214263] flex items-center justify-center text-slate-200 border border-[#142a40]"><span className="font-bold">GC</span></div>
            <div className="flex-1 min-w-0">
              <p className="text-sm font-medium text-white truncate">Giulio C.</p>
              <p className="text-xs text-slate-300 truncate">Pro Account</p>
            </div>
          </div>
        </div>
      </aside>

      {isSidebarOpen && <div className="fixed inset-0 bg-black/50 z-40 md:hidden" onClick={toggleSidebar}></div>}

      <main className="flex-1 flex flex-col min-w-0 overflow-hidden">
        
        {/* HEADER GLOBALE (Desktop & Mobile) */}
        <header className="bg-[#161a29] h-16 flex items-center justify-between px-4 sticky top-0 z-30 shadow-md">
          <div className="flex items-center gap-3">
            <button onClick={toggleSidebar} className="md:hidden text-slate-300 hover:bg-[#1f253a] hover:text-white p-2 rounded-lg transition"><Menu size={24} /></button>
            <h1 className="font-bold text-white text-lg tracking-tight hidden md:block">{getModuleTitle()}</h1>
            <h1 className="font-bold text-white text-lg tracking-tight md:hidden">Gestionale</h1>
          </div>

          <div className="flex items-center gap-4">
             {/* CAMPANELLINA NOTIFICHE */}
             <div className="relative">
                <button 
                    onClick={() => setShowNotifications(!showNotifications)} 
                    className={`p-2 rounded-full transition relative ${showNotifications ? 'bg-[#1f253a] text-blue-400' : 'hover:bg-[#1f253a] text-slate-300 hover:text-white'}`}
                >
                    <Bell size={22} />
                    {unreadCount > 0 && (
                        <span className="absolute top-1.5 right-2 w-2.5 h-2.5 bg-red-500 rounded-full border-2 border-[#161a29] animate-pulse"></span>
                    )}
                </button>

                {/* Dropdown Notifiche */}
                {showNotifications && (
                    <>
                        <div className="fixed inset-0 z-40" onClick={() => setShowNotifications(false)}></div>
                        <div className="absolute right-0 mt-3 w-80 bg-white rounded-xl shadow-2xl border border-slate-100 overflow-hidden z-50 animate-in fade-in zoom-in duration-200 origin-top-right">
                            <div className="p-3 border-b border-slate-100 bg-slate-50/50 flex justify-between items-center backdrop-blur-sm">
                                <span className="text-xs font-bold text-slate-500 uppercase tracking-wide">Notifiche ({unreadCount})</span>
                                {unreadCount > 0 && <button onClick={markAllRead} className="text-[10px] text-blue-600 font-bold hover:underline">Segna tutte lette</button>}
                            </div>
                            <div className="max-h-[300px] overflow-y-auto custom-scrollbar">
                                {notifications.length === 0 ? (
                                    <div className="p-8 text-center text-slate-400 text-sm">Nessuna notifica.</div>
                                ) : (
                                    notifications.map(n => (
                                        <div key={n.id} className={`p-4 border-b border-slate-50 hover:bg-slate-50 transition cursor-pointer flex gap-3 relative group ${!n.read ? 'bg-blue-50/20' : ''}`}>
                                            <div className={`mt-1 w-2 h-2 rounded-full flex-shrink-0 ${!n.read ? 'bg-blue-500 shadow-sm shadow-blue-200' : 'bg-slate-200'}`}></div>
                                            <div>
                                                <p className={`text-sm leading-snug ${!n.read ? 'font-bold text-slate-800' : 'text-slate-600'}`}>{n.text}</p>
                                                <p className="text-[10px] text-slate-400 mt-1 font-medium">{n.time}</p>
                                            </div>
                                        </div>
                                    ))
                                )}
                            </div>
                            <div className="p-2 text-center border-t border-slate-100 bg-slate-50/30">
                                <button className="text-xs text-slate-500 font-bold hover:text-blue-600 transition">Vedi Tutte</button>
                            </div>
                        </div>
                    </>
                )}
             </div>
             
             {/* Avatar Utente (Piccolo) */}
             <div className="w-8 h-8 rounded-full bg-[#214263] text-white border border-[#1a3550] flex items-center justify-center text-xs font-bold md:hidden">GC</div>
          </div>
        </header>

        <div className="flex-1 overflow-y-auto p-4 md:p-8 bg-slate-50/50">
          {activeModule === 'dashboard' && <DashboardOverview user={user} appId={appId} navigateToModule={navigateToModule} />}
          {activeModule === 'pipeline' && <PipelineModule user={user} appId={appId} navigateToModule={navigateToModule} />}
          {(activeModule === 'audits' || activeModule === 'audits-new') && <AuditManager key={activeModule} user={user} appId={appId} initialMode={activeModule === 'audits-new' ? 'new' : 'list'} setActiveModule={setActiveModule} />}
          {activeModule === 'calendar' && <CalendarModule user={user} appId={appId} navigateToModule={navigateToModule} />}
          {activeModule === 'reminders' && <RemindersManager user={user} appId={appId} initialData={moduleData} />}
          {activeModule === 'quicknotes' && <QuickNotesManager user={user} appId={appId} />}
          {activeModule === 'simulations' && <QuickSimulationsModule />}
          {activeModule === 'clients' && <ClientsModule user={user} appId={appId} navigateToModule={navigateToModule} />}
          {activeModule === 'roi' && <RoiCalculatorModule />}
          
          {['settings'].includes(activeModule) && (
            <PlaceholderModule title="Modulo in Sviluppo" icon={<Settings size={48} />} desc="Questa funzionalitÃ  sarÃ  disponibile nel prossimo aggiornamento." />
          )}
        </div>
      </main>
    </div>
  );
}

// --- MODULO: CLIENTI (NUOVO LAYOUT A CARD) ---
function ClientsModule({ user, appId, navigateToModule }) {
    const [clients, setClients] = useState([]);
    const [loading, setLoading] = useState(true);
    const [searchTerm, setSearchTerm] = useState('');
    const [dialog, setDialog] = useState(null); 
    const [editingClient, setEditingClient] = useState(null); 
    const [isSaving, setIsSaving] = useState(false); 

    useEffect(() => {
        if (!user || !db) return;
        const unsubscribe = onSnapshot(collection(db, 'artifacts', appId, 'users', user.uid, 'clients'), (snapshot) => {
            const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            data.sort((a, b) => new Date(b.convertedAt || b.createdAt) - new Date(a.convertedAt || a.createdAt));
            setClients(data);
            setLoading(false);
        });
        return () => unsubscribe();
    }, [user, appId]);

    const handleDelete = async (id, companyName) => {
        setDialog({
            title: "Elimina Cliente",
            message: `Sei sicuro di voler eliminare il cliente ${companyName}? L'operazione Ã¨ irreversibile.`,
            type: 'confirm',
            onConfirm: async () => {
                setDialog(null);
                await deleteDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'clients', id));
            },
            onCancel: () => setDialog(null)
        });
    };

    const handleSaveClient = async () => {
        if (!editingClient.company) {
            setDialog({ title: "Attenzione", message: "Ragione Sociale / Cliente obbligatorio", type: 'alert', onConfirm: () => setDialog(null) });
            return;
        }
        setIsSaving(true);
        try {
            const { id, ...data } = editingClient;
            await updateDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'clients', id), data);
            setEditingClient(null);
        } catch (error) {
            console.error("Errore salvataggio", error);
            setDialog({ title: "Errore", message: "Si Ã¨ verificato un errore durante il salvataggio.", type: 'alert', onConfirm: () => setDialog(null) });
        } finally {
            setIsSaving(false);
        }
    };

    const filteredClients = clients.filter(c => 
        (c.company && c.company.toLowerCase().includes(searchTerm.toLowerCase())) ||
        (c.name && c.name.toLowerCase().includes(searchTerm.toLowerCase())) ||
        (c.city && c.city.toLowerCase().includes(searchTerm.toLowerCase()))
    );

    const formatCurrency = (amount) => {
        if (!amount) return 'â‚¬ 0';
        return new Intl.NumberFormat('it-IT', { style: 'currency', currency: 'EUR', maximumFractionDigits: 0 }).format(amount);
    };

    const openLink = (url) => {
        if (!url) return;
        let finalUrl = url.trim();
        if (!/^https?:\/\//i.test(finalUrl)) finalUrl = 'https://' + finalUrl;
        window.open(finalUrl, '_blank');
    };

    if (loading) return <div className="p-10 text-center"><Loader2 className="animate-spin mx-auto text-blue-500"/></div>;

    return (
        <div className="max-w-7xl mx-auto h-full flex flex-col space-y-6 relative">
            {/* --- RENDER MODALE CUSTOM CLIENTI --- */}
            {dialog && (
                <div className="fixed inset-0 bg-black/50 z-[100] flex items-center justify-center p-4">
                    <div className="bg-white rounded-xl p-6 max-w-sm w-full shadow-2xl animate-in fade-in zoom-in duration-200">
                        <h3 className="font-bold text-lg text-slate-800 mb-2">{dialog.title}</h3>
                        <p className="text-slate-600 mb-6 whitespace-pre-wrap">{dialog.message}</p>
                        <div className="flex justify-end gap-3">
                            {dialog.type === 'confirm' && (
                                <button onClick={dialog.onCancel} className="px-4 py-2 rounded-lg font-medium text-slate-600 hover:bg-slate-100 transition">Annulla</button>
                            )}
                            <button onClick={dialog.onConfirm} className="px-4 py-2 rounded-lg font-bold bg-blue-600 text-white hover:bg-blue-700 transition">OK</button>
                        </div>
                    </div>
                </div>
            )}
            
            {/* HEADER */}
            <div className="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-2">
                <h2 className="text-2xl font-extrabold text-slate-800 tracking-tight">Archivio Clienti ({filteredClients.length})</h2>
                <div className="relative w-full md:w-80">
                    <Search className="absolute left-3 top-1/2 transform -translate-y-1/2 text-slate-400" size={18} />
                    <input 
                        type="text" 
                        placeholder="Cerca cliente per nome..." 
                        value={searchTerm}
                        onChange={e => setSearchTerm(e.target.value)}
                        className="w-full pl-10 pr-4 py-2.5 bg-white border border-slate-200 shadow-sm rounded-xl focus:ring-2 focus:ring-blue-500 focus:outline-none transition"
                    />
                </div>
            </div>

            {/* CARDS GRID */}
            {filteredClients.length === 0 ? (
                <div className="bg-white p-12 rounded-xl shadow-sm border border-dashed border-slate-300 text-center text-slate-500">
                    <p className="text-lg font-medium">{searchTerm ? 'Nessun cliente trovato con questa ricerca.' : 'Nessun cliente in anagrafica.'}</p>
                    <p className="text-sm mt-2">Converti un Lead dalla Pipeline per iniziare a popolare l'archivio.</p>
                </div>
            ) : (
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 pb-10">
                    {filteredClients.map(client => (
                        <div key={client.id} className="bg-white rounded-2xl p-6 shadow-sm border border-slate-200 flex flex-col relative group transition-all hover:shadow-md">
                            
                            {/* Azioni Hover (Modifica / Elimina) */}
                            <div className="absolute top-4 right-4 flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                                <button onClick={() => setEditingClient({ ...client })} className="p-1.5 bg-white shadow-sm border border-slate-200 text-blue-600 hover:bg-blue-50 rounded-lg transition" title="Modifica Scheda">
                                    <Edit size={14}/>
                                </button>
                                <button onClick={() => handleDelete(client.id, client.company)} className="p-1.5 bg-white shadow-sm border border-slate-200 text-red-600 hover:bg-red-50 rounded-lg transition" title="Elimina Cliente">
                                    <Trash2 size={14}/>
                                </button>
                            </div>

                            {/* Intestazione Card */}
                            <div className="flex justify-between items-start mb-1 pr-16">
                                <h3 className="text-xl font-bold text-blue-900 leading-tight">{client.company}</h3>
                                <span className="bg-slate-100 text-slate-700 text-xs font-bold px-3 py-1 rounded-full whitespace-nowrap">
                                    {client.practiceCount || '1 Pratica'}
                                </span>
                            </div>
                            <p className="text-xs text-slate-500 font-medium mb-5">Referente: <span className="text-slate-700">{client.name || 'N/D'}</span></p>

                            {/* Contatti */}
                            <div className="space-y-2.5 text-sm text-slate-600 mb-6 flex-1">
                                <p className="flex items-center gap-2.5"><MapPin size={16} className="text-slate-400 flex-shrink-0"/> <span className="truncate">{client.address ? `${client.address}, ${client.city}` : client.city || 'Indirizzo non inserito'}</span></p>
                                <p className="flex items-center gap-2.5"><Mail size={16} className="text-slate-400 flex-shrink-0"/> <span className="truncate">{client.email || 'Email non inserita'}</span></p>
                                <p className="flex items-center gap-2.5"><Phone size={16} className="text-slate-400 flex-shrink-0"/> <span>{client.phone || 'N/D'}</span></p>
                            </div>

                            {/* Fatturato */}
                            <p className="text-sm font-bold text-slate-800 mb-6">Fatturato Cliente: {formatCurrency(client.revenue)}</p>

                            {/* Footer Pratica */}
                            <div className="pt-5 mt-auto relative">
                                {/* Dotted divider esteso */}
                                <div className="absolute top-0 left-[-24px] right-[-24px] border-t border-dashed border-slate-200"></div>
                                
                                <p className="text-[10px] font-extrabold text-slate-400 uppercase tracking-widest mb-3">Storico Pratiche:</p>
                                
                                <div className="flex justify-between items-end mb-4">
                                    <div className="min-w-0 pr-4">
                                        <p className="text-sm font-bold text-slate-800 truncate" title={client.practiceName || 'Pratica Standard'}>{client.practiceName || 'Pratica Energetica'}</p>
                                        <p className="text-[11px] text-slate-400 mt-0.5">Contratto: {client.contractDate || (client.convertedAt ? new Date(client.convertedAt).toLocaleDateString() : 'N/D')}</p>
                                    </div>
                                    <span className={`text-[11px] font-bold px-2.5 py-1 rounded-md flex-shrink-0 ${
                                        client.practiceStatus === 'In Lavorazione' ? 'bg-amber-100 text-amber-700' : 
                                        client.practiceStatus === 'Annullata' ? 'bg-red-100 text-red-700' : 
                                        'bg-emerald-100 text-emerald-700'
                                    }`}>
                                        {client.practiceStatus || 'Completato'}
                                    </span>
                                </div>

                                {/* Icone Cloud Rapide */}
                                <div className="flex gap-3 text-blue-600">
                                    {client.linkDrive && (
                                        <button onClick={() => openLink(client.linkDrive)} className="hover:text-blue-800 hover:bg-blue-50 p-1.5 rounded transition cursor-pointer" title="Apri Cartella Drive">
                                            <Folder size={18}/>
                                        </button>
                                    )}
                                    {client.linkGoogleEarth && (
                                        <button onClick={() => openLink(client.linkGoogleEarth)} className="hover:text-blue-800 hover:bg-blue-50 p-1.5 rounded transition cursor-pointer" title="Apri Google Earth / Maps">
                                            <Globe size={18}/>
                                        </button>
                                    )}
                                    {!client.linkDrive && !client.linkGoogleEarth && (
                                        <span className="text-[10px] text-slate-300 italic py-1.5">Nessun file cloud collegato</span>
                                    )}
                                </div>
                            </div>
                        </div>
                    ))}
                </div>
            )}

            {/* --- RENDER MODALE EDIT CLIENTE COMPLETO --- */}
            {editingClient && (
                <div className="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4 backdrop-blur-sm">
                    <div className="bg-white rounded-2xl p-6 w-full max-w-3xl shadow-2xl max-h-[90vh] overflow-y-auto custom-scrollbar">
                        <div className="flex justify-between items-center mb-6 border-b border-slate-100 pb-4">
                            <h3 className="font-bold text-xl text-slate-800 flex items-center gap-2"><UserCheck className="text-blue-600"/> Modifica Scheda Cliente</h3>
                            <button onClick={() => setEditingClient(null)} className="text-slate-400 hover:bg-slate-100 p-2 rounded-lg transition"><X/></button>
                        </div>
                        <div className="space-y-6">
                            
                            {/* Sezione Anagrafica */}
                            <div>
                                <p className="text-xs font-bold text-slate-400 uppercase tracking-wider mb-3">Dati Generali</p>
                                <div className="grid md:grid-cols-2 gap-4">
                                    <Input label="Ragione Sociale / Cliente" value={editingClient.company || ''} onChange={v => setEditingClient({...editingClient, company: v})} placeholder="Es. Mario Rossi SRL" />
                                    <Input label="Referente" value={editingClient.name || ''} onChange={v => setEditingClient({...editingClient, name: v})} placeholder="Nome Referente" />
                                </div>
                                <div className="grid md:grid-cols-2 gap-4 mt-4">
                                    <Input label="Telefono" value={editingClient.phone || ''} onChange={v => setEditingClient({...editingClient, phone: v})} placeholder="333..." />
                                    <Input label="Email" value={editingClient.email || ''} onChange={v => setEditingClient({...editingClient, email: v})} placeholder="email@dominio.it" />
                                </div>
                                <div className="grid md:grid-cols-2 gap-4 mt-4">
                                    <Input label="Indirizzo Impianto / Sede" value={editingClient.address || ''} onChange={v => setEditingClient({...editingClient, address: v})} placeholder="Via Roma 1..." />
                                    <Input label="CittÃ " value={editingClient.city || ''} onChange={v => setEditingClient({...editingClient, city: v})} placeholder="Es. Torino" />
                                </div>
                                <div className="grid md:grid-cols-2 gap-4 mt-4">
                                    <Input label="P.IVA / C.F." value={editingClient.vatNumber || ''} onChange={v => setEditingClient({...editingClient, vatNumber: v})} placeholder="IT..." />
                                    <Select label="Tipo Cliente" value={editingClient.type || ''} onChange={v => setEditingClient({...editingClient, type: v})} options={['Azienda', 'Residenziale', 'ASD']} />
                                </div>
                            </div>

                            {/* Sezione Commerciale / Pratica */}
                            <div className="pt-4 border-t border-slate-100">
                                <p className="text-xs font-bold text-slate-400 uppercase tracking-wider mb-3">Dati Commerciali & Storico</p>
                                <div className="grid md:grid-cols-2 gap-4">
                                    <Input label="Fatturato Pratica (â‚¬)" type="number" value={editingClient.revenue || ''} onChange={v => setEditingClient({...editingClient, revenue: v})} placeholder="Es. 9889" />
                                    <Input label="Nome Pratica (Storico)" value={editingClient.practiceName || ''} onChange={v => setEditingClient({...editingClient, practiceName: v})} placeholder="Es. PMI: FV + Accumulo + PDC" />
                                </div>
                                <div className="grid md:grid-cols-3 gap-4 mt-4">
                                    <Input label="Data Contratto" type="date" value={editingClient.contractDate || ''} onChange={v => setEditingClient({...editingClient, contractDate: v})} />
                                    <Input label="N. Pratiche" type="number" value={editingClient.practiceCount || '1'} onChange={v => setEditingClient({...editingClient, practiceCount: v})} placeholder="Es. 1" />
                                    <Select label="Stato Pratica" value={editingClient.practiceStatus || 'Completato'} onChange={v => setEditingClient({...editingClient, practiceStatus: v})} options={['Completato', 'In Lavorazione', 'Annullata']} />
                                </div>
                            </div>
                            
                            {/* Sezione Cloud */}
                            <div className="pt-4 border-t border-slate-100 bg-blue-50/30 p-4 rounded-xl border border-blue-50">
                                <p className="text-xs font-bold text-blue-600 uppercase tracking-wide mb-3 flex items-center gap-2"><Globe size={14}/> Cloud & Documenti</p>
                                <div className="space-y-4">
                                    <Input label="Link Cartella Google Drive" value={editingClient.linkDrive || ''} onChange={v => setEditingClient({...editingClient, linkDrive: v})} placeholder="Incolla il link della cartella Drive..." isLink={true} />
                                    <Input label="Link Google Earth / Maps" value={editingClient.linkGoogleEarth || ''} onChange={v => setEditingClient({...editingClient, linkGoogleEarth: v})} placeholder="Incolla il link di Google Earth..." isLink={true} />
                                </div>
                            </div>

                            {/* Footer Modal */}
                            <div className="flex justify-end gap-3 mt-8 pt-4 border-t border-slate-100">
                                <button onClick={() => setEditingClient(null)} className="px-5 py-2.5 text-slate-600 font-medium hover:bg-slate-100 rounded-lg transition">Annulla</button>
                                <button onClick={handleSaveClient} disabled={isSaving} className="flex items-center gap-2 bg-blue-600 text-white px-6 py-2.5 rounded-lg font-bold hover:bg-blue-700 transition shadow-md disabled:opacity-50">
                                    {isSaving ? <Loader2 size={18} className="animate-spin"/> : <Save size={18}/>}
                                    Salva Scheda
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            )}
        </div>
    );
}

// --- MODULO: SIMULAZIONI VELOCI ---
function QuickSimulationsModule() {
    // Stato Fotovoltaico
    const [pvInputType, setPvInputType] = useState('kw'); // 'kw' o 'mq'
    const [pvValue, setPvValue] = useState('');
    const [pvSurface, setPvSurface] = useState('inclinata'); // 'inclinata' o 'piana'
    
    // Stato PDC
    const [pdcMq, setPdcMq] = useState('');
    const [pdcInsulation, setPdcInsulation] = useState('medio'); // ottimo, medio, scarso
    const [pdcPeople, setPdcPeople] = useState('');

    // Stato Batterie
    const [batCons, setBatCons] = useState('');
    const [batProd, setBatProd] = useState('');
    const [batStrategy, setBatStrategy] = useState('autoconsumo'); // autoconsumo, backup
    const [batBackupLoad, setBatBackupLoad] = useState('');
    const [batBackupHours, setBatBackupHours] = useState('');

    // Calcoli Fotovoltaico
    const calculatePV = () => {
        const val = parseFloat(pvValue) || 0;
        if (val === 0) return { result: 0, label: '-' };
        const kInclined = 5.5; 
        const kFlat = 9.0;
        const k = pvSurface === 'inclinata' ? kInclined : kFlat;
        if (pvInputType === 'kw') {
            return { result: (val * k).toFixed(1), label: 'mq necessari' };
        } else {
            return { result: (val / k).toFixed(1), label: 'kWp installabili' };
        }
    };

    // Calcoli PDC
    const calculatePDC = () => {
        const mq = parseFloat(pdcMq) || 0;
        const people = parseInt(pdcPeople) || 0;
        if (mq === 0) return { power: 0, tank: 0 };
        let wPerMq = 75; // Medio
        if (pdcInsulation === 'ottimo') wPerMq = 35;
        if (pdcInsulation === 'scarso') wPerMq = 110;
        const powerKw = (mq * wPerMq) / 1000;
        const tankSize = people * 50; 
        return { power: powerKw.toFixed(1), tank: tankSize };
    };

    // Calcoli Batteria
    const calculateBattery = () => {
        if (batStrategy === 'autoconsumo') {
            const cons = parseFloat(batCons) || 0;
            const prod = parseFloat(batProd) || 0;
            if (cons === 0) return { cap: 0, msg: 'Inserisci consumo' };
            const nightNeed = cons * 0.5;
            const availableSolar = prod * 0.7; 
            const capacity = Math.min(nightNeed, availableSolar);
            return { cap: capacity.toFixed(1), msg: 'kWh per coprire la sera/notte' };
        } else {
            const load = parseFloat(batBackupLoad) || 0;
            const hours = parseFloat(batBackupHours) || 0;
            if (load === 0 || hours === 0) return { cap: 0, msg: 'Inserisci carico e ore' };
            return { cap: (load * hours).toFixed(1), msg: `kWh per ${hours}h di autonomia` };
        }
    };

    const pvRes = calculatePV();
    const pdcRes = calculatePDC();
    const batRes = calculateBattery();

    return (
        <div className="max-w-5xl mx-auto space-y-8">
            <div className="flex flex-col md:flex-row gap-4 justify-between items-start md:items-center">
                <div>
                    <h2 className="text-2xl font-bold text-slate-800 flex items-center gap-2"><Calculator className="text-blue-600" size={28} /> Simulazioni Veloci</h2>
                    <p className="text-slate-500">Strumenti rapidi per dimensionamento in tempo reale.</p>
                </div>
            </div>

            <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
                
                {/* CALCOLATORE FOTOVOLTAICO */}
                <div className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                    <div className="bg-orange-50 p-4 border-b border-orange-100 flex items-center gap-2">
                        <Sun className="text-orange-500" />
                        <h3 className="font-bold text-slate-800">Dimensionamento Fotovoltaico</h3>
                    </div>
                    <div className="p-6 space-y-6">
                        <div className="flex bg-slate-100 p-1 rounded-lg">
                            <button onClick={() => setPvInputType('kw')} className={`flex-1 py-2 rounded-md text-sm font-bold transition ${pvInputType === 'kw' ? 'bg-white text-orange-600 shadow-sm' : 'text-slate-500 hover:text-slate-700'}`}>Ho i kW, cerco i Mq</button>
                            <button onClick={() => setPvInputType('mq')} className={`flex-1 py-2 rounded-md text-sm font-bold transition ${pvInputType === 'mq' ? 'bg-white text-orange-600 shadow-sm' : 'text-slate-500 hover:text-slate-700'}`}>Ho i Mq, cerco i kW</button>
                        </div>
                        <div className="grid grid-cols-2 gap-4">
                            <div>
                                <label className="block text-xs font-bold text-slate-500 uppercase mb-2">Superficie</label>
                                <div className="flex flex-col gap-2">
                                    <label className={`flex items-center gap-2 p-3 rounded-lg border cursor-pointer transition ${pvSurface === 'inclinata' ? 'bg-orange-50 border-orange-300 text-orange-800' : 'border-slate-200 hover:bg-slate-50'}`}>
                                        <input type="radio" name="surf" className="hidden" checked={pvSurface === 'inclinata'} onChange={() => setPvSurface('inclinata')} />
                                        <div className="w-4 h-4 rounded-full border border-current flex items-center justify-center">{pvSurface === 'inclinata' && <div className="w-2 h-2 bg-current rounded-full"/>}</div>
                                        <span className="font-bold text-sm">Inclinata (30-35Â°)</span>
                                    </label>
                                    <label className={`flex items-center gap-2 p-3 rounded-lg border cursor-pointer transition ${pvSurface === 'piana' ? 'bg-orange-50 border-orange-300 text-orange-800' : 'border-slate-200 hover:bg-slate-50'}`}>
                                        <input type="radio" name="surf" className="hidden" checked={pvSurface === 'piana'} onChange={() => setPvSurface('piana')} />
                                        <div className="w-4 h-4 rounded-full border border-current flex items-center justify-center">{pvSurface === 'piana' && <div className="w-2 h-2 bg-current rounded-full"/>}</div>
                                        <span className="font-bold text-sm">Piana (Lastrico)</span>
                                    </label>
                                </div>
                            </div>
                            <div>
                                <label className="block text-xs font-bold text-slate-500 uppercase mb-2">{pvInputType === 'kw' ? 'Potenza Desiderata (kW)' : 'Spazio Disponibile (mq)'}</label>
                                <input type="number" value={pvValue} onChange={(e) => setPvValue(e.target.value)} className="w-full p-3 border border-slate-300 rounded-lg text-lg font-bold text-slate-800 focus:ring-2 focus:ring-orange-500 outline-none" placeholder="0" />
                            </div>
                        </div>
                        <div className="bg-orange-600 text-white p-6 rounded-xl text-center shadow-lg transform transition hover:scale-[1.02]">
                            <p className="text-orange-100 text-sm uppercase font-bold mb-1">Risultato Stima</p>
                            <div className="text-4xl font-extrabold">{pvRes.result} <span className="text-xl">{pvInputType === 'kw' ? 'mq' : 'kWp'}</span></div>
                            <p className="text-xs opacity-80 mt-2">{pvInputType === 'kw' ? `Spazio stimato per ${pvValue || 0} kW` : `Potenza stimata su ${pvValue || 0} mq`}</p>
                        </div>
                    </div>
                </div>

                {/* CALCOLATORE BATTERIE */}
                <div className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                    <div className="bg-green-50 p-4 border-b border-green-100 flex items-center gap-2">
                        <Battery className="text-green-600" />
                        <h3 className="font-bold text-slate-800">Dimensionamento Batterie</h3>
                    </div>
                    
                    <div className="p-4 bg-green-50/30 text-xs text-slate-600 border-b border-green-50 leading-relaxed">
                        <p className="font-bold mb-1">ðŸ’¡ Guida Rapida:</p>
                        <ul className="list-disc pl-4 space-y-1">
                            <li>Parti sempre dai <strong>kWh</strong>, non dai kW.</li>
                            <li>Definisci l'obiettivo: <strong>Autoconsumo</strong> o <strong>Backup</strong>.</li>
                            <li>Tetto piano o inclinato non cambia la capacitÃ  in kWh, ma solo la produzione FV disponibile.</li>
                        </ul>
                    </div>

                    <div className="p-6 space-y-6">
                        <div>
                            <label className="block text-xs font-bold text-slate-500 uppercase mb-2">Strategia</label>
                            <div className="flex bg-slate-100 p-1 rounded-lg">
                                <button onClick={() => setBatStrategy('autoconsumo')} className={`flex-1 py-2 rounded-md text-sm font-bold transition ${batStrategy === 'autoconsumo' ? 'bg-white text-green-600 shadow-sm' : 'text-slate-500 hover:text-slate-700'}`}>Autoconsumo</button>
                                <button onClick={() => setBatStrategy('backup')} className={`flex-1 py-2 rounded-md text-sm font-bold transition ${batStrategy === 'backup' ? 'bg-white text-green-600 shadow-sm' : 'text-slate-500 hover:text-slate-700'}`}>Backup / Blackout</button>
                            </div>
                        </div>

                        {batStrategy === 'autoconsumo' ? (
                            <div className="grid grid-cols-2 gap-4">
                                <div>
                                    <label className="block text-xs font-bold text-slate-500 uppercase mb-2">Consumo Medio (kWh/gg)</label>
                                    <input type="number" value={batCons} onChange={(e) => setBatCons(e.target.value)} className="w-full p-3 border border-slate-300 rounded-lg text-slate-800 focus:ring-2 focus:ring-green-500 outline-none" placeholder="Es. 15" />
                                </div>
                                <div>
                                    <label className="block text-xs font-bold text-slate-500 uppercase mb-2">Prod. FV Stimata (kWh/gg)</label>
                                    <input type="number" value={batProd} onChange={(e) => setBatProd(e.target.value)} className="w-full p-3 border border-slate-300 rounded-lg text-slate-800 focus:ring-2 focus:ring-green-500 outline-none" placeholder="Es. 20" />
                                </div>
                            </div>
                        ) : (
                            <div className="grid grid-cols-2 gap-4">
                                <div>
                                    <label className="block text-xs font-bold text-slate-500 uppercase mb-2">Carico Critico (kW)</label>
                                    <input type="number" value={batBackupLoad} onChange={(e) => setBatBackupLoad(e.target.value)} className="w-full p-3 border border-slate-300 rounded-lg text-slate-800 focus:ring-2 focus:ring-green-500 outline-none" placeholder="Es. 3 kW" />
                                </div>
                                <div>
                                    <label className="block text-xs font-bold text-slate-500 uppercase mb-2">Ore Autonomia (h)</label>
                                    <input type="number" value={batBackupHours} onChange={(e) => setBatBackupHours(e.target.value)} className="w-full p-3 border border-slate-300 rounded-lg text-slate-800 focus:ring-2 focus:ring-green-500 outline-none" placeholder="Es. 4 h" />
                                </div>
                            </div>
                        )}

                        <div className="bg-green-600 text-white p-6 rounded-xl text-center shadow-lg transform transition hover:scale-[1.02]">
                            <p className="text-green-100 text-sm uppercase font-bold mb-1">CapacitÃ  Consigliata</p>
                            <div className="text-4xl font-extrabold">{batRes.cap} <span className="text-xl">kWh</span></div>
                            <p className="text-xs opacity-80 mt-2">{batRes.msg}</p>
                        </div>
                    </div>
                </div>

                {/* CALCOLATORE PDC */}
                <div className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden lg:col-span-2">
                    <div className="bg-blue-50 p-4 border-b border-blue-100 flex items-center gap-2">
                        <Thermometer className="text-blue-500" />
                        <h3 className="font-bold text-slate-800">Dimensionamento Pompa di Calore</h3>
                    </div>
                    <div className="p-6 space-y-6">
                        <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <div className="col-span-1">
                                <label className="block text-xs font-bold text-slate-500 uppercase mb-2">Mq</label>
                                <input type="number" value={pdcMq} onChange={(e) => setPdcMq(e.target.value)} className="w-full p-3 border border-slate-300 rounded-lg text-lg font-bold text-slate-800 focus:ring-2 focus:ring-blue-500 outline-none" placeholder="120" />
                            </div>
                            <div className="col-span-1">
                                <label className="block text-xs font-bold text-slate-500 uppercase mb-2">Persone</label>
                                <input type="number" value={pdcPeople} onChange={(e) => setPdcPeople(e.target.value)} className="w-full p-3 border border-slate-300 rounded-lg text-lg font-bold text-slate-800 focus:ring-2 focus:ring-blue-500 outline-none" placeholder="4" />
                            </div>
                            <div className="col-span-2">
                                <label className="block text-xs font-bold text-slate-500 uppercase mb-2">Isolamento</label>
                                <div className="grid grid-cols-3 gap-2">
                                    <button onClick={() => setPdcInsulation('ottimo')} className={`p-2 rounded-lg border text-xs font-bold transition ${pdcInsulation === 'ottimo' ? 'bg-green-100 border-green-300 text-green-800' : 'border-slate-200 hover:bg-slate-50 text-slate-600'}`}>Ottimo (A)</button>
                                    <button onClick={() => setPdcInsulation('medio')} className={`p-2 rounded-lg border text-xs font-bold transition ${pdcInsulation === 'medio' ? 'bg-yellow-100 border-yellow-300 text-yellow-800' : 'border-slate-200 hover:bg-slate-50 text-slate-600'}`}>Medio</button>
                                    <button onClick={() => setPdcInsulation('scarso')} className={`p-2 rounded-lg border text-xs font-bold transition ${pdcInsulation === 'scarso' ? 'bg-red-100 border-red-300 text-red-800' : 'border-slate-200 hover:bg-slate-50 text-slate-600'}`}>Scarso (G)</button>
                                </div>
                            </div>
                        </div>

                        <div className="grid grid-cols-2 gap-4">
                            <div className="bg-blue-600 text-white p-4 rounded-xl text-center shadow-md">
                                <p className="text-blue-100 text-[10px] uppercase font-bold mb-1">Potenza Termica</p>
                                <div className="text-2xl font-extrabold">{pdcRes.power} <span className="text-lg">kW</span></div>
                            </div>
                            <div className="bg-cyan-600 text-white p-4 rounded-xl text-center shadow-md">
                                <p className="text-cyan-100 text-[10px] uppercase font-bold mb-1">Accumulo ACS</p>
                                <div className="text-2xl font-extrabold">{pdcRes.tank} <span className="text-lg">L</span></div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    );
}

// --- MODULO: QUICK NOTES MANAGER (FULL PAGE) ---
function QuickNotesManager({ user, appId }) {
    const [notes, setNotes] = useState([]);
    const [newNote, setNewNote] = useState('');
    const [isAdding, setIsAdding] = useState(false);
    const [editingId, setEditingId] = useState(null);
    const [loading, setLoading] = useState(true);

    useEffect(() => {
        if (!user || !db) return;
        const q = query(collection(db, 'artifacts', appId, 'users', user.uid, 'quicknotes'));
        const unsubscribe = onSnapshot(q, (snapshot) => {
            const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            data.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
            setNotes(data);
            setLoading(false);
        });
        return () => unsubscribe();
    }, [user]);

    const handleSaveNote = async (e) => {
        e.preventDefault();
        if (!newNote.trim()) return;
        setIsAdding(true);
        try {
            if (editingId) {
                await updateDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'quicknotes', editingId), {
                    text: newNote,
                    updatedAt: new Date().toISOString()
                });
                setEditingId(null);
            } else {
                await addDoc(collection(db, 'artifacts', appId, 'users', user.uid, 'quicknotes'), {
                    text: newNote,
                    createdAt: new Date().toISOString()
                });
            }
            setNewNote('');
        } catch (error) { console.error("Errore nota", error); } finally { setIsAdding(false); }
    };

    const startEdit = (note) => { setNewNote(note.text); setEditingId(note.id); window.scrollTo({ top: 0, behavior: 'smooth' }); };
    const handleDeleteNote = async (id) => { if (editingId === id) { setEditingId(null); setNewNote(''); } await deleteDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'quicknotes', id)); };

    if (loading) return <div className="text-center p-10 text-slate-500">Caricamento Appunti...</div>;

    return (
        <div className="max-w-5xl mx-auto space-y-6">
            <div className="bg-white p-8 rounded-xl shadow-sm border border-slate-200">
                <div className="mb-8 flex items-center justify-between">
                    <div>
                        <h2 className="text-2xl font-bold text-slate-800 flex items-center gap-2"><StickyNote className="text-yellow-500" size={24} /> Appunti Rapidi</h2>
                        <p className="text-slate-500 mt-1">Spazio libero per note veloci, idee e appunti da sopralluogo.</p>
                    </div>
                </div>

                <form onSubmit={handleSaveNote} className="mb-8 relative bg-yellow-50/50 p-6 rounded-xl border border-yellow-200">
                    <label className="block text-xs font-bold text-yellow-700 uppercase mb-2">{editingId ? 'Modifica Appunto' : 'Nuovo Appunto'}</label>
                    <textarea 
                        value={newNote}
                        onChange={(e) => setNewNote(e.target.value)}
                        onKeyDown={(e) => { if(e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); handleSaveNote(e); } }}
                        placeholder="Scrivi qui..."
                        className="w-full bg-white border border-yellow-300 rounded-lg p-4 text-base focus:outline-none focus:ring-2 focus:ring-yellow-400 placeholder:text-slate-400 resize-none min-h-[120px] shadow-sm"
                    />
                    <div className="flex justify-end gap-2 mt-3">
                        {editingId && (
                            <button type="button" onClick={() => { setEditingId(null); setNewNote(''); }} className="bg-white hover:bg-slate-50 text-slate-600 px-4 py-2 rounded-lg font-medium transition shadow-sm border border-slate-200 flex items-center gap-2">
                                <X size={18} /> Annulla
                            </button>
                        )}
                        <button type="submit" disabled={isAdding || !newNote.trim()} className="bg-yellow-500 hover:bg-yellow-600 text-white px-6 py-2 rounded-lg font-bold transition shadow-md disabled:opacity-50 flex items-center gap-2">
                            {isAdding ? <Loader2 size={18} className="animate-spin"/> : (editingId ? <><Save size={18}/> Salva Modifiche</> : <><Plus size={18}/> Aggiungi Nota</>)}
                        </button>
                    </div>
                </form>

                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    {notes.length === 0 && <div className="col-span-full text-center py-12 text-slate-400 border-2 border-dashed border-slate-100 rounded-xl">Nessun appunto presente.</div>}
                    {notes.map(note => (
                        <div key={note.id} className={`group flex flex-col justify-between p-5 bg-white rounded-xl border shadow-sm hover:shadow-md transition relative ${editingId === note.id ? 'border-blue-400 ring-2 ring-blue-50' : 'border-slate-200'}`}>
                            <div>
                                <p className="text-slate-800 whitespace-pre-wrap leading-relaxed text-sm mb-4">{note.text}</p>
                            </div>
                            <div className="flex items-center justify-between pt-4 border-t border-slate-50 mt-auto">
                                <span className="text-xs font-medium text-slate-400 bg-slate-50 px-2 py-1 rounded">
                                    {new Date(note.createdAt).toLocaleDateString()} {new Date(note.createdAt).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}
                                </span>
                                <div className="flex gap-1">
                                    <button onClick={() => startEdit(note)} className="p-2 text-slate-400 hover:text-blue-600 hover:bg-blue-50 rounded-lg transition" title="Modifica"><Edit size={16} /></button>
                                    <button onClick={() => handleDeleteNote(note.id)} className="p-2 text-slate-400 hover:text-red-600 hover:bg-red-50 rounded-lg transition" title="Elimina"><Trash2 size={16} /></button>
                                </div>
                            </div>
                        </div>
                    ))}
                </div>
            </div>
        </div>
    );
}

// --- WIDGET: APPUNTI RAPIDI (DASHBOARD) ---
function QuickNotesWidget({ user, appId }) {
    const [notes, setNotes] = useState([]);
    const [newNote, setNewNote] = useState('');
    const [isAdding, setIsAdding] = useState(false);
    const [editingId, setEditingId] = useState(null);

    useEffect(() => {
        if (!user || !db) return;
        const q = query(collection(db, 'artifacts', appId, 'users', user.uid, 'quicknotes'));
        const unsubscribe = onSnapshot(q, (snapshot) => {
            const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            data.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
            setNotes(data);
        });
        return () => unsubscribe();
    }, [user]);

    const handleSaveNote = async (e) => {
        e.preventDefault();
        if (!newNote.trim()) return;
        setIsAdding(true);
        try {
            if (editingId) {
                await updateDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'quicknotes', editingId), {
                    text: newNote,
                    updatedAt: new Date().toISOString()
                });
                setEditingId(null);
            } else {
                await addDoc(collection(db, 'artifacts', appId, 'users', user.uid, 'quicknotes'), {
                    text: newNote,
                    createdAt: new Date().toISOString()
                });
            }
            setNewNote('');
        } catch (error) { console.error("Errore nota", error); } finally { setIsAdding(false); }
    };

    const startEdit = (note) => { setNewNote(note.text); setEditingId(note.id); };
    const handleDeleteNote = async (id) => { if (editingId === id) { setEditingId(null); setNewNote(''); } await deleteDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'quicknotes', id)); };

    return (
        <div className="bg-white rounded-xl shadow-sm border border-slate-200 p-6 h-full flex flex-col">
             <div className="flex justify-between items-center mb-4">
                 <h3 className="font-bold text-lg text-slate-800 flex items-center gap-2"><StickyNote className="text-yellow-500" size={20} /> Appunti Rapidi</h3>
                 <span className="text-xs text-slate-400 font-medium">{notes.length} note</span>
             </div>

             <div className="flex flex-col md:flex-row gap-6 flex-1 min-h-0">
                 {/* SINISTRA: INPUT FORM */}
                 <div className="w-full md:w-1/3 flex flex-col">
                     <form onSubmit={handleSaveNote} className="relative flex-1 flex flex-col">
                        <textarea 
                            value={newNote}
                            onChange={(e) => setNewNote(e.target.value)}
                            onKeyDown={(e) => { if(e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); handleSaveNote(e); } }}
                            placeholder={editingId ? "Modifica appunto..." : "Scrivi nota veloce..."}
                            className={`w-full h-full bg-slate-50 border rounded-xl p-4 text-sm focus:outline-none focus:ring-2 focus:ring-yellow-400/50 resize-none transition text-slate-700 min-h-[120px] ${editingId ? 'border-blue-300 ring-blue-100' : 'border-slate-200'}`}
                        />
                        <div className="absolute bottom-3 right-3 flex gap-2">
                            {editingId && (
                                <button type="button" onClick={() => { setEditingId(null); setNewNote(''); }} className="bg-white hover:bg-slate-100 text-slate-500 p-2 rounded-lg transition shadow-sm border border-slate-200"><X size={16} /></button>
                            )}
                            <button type="submit" disabled={isAdding || !newNote.trim()} className={`p-2 rounded-lg transition shadow-md disabled:opacity-50 flex items-center justify-center ${editingId ? 'bg-blue-600 hover:bg-blue-700 text-white' : 'bg-yellow-400 hover:bg-yellow-500 text-yellow-900'}`}>
                                {isAdding ? <Loader2 size={16} className="animate-spin"/> : (editingId ? <Save size={16} /> : <Plus size={16} />)}
                            </button>
                        </div>
                     </form>
                 </div>

                 {/* DESTRA: GRIGLIA NOTE */}
                 <div className="flex-1 overflow-y-auto custom-scrollbar pr-1">
                     <div className="grid grid-cols-1 gap-3">
                         {notes.length === 0 && (
                            <div className="col-span-full flex flex-col items-center justify-center text-slate-400 h-32 border-2 border-dashed border-slate-100 rounded-xl">
                                <StickyNote size={24} className="mb-2 opacity-30"/>
                                <p className="text-xs">Nessun appunto recente.</p>
                            </div>
                         )}
                         {notes.map(note => (
                             <div key={note.id} className="flex flex-col justify-between p-3 bg-yellow-50/30 border border-yellow-100 rounded-xl group hover:border-yellow-300 hover:shadow-sm transition relative h-full min-h-[100px]">
                                 <div className="mb-2">
                                     <p className="font-bold text-slate-800 text-sm break-words leading-snug whitespace-pre-wrap">{note.text}</p>
                                 </div>
                                 <div className="flex items-end justify-between mt-auto pt-2 border-t border-yellow-100/50">
                                     <span className="text-[10px] text-slate-400 font-medium">
                                        {new Date(note.createdAt).toLocaleDateString()}
                                     </span>
                                     <div className="flex items-center gap-1 opacity-0 group-hover:opacity-100 transition">
                                         <button onClick={() => startEdit(note)} className="p-1.5 text-slate-400 hover:text-blue-600 hover:bg-blue-50 rounded transition"><Edit size={14} /></button>
                                         <button onClick={() => handleDeleteNote(note.id)} className="p-1.5 text-slate-400 hover:text-red-600 hover:bg-red-50 rounded transition"><Trash2 size={14} /></button>
                                     </div>
                                 </div>
                             </div>
                         ))}
                     </div>
                 </div>
             </div>
        </div>
    );
}

// --- WIDGET: LINK DIMENSIONAMENTO ---
function SizingLinksWidget({ user, appId }) {
    const [links, setLinks] = useState([
        { id: 'link1', name: 'Portale GSE', url: 'https://www.gse.it' },
        { id: 'link2', name: 'PVGIS', url: 'https://re.jrc.ec.europa.eu/pvg_tools/en/' },
        { id: 'link3', name: 'Clima Pro (ENEA)', url: 'https://www.efficienzaenergetica.enea.it/' },
        { id: 'link4', name: 'Simulatore Autoconsumo GSE', url: 'https://www.autoconsumo.gse.it/' },
        { id: 'link5', name: '', url: '' }
    ]);
    const [isEditing, setIsEditing] = useState(false);
    const [loading, setLoading] = useState(true);

    useEffect(() => {
        if (!user || !db) return;
        const fetchLinks = async () => {
            try {
                const docRef = doc(db, 'artifacts', appId, 'users', user.uid, 'settings', 'dashboardLinks');
                const docSnap = await getDoc(docRef);
                if (docSnap.exists() && docSnap.data().links) {
                    let fetchedLinks = docSnap.data().links;
                    // Assicura che ci siano sempre 5 slot disponibili
                    while(fetchedLinks.length < 5) {
                        fetchedLinks.push({ id: `link${fetchedLinks.length + 1}`, name: '', url: '' });
                    }
                    setLinks(fetchedLinks);
                }
            } catch (err) {
                console.error("Errore fetch link", err);
            } finally {
                setLoading(false);
            }
        };
        fetchLinks();
    }, [user, appId]);

    const handleSave = async () => {
        try {
            await setDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'settings', 'dashboardLinks'), { links }, { merge: true });
            setIsEditing(false);
        } catch (error) {
            console.error("Errore salvataggio link", error);
        }
    };

    const handleLinkChange = (index, field, value) => {
        const newLinks = [...links];
        newLinks[index][field] = value;
        setLinks(newLinks);
    };

    const openLink = (url) => {
        if (!url) return;
        let finalUrl = url.trim();
        if (!/^https?:\/\//i.test(finalUrl)) finalUrl = 'https://' + finalUrl;
        window.open(finalUrl, '_blank');
    };

    if (loading) return <div className="h-full flex items-center justify-center bg-white rounded-xl border border-slate-200"><Loader2 className="animate-spin text-blue-500"/></div>;

    return (
        <div className="bg-white rounded-xl shadow-sm border border-slate-200 p-6 flex flex-col h-full">
            <div className="flex justify-between items-center mb-5">
                <h3 className="font-bold text-lg text-[#1a2b3c] flex items-center gap-2">
                    <ExternalLink size={20} className="text-blue-600" strokeWidth={2.5}/> Link Dimensionamento
                </h3>
                <button 
                    onClick={() => isEditing ? handleSave() : setIsEditing(true)} 
                    className={`p-1.5 rounded-lg transition ${isEditing ? 'bg-blue-600 text-white hover:bg-blue-700' : 'text-slate-400 hover:text-slate-600 hover:bg-slate-50'}`}
                >
                    {isEditing ? <Check size={18}/> : <Settings size={18}/>}
                </button>
            </div>
            
            <div className="space-y-3 flex-1">
                {links.map((link, i) => (
                    <div key={link.id}>
                        {isEditing ? (
                            <div className="flex gap-2">
                                <input 
                                    type="text" 
                                    value={link.name} 
                                    onChange={(e) => handleLinkChange(i, 'name', e.target.value)} 
                                    placeholder="Nome Link"
                                    className="w-2/5 text-sm p-2.5 border border-slate-200 bg-slate-50 rounded-lg focus:bg-white focus:ring-2 focus:ring-blue-500 outline-none font-medium text-slate-700"
                                />
                                <input 
                                    type="text" 
                                    value={link.url} 
                                    onChange={(e) => handleLinkChange(i, 'url', e.target.value)} 
                                    placeholder="https://..."
                                    className="flex-1 text-sm p-2.5 border border-slate-200 bg-slate-50 rounded-lg focus:bg-white focus:ring-2 focus:ring-blue-500 outline-none text-slate-500"
                                />
                            </div>
                        ) : (
                            link.name ? (
                                <button 
                                    onClick={() => openLink(link.url)}
                                    className="w-full flex items-center justify-between p-3.5 rounded-xl bg-[#f8fafc] border border-slate-100 text-[#1a2b3c] hover:bg-slate-100 hover:border-slate-200 transition group shadow-sm"
                                >
                                    <span className="font-bold text-sm tracking-tight">{link.name}</span>
                                    <ExternalLink size={18} className="text-slate-400 group-hover:text-slate-600 transition" strokeWidth={2}/>
                                </button>
                            ) : (
                                <div className="w-full flex items-center justify-center p-3.5 rounded-xl border border-dashed border-slate-300 bg-white">
                                    <span className="text-sm text-slate-400 italic">Slot vuoto (modifica per aggiungere)</span>
                                </div>
                            )
                        )}
                    </div>
                ))}
            </div>
        </div>
    );
}

// --- MODULO: DASHBOARD OVERVIEW ---
function DashboardOverview({ user, appId, navigateToModule }) {
    const [stats, setStats] = useState({ audits: 0, pipeline: 0, reminders: 0, quickNotes: 0, clients: 0, recentAudits: [], recentReminders: [], nextEvents: [] });
    const [loading, setLoading] = useState(true);

    useEffect(() => {
        if (!user || !db) return;

        // FETCH AUDITS (NO ORDERBY)
        const unsubAudits = onSnapshot(collection(db, 'artifacts', appId, 'users', user.uid, 'audits'), (snap) => {
            const auditData = snap.docs.map(d => ({...d.data(), id: d.id, type: 'audit'}));
            auditData.sort((a, b) => {
                const dateA = a.dataRilievo || '1970-01-01';
                const dateB = b.dataRilievo || '1970-01-01';
                return new Date(dateB) - new Date(dateA);
            });
            
            setStats(prev => ({ ...prev, audits: snap.size, recentAudits: auditData.slice(0, 3) }));
            updateNextEvents(auditData, null); 
        });

        // FETCH OPPORTUNITIES
        const unsubOpps = onSnapshot(collection(db, 'artifacts', appId, 'users', user.uid, 'leads'), (snap) => {
            setStats(prev => ({ ...prev, pipeline: snap.size }));
        });

        // FETCH CLIENTS (NUOVO)
        const unsubClients = onSnapshot(collection(db, 'artifacts', appId, 'users', user.uid, 'clients'), (snap) => {
            setStats(prev => ({ ...prev, clients: snap.size }));
        });

        // FETCH REMINDERS
        const unsubReminders = onSnapshot(collection(db, 'artifacts', appId, 'users', user.uid, 'reminders'), (snap) => {
            const allReminders = snap.docs.map(d => ({id: d.id, ...d.data()}));
            const activeReminders = allReminders
                .filter(r => !r.completed)
                .sort((a, b) => (a.dueDate || '9999-99-99').localeCompare(b.dueDate || '9999-99-99'));
            setStats(prev => ({ ...prev, reminders: activeReminders.length, recentReminders: activeReminders.slice(0, 5) }));
        });

        // FETCH QUICK NOTES
        const unsubNotes = onSnapshot(collection(db, 'artifacts', appId, 'users', user.uid, 'quicknotes'), (snap) => {
            setStats(prev => ({ ...prev, quickNotes: snap.size }));
        });

        // FETCH APPOINTMENTS
        const unsubAppts = onSnapshot(collection(db, 'artifacts', appId, 'users', user.uid, 'appointments'), (snap) => {
            const apptData = snap.docs.map(d => ({...d.data(), id: d.id, type: 'appuntamento'}));
            updateNextEvents(null, apptData);
        });

        let cachedAudits = [];
        let cachedAppts = [];
        
        const updateNextEvents = (newAudits, newAppts) => {
            if (newAudits) cachedAudits = newAudits;
            if (newAppts) cachedAppts = newAppts;

            const today = new Date().toISOString().split('T')[0];
            
            // Logica Aggiornata: Mappa sia Rilievi che Incontri
            const auditEvents = cachedAudits.flatMap(a => {
                const events = [];
                // 1. Evento Rilievo (Verde)
                if (a.dataRilievo) {
                    events.push({ 
                        id: `${a.id}_rilievo`, 
                        title: `ðŸ” Rilievo: ${a.nomeSocieta || 'Senza Nome'}`, 
                        date: a.dataRilievo, 
                        time: '09:00', // Default per rilievo se non specificato (o aggiungibile in futuro)
                        type: 'audit', 
                        color: 'bg-green-50 text-green-700' 
                    });
                }
                // 2. Evento Prossimo Incontro (Viola)
                if (a.prossimoIncontro) {
                    events.push({ 
                        id: `${a.id}_incontro`, 
                        title: `ðŸ¤ Incontro: ${a.nomeSocieta || 'Senza Nome'}`, 
                        date: a.prossimoIncontro, 
                        time: a.oraIncontro || '09:00', // ORA DINAMICA COLLEGATA AL CAMPO
                        type: 'meeting', 
                        color: 'bg-purple-50 text-purple-700' 
                    });
                }
                return events;
            });

            const allEvents = [
                ...auditEvents,
                ...(cachedAppts || []).map(a => ({ 
                    id: a.id, 
                    title: `ðŸ“… ${a.title || 'Appuntamento'}`, 
                    date: a.date || today, 
                    time: a.time || '09:00', 
                    type: 'appt', 
                    color: 'bg-blue-50 text-blue-700' 
                }))
            ];

            const upcoming = allEvents
                .filter(e => e.date >= today)
                .sort((a, b) => {
                    if (a.date !== b.date) return a.date.localeCompare(b.date);
                    return (a.time || '00:00').localeCompare(b.time || '00:00');
                })
                .slice(0, 5); 

            setStats(prev => ({ ...prev, nextEvents: upcoming }));
            setLoading(false);
        };
        return () => { unsubAudits(); unsubOpps(); unsubReminders(); unsubNotes(); unsubAppts(); unsubClients(); };
    }, [user]);

    const toggleReminder = async (id, currentStatus) => { await updateDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'reminders', id), { completed: !currentStatus }); };
    const deleteReminder = async (id) => { await deleteDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'reminders', id)); };
    const getPriorityStyle = (priority) => { switch(priority) { case 'red': return 'bg-red-50 border-red-100 text-red-700'; case 'green': return 'bg-green-50 border-green-100 text-green-700'; default: return 'bg-blue-50 border-blue-100 text-blue-700'; } };

    if (loading) return <div className="p-8 text-center text-slate-500">Caricamento KPI...</div>;

    return (
        <div className="space-y-8">
            <div className="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                <div><h1 className="text-2xl md:text-3xl font-bold text-slate-800">Bentornato, Giulio! ðŸ‘‹</h1><p className="text-slate-500">Ecco il polso della situazione.</p></div>
                <div className="flex gap-2">
                    <button onClick={() => navigateToModule('audits-new')} className="bg-blue-600 text-white px-4 py-2 rounded-lg font-bold shadow-md hover:bg-blue-700 flex items-center gap-2"><Plus size={18} /> Nuovo Audit</button>
                </div>
            </div>
            
            {/* KPI CARDS - TOP ROW */}
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-5 gap-6">
                <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-200 flex items-center justify-between group hover:border-blue-300 transition cursor-pointer" onClick={() => navigateToModule('pipeline')}><div><p className="text-sm font-bold text-slate-500 uppercase tracking-wide">Lead in Pipeline</p><p className="text-2xl font-bold text-slate-800 mt-1">{stats.pipeline}</p></div><div className="bg-blue-50 p-3 rounded-lg text-blue-600 group-hover:bg-blue-100 transition"><TrendingUp size={24} /></div></div>
                
                {/* WIDGET CLIENTI (NUOVO) */}
                <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-200 flex items-center justify-between group hover:border-indigo-300 transition cursor-pointer" onClick={() => navigateToModule('clients')}><div><p className="text-sm font-bold text-slate-500 uppercase tracking-wide">Clienti Attivi</p><p className="text-2xl font-bold text-slate-800 mt-1">{stats.clients}</p></div><div className="bg-indigo-50 p-3 rounded-lg text-indigo-600 group-hover:bg-indigo-100 transition"><Users size={24} /></div></div>

                <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-200 flex items-center justify-between group hover:border-green-300 transition cursor-pointer" onClick={() => navigateToModule('audits')}><div><p className="text-sm font-bold text-slate-500 uppercase tracking-wide">Audit Totali</p><p className="text-2xl font-bold text-slate-800 mt-1">{stats.audits}</p></div><div className="bg-green-50 p-3 rounded-lg text-green-600 group-hover:bg-green-100 transition"><LayoutGrid size={24} /></div></div>
                <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-200 flex items-center justify-between group hover:border-orange-300 transition cursor-pointer" onClick={() => navigateToModule('reminders')}><div><p className="text-sm font-bold text-slate-500 uppercase tracking-wide">Task Aperti</p><p className="text-2xl font-bold text-slate-800 mt-1">{stats.reminders}</p></div><div className="bg-orange-50 p-3 rounded-lg text-orange-600 group-hover:bg-orange-100 transition"><Bell size={24} /></div></div>
                <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-200 flex items-center justify-between group hover:border-yellow-300 transition cursor-pointer" onClick={() => navigateToModule('quicknotes')}><div><p className="text-sm font-bold text-slate-500 uppercase tracking-wide">Appunti</p><p className="text-2xl font-bold text-slate-800 mt-1">{stats.quickNotes}</p></div><div className="bg-yellow-50 p-3 rounded-lg text-yellow-600 group-hover:bg-yellow-100 transition"><StickyNote size={24} /></div></div>
            </div>

            <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
                {/* COLONNA SINISTRA (Larga - 2/3) */}
                <div className="lg:col-span-2 space-y-8">
                    
                    {/* SEZIONE AUDIT RECENTI */}
                    <div className="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                        <div className="flex justify-between items-center mb-6">
                            <h3 className="font-bold text-lg text-slate-800">Ultimi Sopralluoghi</h3>
                            <button onClick={() => navigateToModule('audits')} className="text-sm text-blue-600 font-bold hover:underline">Vedi tutti</button>
                        </div>
                        <div className="space-y-3">
                            {stats.recentAudits.length === 0 ? <p className="text-slate-400 text-sm">Nessun audit recente.</p> : stats.recentAudits.map((a, i) => (
                                <div key={i} className="flex items-center justify-between p-4 bg-slate-50 rounded-lg hover:bg-slate-100 transition cursor-pointer" onClick={() => navigateToModule('audits')}>
                                    <div className="flex items-center gap-4">
                                        <div className={`p-2 rounded-md flex-shrink-0 ${a.tipoCliente==='Azienda'?'bg-blue-100 text-blue-700':a.tipoCliente==='Residenziale'?'bg-green-100 text-green-700':'bg-orange-100 text-orange-700'}`}>
                                            {a.tipoCliente==='Azienda' ? <Factory size={20} /> : a.tipoCliente==='Residenziale' ? <Home size={20} /> : <Trophy size={20} />}
                                        </div>
                                        <div>
                                            <p className="font-bold text-slate-800 text-sm uppercase tracking-tight">{a.nomeSocieta || 'Nuovo Cliente'}</p>
                                            <p className="text-xs text-slate-500 uppercase">{a.indirizzo}</p>
                                        </div>
                                    </div>
                                    <span className="text-xs font-bold text-slate-400 bg-white px-3 py-1 rounded-md border border-slate-200 whitespace-nowrap">
                                        {a.dataRilievo}
                                    </span>
                                </div>
                            ))}
                        </div>
                    </div>

                    {/* WIDGET APPUNTI RAPIDI (Orizzontale) */}
                    <div className="h-[350px]">
                        <QuickNotesWidget user={user} appId={appId} />
                    </div>

                </div>

                {/* COLONNA DESTRA (Stretta - 1/3) */}
                <div className="space-y-8 flex flex-col h-full">
                     
                      {/* NUOVO: WIDGET LINK DIMENSIONAMENTO */}
                      <div className="min-h-[220px]">
                        <SizingLinksWidget user={user} appId={appId} />
                      </div>

                      {/* Agenda Widget */}
                      <div className="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                        <div className="flex justify-between items-center mb-4">
                            <h3 className="font-bold text-lg text-slate-800 flex items-center gap-2"><CalendarIcon size={20} className="text-blue-600"/> Agenda</h3>
                            <button onClick={() => navigateToModule('calendar')} className="text-xs bg-slate-100 hover:bg-slate-200 px-2 py-1 rounded transition">Vedi</button>
                        </div>
                        <div className="space-y-3">
                            {stats.nextEvents.length === 0 ? <p className="text-slate-400 text-sm">Nessun evento imminente.</p> : stats.nextEvents.map((ev, i) => (
                                <div key={i} className={`p-3 rounded-lg border-l-4 ${ev.type === 'audit' ? 'border-green-500 bg-green-50/50' : ev.type === 'meeting' ? 'border-purple-500 bg-purple-50/50' : 'border-blue-500 bg-blue-50/50'}`}>
                                    <p className="text-xs font-bold text-slate-500 mb-1">{ev.date.split('-').reverse().join('/')} â€¢ {ev.time}</p>
                                    <p className="text-sm font-bold text-slate-800 leading-tight">{ev.title}</p>
                                </div>
                            ))}
                        </div>
                    </div>

                    {/* WIDGET TASK PRIORITARI */}
                    <div className="bg-white rounded-xl shadow-sm border border-slate-200 p-6 flex flex-col flex-1 min-h-[300px]">
                        <div className="flex justify-between items-center mb-6">
                            <h3 className="font-bold text-lg text-slate-800 flex items-center gap-2"><Bell className="text-orange-500" size={20}/> Task Prioritari</h3>
                            <button onClick={() => navigateToModule('reminders')} className="text-sm text-blue-600 font-bold hover:underline">Gestisci</button>
                        </div>
                        <div className="space-y-2 flex-1 overflow-y-auto custom-scrollbar pr-1">
                            {stats.recentReminders.length === 0 ? <p className="text-slate-400 text-sm italic">Nessun task in sospeso.</p> : stats.recentReminders.map((rem) => (
                                <div key={rem.id} className={`flex items-start gap-3 p-3 rounded-lg border shadow-sm transition ${rem.completed ? 'bg-slate-50 opacity-60' : getPriorityStyle(rem.priority || 'blue')}`}>
                                    <button onClick={() => toggleReminder(rem.id, rem.completed)} className="mt-0.5 hover:opacity-70 transition">{rem.completed ? <CheckCircle2 size={20} className="text-slate-400" /> : <Circle size={20} />}</button>
                                    <div className="flex-1 min-w-0">
                                        <span className={`text-sm font-bold block truncate ${rem.completed ? 'text-slate-500 line-through' : ''}`}>{rem.text}</span>
                                        {rem.dueDate && <span className="text-xs text-slate-400 flex items-center gap-1 mt-1 opacity-80"><CalendarIcon size={10} /> {rem.dueDate} {rem.dueTime && ` alle ${rem.dueTime}`}</span>}
                                    </div>
                                    <div className="flex items-center gap-1">
                                        <button onClick={() => navigateToModule('reminders', { editId: rem.id })} className="p-1 text-slate-400 hover:text-blue-500 hover:bg-blue-50 rounded transition"><Edit size={16}/></button>
                                        <button onClick={() => deleteReminder(rem.id)} className="p-1 text-slate-400 hover:text-red-500 hover:bg-red-50 rounded transition"><X size={16} /></button>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>

                </div>
            </div>
        </div>
    );
}

// --- MODULO: PIPELINE LEAD ---
function PipelineModule({ user, appId, navigateToModule }) {
    const [leads, setLeads] = useState([]);
    const [clientsCount, setClientsCount] = useState(0);
    const [loading, setLoading] = useState(true);
    const [showModal, setShowModal] = useState(false);
    const [editingLeadId, setEditingLeadId] = useState(null);
    const initialLeadState = { company: '', name: '', phone: '', city: '', stage: 'Da Contattare', type: 'Azienda', expectedValue: '', notes: '', firstContactDate: new Date().toISOString().split('T')[0] };
    const [newLead, setNewLead] = useState(initialLeadState);
    const [dialog, setDialog] = useState(null); // NUOVO STATO MODALE

    const stages = ['Da Contattare', 'In Contatto', 'Offerta Personalizzata in corso', 'In Chiusura'];
    const stageColors = {
        'Da Contattare': 'border-blue-500 bg-blue-50',
        'In Contatto': 'border-yellow-500 bg-yellow-50',
        'Offerta Personalizzata in corso': 'border-purple-500 bg-purple-50',
        'In Chiusura': 'border-green-500 bg-green-50'
    };

    useEffect(() => {
        if (!user || !db) return;
        const unsubscribeLeads = onSnapshot(collection(db, 'artifacts', appId, 'users', user.uid, 'leads'), (snapshot) => {
            const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            data.sort((a, b) => (b.createdAt || '').localeCompare(a.createdAt || ''));
            setLeads(data);
            setLoading(false);
        });
        const unsubscribeClients = onSnapshot(collection(db, 'artifacts', appId, 'users', user.uid, 'clients'), (snapshot) => {
            setClientsCount(snapshot.size);
        });
        return () => { unsubscribeLeads(); unsubscribeClients(); };
    }, [user]);

    const handleSaveLead = async () => {
        if (!newLead.company) {
            setDialog({ title: "Attenzione", message: "Nome Azienda obbligatorio", type: 'alert', onConfirm: () => setDialog(null) });
            return;
        }
        if (editingLeadId) {
            await updateDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'leads', editingLeadId), newLead);
        } else {
            await addDoc(collection(db, 'artifacts', appId, 'users', user.uid, 'leads'), {
                ...newLead, createdAt: new Date().toISOString()
            });
        }
        setShowModal(false);
        setEditingLeadId(null);
        setNewLead(initialLeadState);
    };

    const moveLead = async (id, currentStage, direction) => {
        const currentIndex = stages.indexOf(currentStage);
        const nextIndex = direction === 'next' ? currentIndex + 1 : currentIndex - 1;
        if (nextIndex >= 0 && nextIndex < stages.length) {
            await updateDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'leads', id), { stage: stages[nextIndex] });
        }
    };

    // LOGICA DI CONVERSIONE IN CLIENTE
    const handleConvertToClient = async (lead) => {
        setDialog({
            title: "Converti in Cliente",
            message: `Convertire ${lead.company} in Cliente?\nIl lead verrÃ  rimosso dalla pipeline e inserito in anagrafica.`,
            type: 'confirm',
            onConfirm: async () => {
                setDialog(null);
                try {
                    const { id, ...leadData } = lead;
                    await addDoc(collection(db, 'artifacts', appId, 'users', user.uid, 'clients'), {
                        ...leadData,
                        convertedAt: new Date().toISOString(),
                        status: 'Attivo'
                    });
                    await deleteDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'leads', id));
                    
                    setDialog({ 
                        title: "Operazione Completata", 
                        message: "âœ… Cliente inserito in anagrafica!\n\nVuoi visualizzare l'anagrafica clienti ora?", 
                        type: 'confirm', 
                        onConfirm: () => { setDialog(null); if(navigateToModule) navigateToModule('clients'); },
                        onCancel: () => setDialog(null)
                    });
                } catch (error) {
                    console.error("Errore conversione", error);
                    setDialog({ title: "Errore", message: "Si Ã¨ verificato un errore.", type: 'alert', onConfirm: () => setDialog(null) });
                }
            },
            onCancel: () => setDialog(null)
        });
    };

    const handleDelete = async (id) => {
        setDialog({
            title: "Elimina Lead",
            message: "Sei sicuro di voler eliminare questo Lead?",
            type: 'confirm',
            onConfirm: async () => {
                setDialog(null);
                await deleteDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'leads', id));
            },
            onCancel: () => setDialog(null)
        });
    };

    if (loading) return <div className="p-10 text-center"><Loader2 className="animate-spin mx-auto text-blue-500"/></div>;

    // Calcoli Analitiche
    const totalPipelineValue = leads.reduce((acc, lead) => acc + (parseFloat(lead.expectedValue) || 0), 0);
    const totalOpportunities = leads.length + clientsCount;
    const conversionRate = totalOpportunities > 0 ? ((clientsCount / totalOpportunities) * 100).toFixed(1) : 0;

    return (
        <div className="h-full flex flex-col relative">
            {/* --- RENDER MODALE CUSTOM PIPELINE --- */}
            {dialog && (
                <div className="fixed inset-0 bg-black/50 z-[100] flex items-center justify-center p-4">
                    <div className="bg-white rounded-xl p-6 max-w-sm w-full shadow-2xl animate-in fade-in zoom-in duration-200">
                        <h3 className="font-bold text-lg text-slate-800 mb-2">{dialog.title}</h3>
                        <p className="text-slate-600 mb-6 whitespace-pre-wrap">{dialog.message}</p>
                        <div className="flex justify-end gap-3">
                            {dialog.type === 'confirm' && (
                                <button onClick={dialog.onCancel} className="px-4 py-2 rounded-lg font-medium text-slate-600 hover:bg-slate-100 transition">Annulla</button>
                            )}
                            <button onClick={dialog.onConfirm} className="px-4 py-2 rounded-lg font-bold bg-blue-600 text-white hover:bg-blue-700 transition">OK</button>
                        </div>
                    </div>
                </div>
            )}
            
            <div className="flex justify-between items-center mb-6">
                <h2 className="text-2xl font-bold text-slate-800 flex items-center gap-2"><Kanban className="text-blue-600"/> Pipeline Lead</h2>
                <button onClick={() => { setEditingLeadId(null); setNewLead(initialLeadState); setShowModal(true); }} className="bg-red-600 text-white px-4 py-2 rounded-lg font-bold shadow hover:bg-red-700 flex items-center gap-2"><Plus size={18}/> Nuovo Lead</button>
            </div>

            {/* ANALITICHE PIPELINE */}
            <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                <div className="bg-white p-4 rounded-xl border border-slate-200 shadow-sm flex items-center justify-between">
                    <div>
                        <p className="text-xs font-bold text-slate-400 uppercase tracking-wide">Lead Attivi</p>
                        <p className="text-2xl font-black text-slate-800">{leads.length}</p>
                    </div>
                    <div className="bg-blue-50 p-2 rounded-lg text-blue-600"><Users size={20}/></div>
                </div>
                <div className="bg-white p-4 rounded-xl border border-slate-200 shadow-sm flex items-center justify-between">
                    <div>
                        <p className="text-xs font-bold text-slate-400 uppercase tracking-wide">Valore Pipeline Attesa</p>
                        <p className="text-2xl font-black text-emerald-600">â‚¬ {totalPipelineValue.toLocaleString('it-IT')}</p>
                    </div>
                    <div className="bg-emerald-50 p-2 rounded-lg text-emerald-600"><DollarSign size={20}/></div>
                </div>
                <div className="bg-white p-4 rounded-xl border border-slate-200 shadow-sm flex items-center justify-between">
                    <div>
                        <p className="text-xs font-bold text-slate-400 uppercase tracking-wide">Conversion Rate (Storico)</p>
                        <p className="text-2xl font-black text-indigo-600">{conversionRate}%</p>
                    </div>
                    <div className="bg-indigo-50 p-2 rounded-lg text-indigo-600"><Activity size={20}/></div>
                </div>
            </div>

            <div className="flex-1 overflow-x-auto overflow-y-hidden pb-4">
                <div className="flex gap-4 h-full min-w-[1000px]">
                    {stages.map(stage => (
                        <div key={stage} className={`flex-1 flex flex-col min-w-[280px] rounded-xl border-t-4 bg-gray-50/50 ${stageColors[stage].split(' ')[0]}`}>
                            <div className="p-3 border-b border-gray-100 flex justify-between items-center bg-white rounded-t-lg">
                                <h3 className="font-bold text-slate-700">{stage}</h3>
                                <span className="bg-slate-100 text-slate-600 text-xs px-2 py-0.5 rounded-full font-bold">{leads.filter(l => l.stage === stage).length}</span>
                            </div>
                            <div className="p-2 flex-1 overflow-y-auto space-y-3">
                                {leads.filter(l => l.stage === stage).map(lead => (
                                    <div key={lead.id} className="bg-white p-4 rounded-lg shadow-sm border border-slate-200 hover:shadow-md transition relative group">
                                        <div className="flex justify-between items-start mb-2">
                                            <span className={`text-[10px] uppercase font-bold px-1.5 py-0.5 rounded ${lead.type === 'ASD' ? 'bg-yellow-100 text-yellow-700' : lead.type === 'Residenziale' ? 'bg-green-100 text-green-700' : lead.type === 'Ristorante' ? 'bg-orange-100 text-orange-700' : 'bg-blue-100 text-blue-700'}`}>{lead.type}</span>
                                            <div className="flex gap-1 opacity-0 group-hover:opacity-100 transition">
                                                <button onClick={() => { setEditingLeadId(lead.id); setNewLead({...lead}); setShowModal(true); }} className="text-slate-300 hover:text-blue-500"><Edit size={14}/></button>
                                                <button onClick={() => handleDelete(lead.id)} className="text-slate-300 hover:text-red-500"><Trash2 size={14}/></button>
                                            </div>
                                        </div>
                                        <h4 className="font-bold text-slate-800 leading-tight mb-1">{lead.company}</h4>
                                        <p className="text-xs text-slate-500 flex items-center gap-1 mb-1"><UserCircle size={12}/> {lead.name}</p>
                                        <p className="text-xs font-bold text-emerald-600 mb-2 flex items-center gap-1"><DollarSign size={12}/> {lead.expectedValue ? `â‚¬ ${parseFloat(lead.expectedValue).toLocaleString('it-IT')}` : 'Valore N/D'}</p>
                                        <div className="text-xs text-slate-600 space-y-1">
                                            <p className="flex items-center gap-1"><MapPin size={12}/> {lead.city}</p>
                                            <p className="flex items-center gap-1"><Phone size={12}/> {lead.phone}</p>
                                        </div>
                                        {lead.firstContactDate && <p className="text-[10px] text-slate-400 mt-1.5 flex items-center gap-1"><CalendarIcon size={10}/> 1Â° Contatto: {lead.firstContactDate.split('-').reverse().join('/')}</p>}
                                        {lead.notes && <p className="text-xs text-slate-500 mt-2 pt-2 border-t border-slate-100 italic truncate" title={lead.notes}><StickyNote size={10} className="inline mr-1"/>{lead.notes}</p>}
                                        
                                        <div className="mt-3 pt-2 border-t border-slate-50 flex justify-between items-center">
                                            <button onClick={() => moveLead(lead.id, stage, 'prev')} disabled={stage === stages[0]} className="text-slate-400 hover:text-blue-600 disabled:opacity-30 p-1"><ArrowLeft size={16}/></button>
                                            
                                            {/* PULSANTE CONVERSIONE CLIENTE */}
                                            {stage === stages[stages.length - 1] ? (
                                                <button onClick={() => handleConvertToClient(lead)} className="flex items-center gap-1 text-[11px] font-bold text-green-700 bg-green-100 px-3 py-1.5 rounded-lg hover:bg-green-200 transition shadow-sm border border-green-300">
                                                    <UserCheck size={14}/> Diventa Cliente
                                                </button>
                                            ) : (
                                                <span className="text-[10px] text-slate-300 font-medium uppercase truncate px-2">{stage}</span>
                                            )}

                                            <button onClick={() => moveLead(lead.id, stage, 'next')} disabled={stage === stages[stages.length-1]} className="text-slate-400 hover:text-blue-600 disabled:opacity-30 p-1"><ArrowRight size={16}/></button>
                                        </div>
                                    </div>
                                ))}
                                {leads.filter(l => l.stage === stage).length === 0 && <div className="text-center py-10 text-slate-300 text-xs italic">Vuoto</div>}
                            </div>
                        </div>
                    ))}
                </div>
            </div>

            {showModal && (
                <div className="absolute inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
                    <div className="bg-white rounded-xl p-6 w-full max-w-md shadow-2xl">
                        <div className="flex justify-between mb-4"><h3 className="font-bold text-lg">{editingLeadId ? 'Modifica Lead' : 'Nuovo Lead'}</h3><button onClick={() => { setShowModal(false); setEditingLeadId(null); setNewLead(initialLeadState); }}><X/></button></div>
                        <div className="space-y-3">
                            <Input label="Ragione Sociale / Cliente" value={newLead.company} onChange={v => setNewLead({...newLead, company: v})} placeholder="Es. Mario Rossi SRL" />
                            <div className="grid grid-cols-2 gap-3">
                                <Input label="Referente" value={newLead.name} onChange={v => setNewLead({...newLead, name: v})} placeholder="Nome" />
                                <Input label="Telefono" value={newLead.phone} onChange={v => setNewLead({...newLead, phone: v})} placeholder="333..." />
                            </div>
                            <div className="grid grid-cols-2 gap-3">
                                <Input label="CittÃ " value={newLead.city} onChange={v => setNewLead({...newLead, city: v})} placeholder="Torino" />
                                <Input label="Valore Atteso (â‚¬)" type="number" value={newLead.expectedValue} onChange={v => setNewLead({...newLead, expectedValue: v})} placeholder="Es. 15000" />
                            </div>
                            <div className="grid grid-cols-2 gap-3">
                                <Select label="Tipo" value={newLead.type} onChange={v => setNewLead({...newLead, type: v})} options={['Azienda', 'Residenziale', 'ASD', 'Ristorante']} />
                                <Input label="Primo Contatto" type="date" value={newLead.firstContactDate || ''} onChange={v => setNewLead({...newLead, firstContactDate: v})} />
                            </div>
                            <Textarea label="Note" value={newLead.notes || ''} onChange={v => setNewLead({...newLead, notes: v})} placeholder="Dettagli opportunitÃ , orari di contatto, ecc..." />
                            <button onClick={handleSaveLead} className="w-full bg-red-600 text-white py-2 rounded-lg font-bold mt-4 hover:bg-red-700">{editingLeadId ? 'Aggiorna Lead' : 'Salva Lead'}</button>
                        </div>
                    </div>
                </div>
            )}
        </div>
    );
}

// --- MODULO: REMINDERS MANAGER ---
function RemindersManager({ user, appId, initialData }) {
  const [reminders, setReminders] = useState([]);
  const [editingId, setEditingId] = useState(null); 
  const [reminderForm, setReminderForm] = useState({ text: '', priority: 'blue', date: new Date().toISOString().split('T')[0], time: '' });
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    if (!user || !db) return;
    const unsubReminders = onSnapshot(collection(db, 'artifacts', appId, 'users', user.uid, 'reminders'), (snap) => {
        const data = snap.docs.map(d => ({id: d.id, ...d.data()}));
        data.sort((a, b) => (a.dueDate || '9999-99-99').localeCompare(b.dueDate || '9999-99-99'));
        setReminders(data);
        setLoading(false);
    });
    return () => unsubReminders();
  }, [user]);

  // Gestione apertura edit da Dashboard (via props)
  useEffect(() => {
      if(initialData && initialData.editId && reminders.length > 0) {
          const rem = reminders.find(r => r.id === initialData.editId);
          if(rem) startEdit(rem);
      }
  }, [initialData, reminders]);

  const handleSave = async (e) => { 
    e.preventDefault(); 
    if (!reminderForm.text.trim()) return; 
    
    if (editingId) {
        // UPDATE
        await updateDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'reminders', editingId), { 
            text: reminderForm.text, 
            priority: reminderForm.priority, 
            dueDate: reminderForm.date, 
            dueTime: reminderForm.time 
        });
        setEditingId(null);
    } else {
        // ADD
        await addDoc(collection(db, 'artifacts', appId, 'users', user.uid, 'reminders'), { 
            text: reminderForm.text, 
            priority: reminderForm.priority, 
            dueDate: reminderForm.date, 
            dueTime: reminderForm.time, 
            completed: false, 
            createdAt: new Date().toISOString() 
        }); 
    }
    setReminderForm({ text: '', priority: 'blue', date: new Date().toISOString().split('T')[0], time: '' }); 
  };
  
  const startEdit = (rem) => {
      setEditingId(rem.id);
      setReminderForm({
          text: rem.text,
          priority: rem.priority || 'blue',
          date: rem.dueDate || '',
          time: rem.dueTime || ''
      });
      // Scroll to top form
      window.scrollTo({ top: 0, behavior: 'smooth' });
  };

  const cancelEdit = () => {
      setEditingId(null);
      setReminderForm({ text: '', priority: 'blue', date: new Date().toISOString().split('T')[0], time: '' });
  };
  
  const toggleReminder = async (id, currentStatus) => { await updateDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'reminders', id), { completed: !currentStatus }); };
  const deleteReminder = async (id) => { await deleteDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'reminders', id)); };
  const getPriorityStyle = (priority) => { switch(priority) { case 'red': return 'bg-red-50 border-red-200 text-red-700'; case 'green': return 'bg-green-50 border-green-200 text-green-700'; default: return 'bg-blue-50 border-blue-200 text-blue-700'; } };

  if (loading) return <div className="text-center p-10 text-slate-500">Caricamento Promemoria...</div>;

  return (
    <div className="max-w-4xl mx-auto space-y-6">
        <div className="bg-white p-8 rounded-xl shadow-sm border border-slate-200">
            <div className="mb-8"><h2 className="text-2xl font-bold text-slate-800 flex items-center gap-2"><Bell className="text-orange-500" size={24} /> Promemoria & AttivitÃ </h2><p className="text-slate-500 mt-1">Gestisci le tue scadenze e prioritÃ  in un unico posto.</p></div>
            <form onSubmit={handleSave} className="flex flex-col gap-3 mb-8 bg-slate-50 p-5 rounded-xl border border-slate-200 transition-all duration-300 ring-offset-2 ring-2 ring-transparent focus-within:ring-blue-100"><label className="text-xs font-bold text-slate-500 uppercase tracking-wide flex justify-between">{editingId ? <span className="text-blue-600 flex items-center gap-1"><Edit size={12}/> Modifica in corso...</span> : 'Nuovo Promemoria'}</label><div className="flex flex-col md:flex-row gap-3"><input type="text" placeholder="Cosa devi fare oggi?" className="flex-1 bg-white border border-slate-300 rounded-lg px-4 py-2.5 focus:outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-100 transition" value={reminderForm.text} onChange={e => setReminderForm({...reminderForm, text: e.target.value})} /><input type="date" className="bg-white border border-slate-300 rounded-lg px-4 py-2.5 text-slate-600 focus:outline-none focus:border-blue-500" value={reminderForm.date} onChange={e => setReminderForm({...reminderForm, date: e.target.value})} /><input type="time" className="bg-white border border-slate-300 rounded-lg px-4 py-2.5 text-slate-600 focus:outline-none focus:border-blue-500" value={reminderForm.time} onChange={e => setReminderForm({...reminderForm, time: e.target.value})} /><div className="flex bg-white border border-slate-300 rounded-lg p-1 gap-1"><button type="button" onClick={() => setReminderForm({...reminderForm, priority: 'red'})} className={`p-2 rounded-md hover:bg-slate-100 transition ${reminderForm.priority === 'red' ? 'bg-red-50 text-red-600 ring-1 ring-red-500' : 'text-slate-400'}`} title="Alta PrioritÃ "><AlertCircle size={20} /></button><button type="button" onClick={() => setReminderForm({...reminderForm, priority: 'blue'})} className={`p-2 rounded-md hover:bg-slate-100 transition ${reminderForm.priority === 'blue' ? 'bg-blue-50 text-blue-600 ring-1 ring-blue-500' : 'text-slate-400'}`} title="Media PrioritÃ "><Bell size={20} /></button><button type="button" onClick={() => setReminderForm({...reminderForm, priority: 'green'})} className={`p-2 rounded-md hover:bg-slate-100 transition ${reminderForm.priority === 'green' ? 'bg-green-50 text-green-600 ring-1 ring-green-500' : 'text-slate-400'}`} title="Bassa PrioritÃ "><CheckCircle2 size={20} /></button></div>{editingId ? (<div className="flex gap-2"><button type="submit" className="bg-blue-600 text-white px-4 py-2.5 rounded-lg font-bold hover:bg-blue-700 shadow-md transition flex items-center justify-center gap-2"><Save size={18} /> Salva</button><button type="button" onClick={cancelEdit} className="bg-slate-200 text-slate-600 px-4 py-2.5 rounded-lg font-bold hover:bg-slate-300 transition flex items-center justify-center gap-2"><X size={18} /> Annulla</button></div>) : (<button type="submit" className="bg-blue-600 text-white px-6 py-2.5 rounded-lg font-bold hover:bg-blue-700 shadow-md transition flex items-center justify-center gap-2"><Plus size={18} /> Aggiungi</button>)}</div></form>
            <div className="space-y-3">{reminders.length === 0 && (<div className="text-center py-10 text-slate-400 bg-slate-50/50 rounded-xl border border-dashed border-slate-200"><CheckCircle2 size={48} className="mx-auto mb-2 opacity-20" /><p>Nessun promemoria attivo. Sei libero!</p></div>)}{reminders.map(rem => (<div key={rem.id} className={`flex items-center gap-4 p-4 rounded-xl border transition-all hover:shadow-md ${rem.completed ? 'bg-slate-50 border-transparent opacity-60' : `bg-white ${getPriorityStyle(rem.priority || 'blue')}`}`}><button onClick={() => toggleReminder(rem.id, rem.completed)} className="flex-shrink-0 transition hover:scale-110">{rem.completed ? <CheckCircle2 size={24} className="text-slate-400" /> : <Circle size={24} />}</button><div className="flex-1"><span className={`text-base font-medium block ${rem.completed ? 'text-slate-500 line-through' : 'text-slate-800'}`}>{rem.text}</span>{rem.dueDate && <span className="text-xs opacity-70 flex items-center gap-1.5 mt-1"><CalendarIcon size={12}/> Scadenza: {rem.dueDate.split('-').reverse().join('/')} {rem.dueTime && ` alle ${rem.dueTime}`}</span>}</div><div className="flex items-center gap-1"><button onClick={() => startEdit(rem)} className="p-2 text-slate-400 hover:text-blue-500 hover:bg-blue-50 rounded-lg transition" title="Modifica"><Edit size={18} /></button><button onClick={() => deleteReminder(rem.id)} className="p-2 text-slate-400 hover:text-red-500 hover:bg-red-50 rounded-lg transition" title="Elimina"><Trash2 size={18} /></button></div></div>))}</div>
        </div>
    </div>
  );
}

// --- MODULO: AUDIT MANAGER ---
function AuditManager({ user, appId, initialMode, setActiveModule }) {
  const [view, setView] = useState(initialMode === 'new' ? 'form' : 'dashboard');
  const [audits, setAudits] = useState([]);
  const [currentAudit, setCurrentAudit] = useState(null);
  const [isSaving, setIsSaving] = useState(false);
  const [isGenerating, setIsGenerating] = useState(false);
  const [loadingData, setLoadingData] = useState(true);
  const [dialog, setDialog] = useState(null);

  // Effect per gestire initialMode dal padre (Dashboard)
  useEffect(() => {
    if (initialMode === 'new') {
        handleNewAudit();
    } else {
        setView('dashboard');
    }
  }, [initialMode]);

  useEffect(() => {
    if (!user || !db) return;
    const unsubscribe = onSnapshot(collection(db, 'artifacts', appId, 'users', user.uid, 'audits'), (snapshot) => {
      const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      data.sort((a, b) => new Date(b.dataRilievo) - new Date(a.dataRilievo)); 
      setAudits(data);
      setLoadingData(false);
    }, (err) => { console.error(err); setLoadingData(false); });
    return () => unsubscribe();
  }, [user]);

  const handleNewAudit = () => {
    setCurrentAudit({
      tipoCliente: 'Azienda', dataRilievo: new Date().toISOString().split('T')[0], prossimoIncontro: '', oraIncontro: '', 
      nomeSocieta: '', piva: '', pec: '', indirizzo: '', titoloPossesso: '', obiettivoCliente: '',
      referente: '', telefono: '', email: '', noteAnagrafica: '',
      presidente: '', telPresidente: '', emailPresidente: '', 
      segretaria: '', telSegretaria: '', emailSegretaria: '',
      checkFoto: false, checkLuce: false, checkGas: false,
      numFari: '', potenzaFari: '', 
      // DOCCE GIOCATORI ESTESE (1-9)
      numDocce1: '', mqDocce1: '', emissioneDocce1: '', elementiDocce1: '', matDocce1: '', wattDocce1: '',
      numDocce2: '', mqDocce2: '', emissioneDocce2: '', elementiDocce2: '', matDocce2: '', wattDocce2: '',
      numDocce3: '', mqDocce3: '', emissioneDocce3: '', elementiDocce3: '', matDocce3: '', wattDocce3: '',
      numDocce4: '', mqDocce4: '', emissioneDocce4: '', elementiDocce4: '', matDocce4: '', wattDocce4: '',
      numDocce5: '', mqDocce5: '', emissioneDocce5: '', elementiDocce5: '', matDocce5: '', wattDocce5: '',
      numDocce6: '', mqDocce6: '', emissioneDocce6: '', elementiDocce6: '', matDocce6: '', wattDocce6: '',
      numDocce7: '', mqDocce7: '', emissioneDocce7: '', elementiDocce7: '', matDocce7: '', wattDocce7: '',
      numDocce8: '', mqDocce8: '', emissioneDocce8: '', elementiDocce8: '', matDocce8: '', wattDocce8: '',
      numDocce9: '', mqDocce9: '', emissioneDocce9: '', elementiDocce9: '', matDocce9: '', wattDocce9: '',
      // DOCCE ARBITRI
      numDocceArbitri1: '', mqDocceArbitri1: '', emissioneDocceArbitri1: '', elementiDocceArbitri1: '', matDocceArbitri1: '', wattDocceArbitri1: '',
      numDocceArbitri2: '', mqDocceArbitri2: '', emissioneDocceArbitri2: '', elementiDocceArbitri2: '', matDocceArbitri2: '', wattDocceArbitri2: '',
      numDocceArbitri3: '', mqDocceArbitri3: '', emissioneDocceArbitri3: '', elementiDocceArbitri3: '', matDocceArbitri3: '', wattDocceArbitri3: '',
      numUtenti: '', orari: '', noteConsumi: '',
      // DATI TECNICI AGGIUNTIVI
      ct1: '', ct2: '', 
      consumoF1_1: '', consumoF2_1: '', consumoF3_1: '',
      consumoF1_2: '', consumoF2_2: '', consumoF3_2: '',
      consumoF1_3: '', consumoF2_3: '', consumoF3_3: '',
      consumoF1: '', consumoF2: '', consumoF3: '',
      consumoGas1: '', consumoGas2: '',
      nucleoFamiliare: '', abitudini: '', autoElettrica: false, elettrodomestici: '', 
      settoreAttivita: '', turniLavoro: '', macchinari: '', cabinaMT: false, noteAzienda: '',
      tipoTetto: '', impiantoTermico: '', accumulo: 'No', dettagliAccumulo: '', contatore: '', noteTecniche: '',
      metriCubi1: '', sistemaEmissione1: '', numTerminali1: '', contatore1: '', impiantoTermico1: '', 
      metriCubi2: '', sistemaEmissione2: '', numTerminali2: '', contatore2: '', impiantoTermico2: '', 
      metriCubi3: '', sistemaEmissione3: '', numTerminali3: '', contatore3: '', impiantoTermico3: '', 
      accumulo1: '', accumulo2: '',
      superficieTetto: '', orientamento: '',
      propostaFV: '', propostaAccumulo: '', propostaTermico: '', propostaNote: '',
      propostaPainPoints: '', propostaLeva: '', // <-- NUOVI CAMPI COMMERCIALI AI
      optLeasing: false, optIncentivi: false, budgetNote: '', noteOpzioni: '', linkDrive: '', linkSito: '', linkGoogleEarth: '', ia: '', ia2: '', ia3: '',
      ombreggianti: ''
    });
    setView('form');
  };

  const handleEditAudit = (audit) => { setCurrentAudit({ ...audit }); setView('form'); };
  
  const handleDeleteAudit = async (id, e) => { 
      e.stopPropagation(); 
      setDialog({
          title: "Elimina Rilievo",
          message: "Vuoi eliminare definitivamente questo report?",
          type: 'confirm',
          onConfirm: async () => {
              await deleteDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'audits', id));
              setDialog(null);
          },
          onCancel: () => setDialog(null)
      });
  };

  const handleSave = async () => { 
      if (!currentAudit.nomeSocieta) {
          setDialog({ title: "Dati Mancanti", message: "Inserisci il Nome Cliente/SocietÃ .", type: 'alert', onConfirm: () => setDialog(null) });
          return;
      }
      setIsSaving(true); 
      try { 
          let isNewAudit = !currentAudit.id;
          let savedAuditId = currentAudit.id;

          if (currentAudit.id) { 
              const { id, ...data } = currentAudit; 
              await updateDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'audits', id), data); 
          } else { 
              const docRef = await addDoc(collection(db, 'artifacts', appId, 'users', user.uid, 'audits'), currentAudit); 
              savedAuditId = docRef.id;
          } 
          
          setIsSaving(false); 

          if (isNewAudit) {
              const hasContactInfo = currentAudit.telefono || currentAudit.telPresidente || currentAudit.email || currentAudit.emailPresidente;
              if (hasContactInfo) {
                  const leadData = {
                      company: currentAudit.nomeSocieta,
                      name: currentAudit.referente || currentAudit.presidente || 'N/D',
                      phone: currentAudit.telefono || currentAudit.telPresidente || 'N/D',
                      city: currentAudit.indirizzo || 'N/D',
                      type: currentAudit.tipoCliente,
                      stage: 'Da Contattare',
                      source: 'Audit',
                      linkedAuditId: savedAuditId,
                      createdAt: new Date().toISOString()
                  };
                  
                  setDialog({
                      title: "Ottimo lavoro! ðŸŽ¯",
                      message: `Hai registrato un nuovo Audit per ${currentAudit.nomeSocieta}.\n\nVuoi inserirlo automaticamente nella Pipeline Vendite come Lead "Da Contattare"?`,
                      type: 'confirm',
                      onConfirm: async () => {
                          await addDoc(collection(db, 'artifacts', appId, 'users', user.uid, 'leads'), leadData);
                          setDialog(null);
                          setView('dashboard'); 
                          if(setActiveModule) setActiveModule('audits');
                      },
                      onCancel: () => {
                          setDialog(null);
                          setView('dashboard'); 
                          if(setActiveModule) setActiveModule('audits');
                      }
                  });
                  return; 
              }
          }

          setView('dashboard'); 
          if(setActiveModule) setActiveModule('audits'); 
      } catch (error) { 
          setIsSaving(false);
          setDialog({ title: "Errore", message: "Errore salvataggio: " + error.message, type: 'alert', onConfirm: () => setDialog(null) });
      } 
  };
  
  const handleSendToPipeline = async () => {
      if (!currentAudit.nomeSocieta) {
          setDialog({ title: "Attenzione", message: "Manca il nome cliente!", type: 'alert', onConfirm: () => setDialog(null) });
          return;
      }
      const leadData = {
          company: currentAudit.nomeSocieta,
          name: currentAudit.referente || currentAudit.presidente || 'N/D',
          phone: currentAudit.telefono || currentAudit.telPresidente || 'N/D',
          city: currentAudit.indirizzo || 'N/D',
          type: currentAudit.tipoCliente,
          stage: 'Da Contattare',
          source: 'Audit',
          linkedAuditId: currentAudit.id || 'N/D',
          createdAt: new Date().toISOString()
      };
      
      setDialog({
          title: "Genera Lead",
          message: `Creare un lead in Pipeline per ${leadData.company}?`,
          type: 'confirm',
          onConfirm: async () => {
              await addDoc(collection(db, 'artifacts', appId, 'users', user.uid, 'leads'), leadData);
              setDialog({ title: "Successo", message: "âœ… Lead creato con successo nella Pipeline!", type: 'alert', onConfirm: () => setDialog(null) });
          },
          onCancel: () => setDialog(null)
      });
  };

  const generateAIProposal = async () => {
    if (!apiKey) { 
        setDialog({ title: "API Mancante", message: "Chiave API non configurata.", type: 'alert', onConfirm: () => setDialog(null) });
        return; 
    }
    setIsGenerating(true);
    const c = currentAudit;
    
    // NUOVO PROMPT AI: Focus Commerciale (Senior Sales Engineer)
    const prompt = `Sei un Senior Sales Engineer nel settore rinnovabili. Analizza i dati di questo cliente per creare una proposta tecnica e una fortissima strategia di chiusura commerciale. 
Cliente: ${c.tipoCliente} - ${c.nomeSocieta}. 
Settore/AttivitÃ : ${c.settoreAttivita || 'Non specificato'}. 
Obiettivo dichiarato: ${c.obiettivoCliente}. 
Consumi (F1/F2/F3): ${c.consumoF1}/${c.consumoF2}/${c.consumoF3}. 
Tecnica: Tetto ${c.tipoTetto}, Sup. ${c.superficieTetto}mq, Orientamento ${c.orientamento}. 
Genera esclusivamente un JSON valido con questa esatta struttura: 
{ 
  "fv": "dimensione consigliata impianto FV in kWp", 
  "accumulo": "capacitÃ  batteria consigliata in kWh (o scrivi 'Non strettamente necessario')", 
  "termico": "soluzione termica suggerita (es. PDC, Solare Termico)", 
  "note": "brevissime note tecniche di installazione", 
  "painPoints": "Elenco a punti di 3 Pain Points (problemi) specifici per questo tipo/settore di cliente che il nostro impianto risolve (es. caro bollette, continuitÃ  operativa, normative ESG)", 
  "levaCommerciale": "Una frase persuasiva e d'impatto pronta per essere usata dal venditore per spingere alla chiusura, basata sul ROI e sui vantaggi per il suo specifico settore aziendale/abitativo" 
}`;

    try {
      const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] }) });
      const data = await response.json();
      const text = data.candidates[0].content.parts[0].text.replace(/```json|```/g, '').trim();
      const result = JSON.parse(text);
      setCurrentAudit(prev => ({ 
          ...prev, 
          propostaFV: result.fv, 
          propostaAccumulo: result.accumulo, 
          propostaTermico: result.termico, 
          propostaNote: result.note,
          propostaPainPoints: result.painPoints,
          propostaLeva: result.levaCommerciale
      }));
      setDialog({ title: "Strategia Generata", message: "âœ¨ Proposta tecnica e strategia commerciale create con successo!", type: 'alert', onConfirm: () => setDialog(null) });
    } catch (error) { 
      console.error("AI Error", error); 
      setDialog({ title: "Errore", message: "Errore AI. Riprova piÃ¹ tardi.", type: 'alert', onConfirm: () => setDialog(null) });
    } finally { 
      setIsGenerating(false); 
    }
  };

  const getIcon = (type) => { if (type === 'Azienda') return <Factory size={18} className="text-blue-600" />; if (type === 'Residenziale') return <Home size={18} className="text-green-600" />; return <Trophy size={18} className="text-orange-600" />; };
  
  const generateOutput = () => {
    const c = currentAudit; const val = (k) => c[k] || '-'; const chk = (k) => c[k] ? 'âœ…' : 'âŒ'; let sections = {};
    const totGas = (parseInt(c.consumoGas1) || 0) + (parseInt(c.consumoGas2) || 0);
    const gasDisplay = totGas > 0 ? `â€¢ Gas (Smc): ${val('consumoGas1')} + ${val('consumoGas2')} = ${totGas} Tot.` : '';

    if (c.tipoCliente === 'ASD') { 
        const totDocceGiocatori = [1,2,3,4,5,6,7,8,9].reduce((acc, i) => acc + (parseInt(c[`numDocce${i}`]) || 0), 0);
        const totDocceArbitri = [1,2,3].reduce((acc, i) => acc + (parseInt(c[`numDocceArbitri${i}`]) || 0), 0);
        const totDocce = totDocceGiocatori + totDocceArbitri;
        const docceDisplay = totDocce > 0 ? `Giocatori (${totDocceGiocatori}) + Arbitri (${totDocceArbitri}) = ${totDocce} Tot.` : '-';
        
        const totKwFari = ((parseInt(c.numFari) || 0) * (parseInt(c.potenzaFari) || 0) / 1000).toFixed(1);
        let totalConsumi = 0; let consumptionDetails = '';
        [1, 2, 3].forEach(i => { const sum = (parseInt(c[`consumoF1_${i}`])||0) + (parseInt(c[`consumoF2_${i}`])||0) + (parseInt(c[`consumoF3_${i}`])||0); if (sum > 0) { totalConsumi += sum; consumptionDetails += `\n   âš¡ U${i}: F1:${val(`consumoF1_${i}`)} F2:${val(`consumoF2_${i}`)} F3:${val(`consumoF3_${i}`)} (${sum} kWh)`; }});
        if (totalConsumi > 0) consumptionDetails += `\n   ðŸ“Š TOTALE STRUTTURA: ${totalConsumi} kWh`;
        sections.specific = `*DATI ASD & CONSUMI*\nâ€¢ Docce: ${docceDisplay}\nâ€¢ Utenti/die: ${val('numUtenti')}\nâ€¢ Sup. Tetto: ${val('superficieTetto')} mq\nâ€¢ Orari: ${val('orari')}\nâ€¢ Fari: ${val('numFari')} x ${val('potenzaFari')}W = ${totKwFari} kW Tot.\nâ€¢ Orientamento: ${val('orientamento')}${consumptionDetails}\n${gasDisplay}\nâ€¢ Note Consumi: ${val('noteConsumi')}`; 
    } else if (c.tipoCliente === 'Azienda') { 
        let totalConsumiAz = 0; let consumptionDetailsAz = '';
        [1, 2, 3].forEach(i => { const sum = (parseInt(c[`consumoF1_${i}`])||0) + (parseInt(c[`consumoF2_${i}`])||0) + (parseInt(c[`consumoF3_${i}`])||0); if (sum > 0) { totalConsumiAz += sum; consumptionDetailsAz += `\n   âš¡ U${i}: F1:${val(`consumoF1_${i}`)} F2:${val(`consumoF2_${i}`)} F3:${val(`consumoF3_${i}`)} (${sum} kWh)`; }});
        if (totalConsumiAz > 0) consumptionDetailsAz += `\n   ðŸ“Š TOTALE ELETTRICO: ${totalConsumiAz} kWh`;
        sections.specific = `*DATI PRODUTTIVI*\nâ€¢ Settore: ${val('settoreAttivita')}\nâ€¢ Turni: ${val('turniLavoro')}\nâ€¢ Macchinari: ${val('macchinari')}\nâ€¢ Cabina MT: ${chk('cabinaMT')}${consumptionDetailsAz}\n${gasDisplay}\nâ€¢ Note Prod.: ${val('noteAzienda')}`; 
    } else { 
        const totConsumi = (parseInt(c.consumoF1)||0) + (parseInt(c.consumoF2)||0) + (parseInt(c.consumoF3)||0);
        sections.specific = `*DATI ABITATIVI*\nâ€¢ Nucleo: ${val('nucleoFamiliare')} persone\nâ€¢ Abitudini: ${val('abitudini')}\nâ€¢ Auto EV: ${chk('autoElettrica')}\nâ€¢ Elettrodomestici: ${val('elettrodomestici')}\nâ€¢ Consumi Luce: F1:${val('consumoF1')} F2:${val('consumoF2')} F3:${val('consumoF3')} (Tot: ${totConsumi} kWh)\n${gasDisplay}`; 
    }
    
    let unitMsg = '';
    [1, 2, 3].forEach(i => { 
        if (val(`metriCubi${i}`) !== '-' || val(`contatore${i}`) !== '-' || val(`impiantoTermico${i}`) !== '-') { 
            const qty = val(`numTerminali${i}`) !== '-' ? ` (${val(`numTerminali${i}`)} elem.)` : ''; 
            const termico = val(`impiantoTermico${i}`) !== '-' ? ` | ðŸ”¥ ${val(`impiantoTermico${i}`)}` : ''; 
            unitMsg += `\n   ðŸ“ *UnitÃ  ${i}:* ${val(`metriCubi${i}`)}mc | ${val(`sistemaEmissione${i}`)}${qty} | ${val(`contatore${i}`)}${termico}`; 
        }
    });
    let techExtra = '';
    if (c.tipoCliente === 'Azienda') { techExtra = `â€¢ Sup. Utile: ${val('superficieTetto')} mq\nâ€¢ Orientamento: ${val('orientamento')}\n`; }
    let accMsg = '';
    if (c.tipoCliente === 'ASD' && (c.accumulo1 || c.accumulo2)) { const totAcc = (parseInt(c.accumulo1) || 0) + (parseInt(c.accumulo2) || 0); accMsg = `L1: ${val('accumulo1')}L + L2: ${val('accumulo2')}L = ${totAcc}L Tot.`; } else { accMsg = `${c.accumulo} ${val('dettagliAccumulo')}`; }
    sections.units = unitMsg; sections.accDisplay = accMsg; sections.techExtra = techExtra;
    return { c, val, chk, sections };
  };

  const handleWhatsApp = () => { 
      const { c, val, chk, sections } = generateOutput(); 
      let icon = c.tipoCliente === 'Azienda' ? 'ðŸ­' : c.tipoCliente === 'Residenziale' ? 'ðŸ ' : 'ðŸ†'; 
      let msg = `*REPORT RILIEVO ${c.tipoCliente.toUpperCase()} ${icon}*\n*Cliente:* ${val('nomeSocieta')}\nâ€¢ P.IVA: ${val('piva')}\nâ€¢ PEC: ${val('pec')}\nðŸ“ ${val('indirizzo')}\nðŸ“… ${val('dataRilievo')}\n\n*1ï¸âƒ£ ANAGRAFICA*\nâ€¢ Titolo: ${val('titoloPossesso')}\nâ€¢ Obiettivo: ${val('obiettivoCliente')}\nâ€¢ Presidente: ${val('presidente')} (${val('telPresidente')} | ${val('emailPresidente')})\nâ€¢ Segreteria: ${val('segretaria')} (${val('telSegretaria')} | ${val('emailSegretaria')})\nâ€¢ Referente: ${val('referente')} (${val('telefono')})\nâ€¢ Note Anagrafica: ${val('noteAnagrafica')}\n\n${sections.specific}\n\n*3ï¸âƒ£ TECNICA*\nâ€¢ Tetto: ${val('tipoTetto')}\n${sections.techExtra}â€¢ Imp. Termico: ${val('impiantoTermico')}\nâ€¢ Accumulo: ${sections.accDisplay}\nâ€¢ Note: ${val('noteTecniche')}\n${sections.units}\n\n*4ï¸âƒ£ OPZIONI*\nâ€¢ Leasing: ${chk('optLeasing')} | Incen.: ${chk('optIncentivi')}\nâ€¢ Budget: ${val('budgetNote')}\nâ€¢ Note Generali: ${val('noteOpzioni')}\n\n*5ï¸âƒ£ PROPOSTA TECNICA* ðŸ’¡\nâ€¢ FV: ${val('propostaFV')}\nâ€¢ Accumulo: ${val('propostaAccumulo')}\nâ€¢ Termico: ${val('propostaTermico')}\nâ€¢ Note: ${val('propostaNote')}\n\n*ðŸŽ¯ LEVA COMMERCIALE & PAIN POINTS*\nâ€¢ Pain Points:\n${val('propostaPainPoints')}\n\nâ€¢ Argomentazione di chiusura:\n${val('propostaLeva')}\n\nâ€¢ Drive: ${val('linkDrive')}\nâ€¢ Earth: ${val('linkGoogleEarth')}\nâ€¢ Sito: ${val('linkSito')}\nâ€¢ IA: ${val('ia')}\nâ€¢ IA 2: ${val('ia2')}\nâ€¢ IA 3: ${val('ia3')}`; 
      window.open(`https://wa.me/?text=${encodeURIComponent(msg)}`, '_blank'); 
  };
  
  const handlePrint = () => { 
      const { c, val, chk, sections } = generateOutput(); 
      const specificHtml = sections.specific.replace(/\*/g, '').split('\n').filter(l => l.trim()).map(l => { if (l.includes('DATI')) return `<h3>${l.trim()}</h3>`; return `<div class="row">${l.replace('â€¢', '<span class="label">').replace(':', ':</span> <span class="value">')}</span></div>`; }).join(''); 
      let unitsHtml = '';
      [1, 2, 3].forEach(i => { 
          if (val(`metriCubi${i}`) !== '-' || val(`contatore${i}`) !== '-' || val(`impiantoTermico${i}`) !== '-') { 
              const qty = val(`numTerminali${i}`) !== '-' ? ` (${val(`numTerminali${i}`)} elem.)` : ''; 
              unitsHtml += `<div style="background:#f9f9f9; padding:5px; margin-bottom:5px; border-left:3px solid #ccc;"><div class="row" style="font-weight:bold; margin-bottom:0;">UnitÃ  ${i}</div><div class="row"><span class="label">Imp. Termico:</span> <span class="value">${val(`impiantoTermico${i}`)}</span></div><div class="row"><span class="label">Volume:</span> <span class="value">${val(`metriCubi${i}`)} mc</span></div><div class="row"><span class="label">Sistema:</span> <span class="value">${val(`sistemaEmissione${i}`)}${qty}</span></div><div class="row"><span class="label">Contatore:</span> <span class="value">${val(`contatore${i}`)}</span></div></div>`; 
          }
      });
      let techFields = `<div class="row"><span class="label">Tetto:</span> <span class="value">${val('tipoTetto')}</span></div>`;
      if (c.tipoCliente === 'Azienda') { techFields += `<div class="grid"><div class="row"><span class="label">Sup. Utile:</span> <span class="value">${val('superficieTetto')} mq</span></div><div class="row"><span class="label">Orientamento:</span> <span class="value">${val('orientamento')}</span></div></div>`; }
      let consumptionHtml = '';
      const totGas = (parseInt(c.consumoGas1) || 0) + (parseInt(c.consumoGas2) || 0);
      const gasBlock = totGas > 0 ? `<div style="margin-top:5px; border-top:1px dashed #ccc; pt-2;"><div class="row" style="margin-bottom:0;"><strong>GAS (Smc):</strong> 1: ${val('consumoGas1')} | 2: ${val('consumoGas2')} -> <strong>Tot: ${totGas} Smc</strong></div></div>` : '';
      if (c.tipoCliente === 'Azienda' || c.tipoCliente === 'ASD') { let grandTotal = 0; consumptionHtml += `<div style="margin: 5px 0;"><strong>DETTAGLIO CONSUMI (Multi-POD)</strong></div>`; [1, 2, 3].forEach(i => { const sum = (parseInt(c[`consumoF1_${i}`])||0) + (parseInt(c[`consumoF2_${i}`])||0) + (parseInt(c[`consumoF3_${i}`])||0); if (sum > 0) { grandTotal += sum; consumptionHtml += `<div style="background:#f0fdf4; padding:5px; margin-bottom:5px; border:1px solid #bbf7d0;"><div class="row" style="margin-bottom:0; font-size:11px;"><strong>POD ${i}:</strong> F1:${val(`consumoF1_${i}`)} | F2:${val(`consumoF2_${i}`)} | F3:${val(`consumoF3_${i}`)}</div><div class="row" style="margin-bottom:0;">Totale Parziale: <strong>${sum} kWh</strong></div></div>`; }}); if (grandTotal > 0) { consumptionHtml += `<div style="background:#dcfce7; padding:8px; border:1px solid #86efac; margin-top:5px;"><div class="row" style="margin-bottom:0; font-weight:bold; font-size:14px;">TOTALE ELETTRICO: ${grandTotal} kWh/anno</div>${gasBlock}</div>`; } else if (gasBlock) { consumptionHtml += `<div style="background:#fff7ed; padding:8px; border:1px solid #fed7aa; margin-top:5px;">${gasBlock}</div>`; } } else if (c.tipoCliente === 'Residenziale') { const totConsumi = (parseInt(c.consumoF1)||0) + (parseInt(c.consumoF2)||0) + (parseInt(c.consumoF3)||0); consumptionHtml = `<div style="background:#f0fdf4; padding:5px; margin:5px 0; border:1px solid #bbf7d0;"><div class="row" style="margin-bottom:0; font-weight:bold;">ELETTRICO: F1:${val('consumoF1')} | F2:${val('consumoF2')} | F3:${val('consumoF3')}</div><div class="row" style="margin-bottom:0;">Totale Annuo: <strong>${totConsumi} kWh</strong></div></div>${gasBlock}`; }

      const html = `<html><head><title>Stampa ${c.tipoCliente}</title><style>body{font-family:Arial,sans-serif;padding:40px;color:#333;line-height:1.4;font-size:13px}h1{color:#0056b3;border-bottom:2px solid #0056b3;padding-bottom:10px;margin-bottom:20px}h3{background:#eee;padding:6px;border-left:5px solid #0056b3;margin-top:25px;margin-bottom:10px;font-size:14px}.row{margin-bottom:6px;display:flex;border-bottom:1px solid #f9f9f9;padding-bottom:2px}.label{font-weight:bold;width:160px;color:#555}.value{font-weight:bold;color:#000;flex-grow:1}.grid{display:grid;grid-template-columns:1fr 1fr;gap:15px}.badge{background:#0056b3;color:white;padding:2px 6px;border-radius:4px;font-size:10px;vertical-align:middle}.commercial-box{background-color:#eff6ff; border:1px solid #bfdbfe; padding:15px; border-radius:8px; margin-top:15px;}</style></head><body><h1>âš¡ Report Rilievo <span class="badge">${c.tipoCliente}</span></h1><p><strong>Cliente:</strong> ${val('nomeSocieta')} | <strong>Data:</strong> ${val('dataRilievo')}</p><h3>ANAGRAFICA</h3><div class="row"><span class="label">P.IVA / C.F.:</span> <span class="value">${val('piva')}</span></div><div class="row"><span class="label">PEC:</span> <span class="value">${val('pec')}</span></div><div class="row"><span class="label">Indirizzo:</span> <span class="value">${val('indirizzo')}</span></div><div class="grid"><div class="row"><span class="label">Titolo:</span> <span class="value">${val('titoloPossesso')}</span></div><div class="row"><span class="label">Obiettivo:</span> <span class="value">${val('obiettivoCliente')}</span></div></div><div class="row"><span class="label">Presidente:</span> <span class="value">${val('presidente')} (${val('telPresidente')} | ${val('emailPresidente')})</span></div><div class="row"><span class="label">Segreteria:</span> <span class="value">${val('segretaria')} (${val('telSegretaria')} | ${val('emailSegretaria')})</span></div><div class="row"><span class="label">Referente:</span> <span class="value">${val('referente')} (Tel: ${val('telefono')})</span></div><div class="row"><span class="label">Email Gen.:</span> <span class="value">${val('email')}</span></div><div class="row"><span class="label">Note:</span> <span class="value">${val('noteAnagrafica')}</span></div>${specificHtml}<h3>TECNICA & IMPIANTO</h3>${techFields}${consumptionHtml}<div class="grid"><div class="row"><span class="label">Termico:</span> <span class="value">${val('impiantoTermico')}</span></div><div class="row"><span class="label">Accumulo:</span> <span class="value">${sections.accDisplay}</span></div></div><div class="row"><span class="label">Note:</span> <span class="value">${val('noteTecniche')}</span></div>${unitsHtml ? `<h3>DETTAGLIO UNITÃ€</h3>${unitsHtml}` : ''}<h3>PROPOSTA DI DIMENSIONAMENTO E STRATEGIA</h3><div class="grid"><div class="row"><span class="label">Fotovoltaico:</span> <span class="value">${val('propostaFV')}</span></div><div class="row"><span class="label">Accumulo:</span> <span class="value">${val('propostaAccumulo')}</span></div></div><div class="row"><span class="label">Termico:</span> <span class="value">${val('propostaTermico')}</span></div><div class="row"><span class="label">Note Proposta:</span> <span class="value">${val('propostaNote')}</span></div><div class="commercial-box"><div style="color:#1e40af; font-weight:bold; margin-bottom:8px; border-bottom:1px solid #bfdbfe; padding-bottom:4px;">ðŸŽ¯ PAIN POINTS & LEVA COMMERCIALE</div><div class="row"><span class="label" style="color:#1e40af; width:120px;">Pain Points:</span> <span class="value" style="white-space:pre-wrap;">${val('propostaPainPoints')}</span></div><div class="row" style="margin-top:10px;"><span class="label" style="color:#1e40af; width:120px;">Argomentazione:</span> <span class="value"><i>"${val('propostaLeva')}"</i></span></div></div><h3>DOCUMENTI & OPZIONI</h3><div class="row"><span class="label">Documenti:</span> <span class="value">[${chk('checkFoto')}] Foto | [${chk('checkLuce')}] Luce | [${chk('checkGas')}] Gas</span></div><div class="row"><span class="label">Interessi:</span> <span class="value">[${chk('optLeasing')}] Leasing | [${chk('optIncentivi')}] Incentivi</span></div><div class="row"><span class="label">Budget:</span> <span class="value">${val('budgetNote')}</span></div><div class="row"><span class="label">Note Gen.:</span> <span class="value">${val('noteOpzioni')}</span></div><div class="row"><span class="label">Drive:</span> <span class="value">${val('linkDrive')}</span></div><div class="row"><span class="label">Earth:</span> <span class="value">${val('linkGoogleEarth')}</span></div><div class="row"><span class="label">Sito:</span> <span class="value">${val('linkSito')}</span></div><div class="row"><span class="label">IA Link:</span> <span class="value">${val('ia')}</span></div><div class="row"><span class="label">IA Link 2:</span> <span class="value">${val('ia2')}</span></div><div class="row"><span class="label">IA Link 3:</span> <span class="value">${val('ia3')}</span></div><div style="margin-top:40px;text-align:center;font-size:11px;color:#999;">Generato da Giulio Consulente Energetico</div></body></html>`; const win = window.open('', '_blank', 'height=800,width=800'); if(win) { win.document.write(html); win.document.close(); win.focus(); setTimeout(()=>win.print(),250); } else alert("Sblocca i popup!"); };

  if (view === 'dashboard') {
    return (
      <div className="space-y-6 relative">
        {/* --- RENDER MODALE CUSTOM (DASHBOARD) --- */}
        {dialog && (
            <div className="fixed inset-0 bg-black/50 z-[100] flex items-center justify-center p-4">
                <div className="bg-white rounded-xl p-6 max-w-sm w-full shadow-2xl animate-in fade-in zoom-in duration-200">
                    <h3 className="font-bold text-lg text-slate-800 mb-2">{dialog.title}</h3>
                    <p className="text-slate-600 mb-6 whitespace-pre-wrap">{dialog.message}</p>
                    <div className="flex justify-end gap-3">
                        {dialog.type === 'confirm' && (
                            <button onClick={dialog.onCancel} className="px-4 py-2 rounded-lg font-medium text-slate-600 hover:bg-slate-100 transition">Annulla</button>
                        )}
                        <button onClick={dialog.onConfirm} className="px-4 py-2 rounded-lg font-bold bg-blue-600 text-white hover:bg-blue-700 transition">OK</button>
                    </div>
                </div>
            </div>
        )}
        <div className="flex justify-between items-center bg-white p-6 rounded-xl shadow-sm border border-slate-200">
          <div><h2 className="text-2xl font-bold text-slate-800">I Tuoi Audit</h2><p className="text-slate-500">Gestisci i rilievi di tutti i tuoi clienti da qui.</p></div>
          <button onClick={handleNewAudit} className="bg-blue-600 text-white px-5 py-3 rounded-lg shadow-lg hover:bg-blue-700 flex items-center gap-2 font-bold transition transform hover:-translate-y-0.5"><Plus size={20} /> Nuovo Audit</button>
        </div>
        {loadingData ? <div className="text-center py-10"><Loader2 className="animate-spin mx-auto text-blue-500" size={32} /></div> : audits.length === 0 ? <div className="bg-white p-12 rounded-xl shadow border border-dashed border-slate-300 text-center text-slate-400"><FileText size={64} className="mx-auto mb-4 opacity-20" /><p className="text-lg">Nessun audit presente.</p><p className="text-sm">Clicca "Nuovo Audit" per iniziare.</p></div> : (<div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">{audits.map((a) => (<div key={a.id} onClick={() => handleEditAudit(a)} className="bg-white rounded-xl shadow-sm border border-slate-200 hover:shadow-md hover:border-blue-300 transition cursor-pointer group overflow-hidden relative"><div className={`h-1.5 w-full ${a.tipoCliente==='Azienda'?'bg-blue-500':a.tipoCliente==='Residenziale'?'bg-green-500':'bg-orange-500'}`}></div><div className="p-5"><div className="flex justify-between items-start mb-3"><div className="flex items-center gap-2"><div className={`p-1.5 rounded-md ${a.tipoCliente==='Azienda'?'bg-blue-50 text-blue-600':a.tipoCliente==='Residenziale'?'bg-green-50 text-green-600':'bg-orange-50 text-orange-600'}`}>{getIcon(a.tipoCliente)}</div><span className="text-xs font-bold uppercase text-slate-400">{a.tipoCliente}</span></div><button onClick={(e) => handleDeleteAudit(a.id, e)} className="text-slate-300 hover:text-red-500 transition"><Trash2 size={18} /></button></div><h3 className="font-bold text-lg text-slate-800 mb-1 truncate">{a.nomeSocieta || "Senza Nome"}</h3><p className="text-sm text-slate-500 flex items-center gap-1 mb-4"><span className="opacity-50">ðŸ“…</span> {a.dataRilievo}</p><div className="text-xs text-slate-500 bg-slate-50 p-2 rounded truncate border border-slate-100">ðŸ“ {a.indirizzo || 'Nessun indirizzo'}</div></div><div className="bg-slate-50 p-3 flex justify-between items-center text-xs font-medium text-slate-500 border-t border-slate-100"><span>{a.checkLuce ? 'âœ… Bollette OK' : 'âŒ Manca Luce'}</span><span className="flex items-center gap-1 group-hover:text-blue-600 transition">Apri <ChevronRight size={14} /></span></div></div>))}</div>)}
      </div>
    );
  }

  if (view === 'form' && !currentAudit) {
      return (
          <div className="flex flex-col items-center justify-center h-full text-slate-500">
              <Loader2 className="animate-spin mb-2" size={32}/>
              <p>Caricamento modulo...</p>
          </div>
      );
  }

  // --- CALCOLO TOTALI PER SEZIONE 6 RIEPILOGO ---
  const totDocceAtleti = currentAudit ? [1,2,3,4,5,6,7,8,9].reduce((acc, i) => acc + (parseInt(currentAudit[`numDocce${i}`]) || 0), 0) : 0;
  const totMqAtleti = currentAudit ? [1,2,3,4,5,6,7,8,9].reduce((acc, i) => acc + (parseFloat(currentAudit[`mqDocce${i}`]) || 0), 0) : 0;
  const totElemAtleti = currentAudit ? [1,2,3,4,5,6,7,8,9].reduce((acc, i) => acc + (parseInt(currentAudit[`elementiDocce${i}`]) || 0), 0) : 0;
  const totWattAtleti = currentAudit ? [1,2,3,4,5,6,7,8,9].reduce((acc, i) => currentAudit[`emissioneDocce${i}`] === 'Radiatori Elettrici' ? acc + ((parseInt(currentAudit[`elementiDocce${i}`]) || 0) * (parseInt(currentAudit[`wattDocce${i}`]) || 0)) : acc, 0) : 0;

  const totDocceArbitri = currentAudit ? [1,2,3].reduce((acc, i) => acc + (parseInt(currentAudit[`numDocceArbitri${i}`]) || 0), 0) : 0;
  const totMqArbitri = currentAudit ? [1,2,3].reduce((acc, i) => acc + (parseFloat(currentAudit[`mqDocceArbitri${i}`]) || 0), 0) : 0;
  const totElemArbitri = currentAudit ? [1,2,3].reduce((acc, i) => acc + (parseInt(currentAudit[`elementiDocceArbitri${i}`]) || 0), 0) : 0;
  const totWattArbitri = currentAudit ? [1,2,3].reduce((acc, i) => currentAudit[`emissioneDocceArbitri${i}`] === 'Radiatori Elettrici' ? acc + ((parseInt(currentAudit[`elementiDocceArbitri${i}`]) || 0) * (parseInt(currentAudit[`wattDocceArbitri${i}`]) || 0)) : acc, 0) : 0;

  const totGas = currentAudit ? (parseInt(currentAudit.consumoGas1)||0) + (parseInt(currentAudit.consumoGas2)||0) : 0;

  let totElec = 0;
  if (currentAudit) {
      if (currentAudit.tipoCliente === 'Residenziale') {
          totElec = (parseInt(currentAudit.consumoF1)||0) + (parseInt(currentAudit.consumoF2)||0) + (parseInt(currentAudit.consumoF3)||0);
      } else {
          totElec = [1, 2, 3].reduce((acc, i) => acc + (parseInt(currentAudit[`consumoF1_${i}`])||0) + (parseInt(currentAudit[`consumoF2_${i}`])||0) + (parseInt(currentAudit[`consumoF3_${i}`])||0), 0);
      }
  }

  const totVolume = currentAudit ? [1,2,3].reduce((acc, i) => acc + (parseFloat(currentAudit[`metriCubi${i}`]) || 0), 0) : 0;
  const totTerminali = currentAudit ? [1,2,3].reduce((acc, i) => acc + (parseInt(currentAudit[`numTerminali${i}`]) || 0), 0) : 0;
  const totFariKw = currentAudit ? ((parseInt(currentAudit.numFari) || 0) * (parseInt(currentAudit.potenzaFari) || 0) / 1000).toFixed(1) : 0;
  const totAccLitriASD = currentAudit ? (parseInt(currentAudit.accumulo1) || 0) + (parseInt(currentAudit.accumulo2) || 0) : 0;

  return (
    <div className="bg-white rounded-xl shadow-xl overflow-hidden border border-slate-200 flex flex-col h-full relative">
        {/* --- RENDER MODALE CUSTOM (FORM) --- */}
        {dialog && (
            <div className="fixed inset-0 bg-black/50 z-[100] flex items-center justify-center p-4">
                <div className="bg-white rounded-xl p-6 max-w-sm w-full shadow-2xl animate-in fade-in zoom-in duration-200">
                    <h3 className="font-bold text-lg text-slate-800 mb-2">{dialog.title}</h3>
                    <p className="text-slate-600 mb-6 whitespace-pre-wrap">{dialog.message}</p>
                    <div className="flex justify-end gap-3">
                        {dialog.type === 'confirm' && (
                            <button onClick={dialog.onCancel} className="px-4 py-2 rounded-lg font-medium text-slate-600 hover:bg-slate-100 transition">
                                {dialog.title.includes("Ottimo lavoro") ? "No, salva solo" : "Annulla"}
                            </button>
                        )}
                        <button onClick={dialog.onConfirm} className="px-4 py-2 rounded-lg font-bold bg-blue-600 text-white hover:bg-blue-700 transition">
                            {dialog.title.includes("Ottimo lavoro") ? "OK, Vai in Pipeline" : "OK"}
                        </button>
                    </div>
                </div>
            </div>
        )}
        
        <div className="bg-white border-b border-slate-200 p-4 flex flex-col md:flex-row justify-between items-center gap-4 sticky top-0 z-30 shadow-sm">
            <div className="flex bg-slate-100 p-1 rounded-lg">
                {['Azienda', 'Residenziale', 'ASD'].map(type => (
                    <button key={type} onClick={() => setCurrentAudit({...currentAudit, tipoCliente: type})} className={`px-4 py-2 rounded-md text-sm font-bold flex items-center gap-2 transition ${currentAudit.tipoCliente === type ? 'bg-white text-blue-700 shadow-sm ring-1 ring-black/5' : 'text-slate-500 hover:text-slate-700'}`}>{getIcon(type)} <span className="hidden sm:inline">{type}</span></button>
                ))}
            </div>
            <div className="flex items-center gap-2">
                {currentAudit.id && (
                    <button onClick={handleSendToPipeline} className="p-2.5 text-purple-600 bg-purple-50 rounded-lg hover:bg-purple-100 border border-purple-200 transition hidden lg:flex items-center gap-2 font-bold text-sm" title="Genera Lead in Pipeline">
                        <Kanban size={18} /> <span>Genera Lead</span>
                    </button>
                )}
                <button onClick={handleWhatsApp} className="p-2.5 text-green-600 bg-green-50 rounded-lg hover:bg-green-100 border border-green-200 transition" title="WhatsApp"><Share2 size={20} /></button>
                <button onClick={handlePrint} className="p-2.5 text-slate-600 bg-slate-50 rounded-lg hover:bg-slate-100 border border-slate-200 transition" title="Stampa"><Printer size={20} /></button>
                <div className="h-8 w-px bg-slate-300 mx-2 hidden md:block"></div>
                <button onClick={() => { setView('dashboard'); if(setActiveModule) setActiveModule('audits'); }} className="text-slate-500 font-medium hover:text-slate-800 px-3 hidden md:block">Annulla</button>
                <button onClick={handleSave} disabled={isSaving} className={`flex items-center gap-2 text-white px-6 py-2.5 rounded-lg font-bold shadow-md transition ${isSaving ? 'bg-blue-400' : 'bg-blue-600 hover:bg-blue-700'}`}>{isSaving ? <Loader2 size={20} className="animate-spin" /> : <Save size={20} />} Salva</button>
            </div>
        </div>
        <div className="p-6 md:p-8 space-y-8 overflow-y-auto bg-slate-50/50">
            <Section title="1. Anagrafica" icon="user" color="red">
            <div className="grid md:grid-cols-2 gap-5">
                {/* RIGA DATA E ORA MODIFICATA */}
                <div className="grid grid-cols-3 gap-2">
                    <Input label="Data Rilievo" type="date" value={currentAudit.dataRilievo || ''} onChange={v => setCurrentAudit({...currentAudit, dataRilievo: v})} />
                    <Input label="Data Incontro" type="date" value={currentAudit.prossimoIncontro || ''} onChange={v => setCurrentAudit({...currentAudit, prossimoIncontro: v})} />
                    <Input label="Ora" type="time" value={currentAudit.oraIncontro || ''} onChange={v => setCurrentAudit({...currentAudit, oraIncontro: v})} />
                </div>
                <Input label={currentAudit.tipoCliente === 'Residenziale' ? "Cognome Famiglia" : "Nome SocietÃ /ASD"} value={currentAudit.nomeSocieta || ''} onChange={v => setCurrentAudit({...currentAudit, nomeSocieta: v})} placeholder={currentAudit.tipoCliente === 'Residenziale' ? "Es. Famiglia Rossi" : "Es. Metalmeccanica SPA"} />
            </div>
            <Input label="Indirizzo Impianto" value={currentAudit.indirizzo || ''} onChange={v => setCurrentAudit({...currentAudit, indirizzo: v})} placeholder="Es. Via Torino 15, Collegno (TO)" />
            
            <div className="grid md:grid-cols-2 gap-5">
                <Input label="P.IVA / Codice Fiscale" value={currentAudit.piva || ''} onChange={v => setCurrentAudit({...currentAudit, piva: v})} placeholder="IT..." />
                <Input label="Indirizzo PEC" value={currentAudit.pec || ''} onChange={v => setCurrentAudit({...currentAudit, pec: v})} placeholder="posta@pec.it" />
            </div>

            <div className="grid md:grid-cols-2 gap-5"><Select label="Titolo Possesso" value={currentAudit.titoloPossesso || ''} onChange={v => setCurrentAudit({...currentAudit, titoloPossesso: v})} options={['ProprietÃ ', 'Affitto', 'Concessione', 'Altro']} /><Input label="Obiettivo Dichiarato" value={currentAudit.obiettivoCliente || ''} onChange={v => setCurrentAudit({...currentAudit, obiettivoCliente: v})} placeholder="Es. Risparmio bolletta, Ristrutturazione..." /></div>
            <div className="grid md:grid-cols-3 gap-3"><Input label="Presidente" value={currentAudit.presidente || ''} onChange={v => setCurrentAudit({...currentAudit, presidente: v})} placeholder="Nome" /><Input label="Tel. Presidente" value={currentAudit.telPresidente || ''} onChange={v => setCurrentAudit({...currentAudit, telPresidente: v})} placeholder="333..." /><Input label="Email Presidente" value={currentAudit.emailPresidente || ''} onChange={v => setCurrentAudit({...currentAudit, emailPresidente: v})} placeholder="@" /></div>
            <div className="grid md:grid-cols-3 gap-3"><Input label="Segretaria/o" value={currentAudit.segretaria || ''} onChange={v => setCurrentAudit({...currentAudit, segretaria: v})} placeholder="Nome" /><Input label="Tel. Segretaria/o" value={currentAudit.telSegretaria || ''} onChange={v => setCurrentAudit({...currentAudit, telSegretaria: v})} placeholder="333..." /><Input label="Email Segretaria/o" value={currentAudit.emailSegretaria || ''} onChange={v => setCurrentAudit({...currentAudit, emailSegretaria: v})} placeholder="@" /></div>
            <div className="grid md:grid-cols-2 gap-5"><Input label="Referente (Generico)" value={currentAudit.referente || ''} onChange={v => setCurrentAudit({...currentAudit, referente: v})} placeholder="Nome e Cognome" /><Input label="Telefono" value={currentAudit.telefono || ''} onChange={v => setCurrentAudit({...currentAudit, telefono: v})} placeholder="333..." /></div>
            <Input label="Email" value={currentAudit.email || ''} onChange={v => setCurrentAudit({...currentAudit, email: v})} placeholder="@email.it" />
            <Textarea label="Note Anagrafica" value={currentAudit.noteAnagrafica || ''} onChange={v => setCurrentAudit({...currentAudit, noteAnagrafica: v})} placeholder="Dettagli extra su contatti o orari..." />
            </Section>
            {currentAudit.tipoCliente === 'Azienda' && (<Section title="2. Dati Produttivi (Azienda)" icon="factory" color="purple">
                <Input label="Settore AttivitÃ " value={currentAudit.settoreAttivita || ''} onChange={v => setCurrentAudit({...currentAudit, settoreAttivita: v})} placeholder="Es. Stampaggio Plastica" />
                <Input label="Turni di Lavoro" value={currentAudit.turniLavoro || ''} onChange={v => setCurrentAudit({...currentAudit, turniLavoro: v})} placeholder="Es. Lun-Ven su 2 turni (06-22)" />
                <Input label="Macchinari Energivori" value={currentAudit.macchinari || ''} onChange={v => setCurrentAudit({...currentAudit, macchinari: v})} placeholder="Es. 3 Presse, 1 Forno industriale" />
                <div className="bg-purple-50 p-4 rounded-lg border border-purple-100"><Checkbox label="Presenza Cabina Elettrica (MT/BT)" checked={currentAudit.cabinaMT || false} onChange={c => setCurrentAudit({...currentAudit, cabinaMT: c})} /></div>
                
                {/* CONSUMI MULTI-UNITÃ€ (UNITA 1, 2, 3) - AZIENDA */}
                <div className="space-y-4 my-4">
                    <p className="font-bold text-sm text-purple-800 uppercase border-b border-purple-200 pb-1">Dettaglio Consumi Elettrici per UnitÃ  (POD)</p>
                    {[1, 2, 3].map(i => (
                        <div key={i} className="p-3 bg-purple-50/40 border border-purple-100 rounded-lg">
                                <p className="text-[10px] font-bold text-purple-700 mb-2 uppercase">UnitÃ  / POD {i}</p>
                                <div className="grid grid-cols-4 gap-2 items-end">
                                    <Input label="F1" type="number" value={currentAudit[`consumoF1_${i}`] || ''} onChange={v => setCurrentAudit({...currentAudit, [`consumoF1_${i}`]: v})} placeholder="0" />
                                    <Input label="F2" type="number" value={currentAudit[`consumoF2_${i}`] || ''} onChange={v => setCurrentAudit({...currentAudit, [`consumoF2_${i}`]: v})} placeholder="0" />
                                    <Input label="F3" type="number" value={currentAudit[`consumoF3_${i}`] || ''} onChange={v => setCurrentAudit({...currentAudit, [`consumoF3_${i}`]: v})} placeholder="0" />
                                    <div className="bg-white border border-purple-200 p-2 rounded text-center">
                                        <span className="block text-[9px] text-gray-400">TOTALE</span>
                                        <span className="font-bold text-sm">{(parseInt(currentAudit[`consumoF1_${i}`])||0) + (parseInt(currentAudit[`consumoF2_${i}`])||0) + (parseInt(currentAudit[`consumoF3_${i}`])||0)}</span>
                                    </div>
                                </div>
                        </div>
                    ))}
                    {/* GRANDE TOTALE */}
                    <div className="bg-purple-100 p-3 rounded-lg border border-purple-300 text-center">
                        <span className="block text-xs font-bold text-purple-900 uppercase mb-1">CONSUMO TOTALE ELETTRICO (Tutte le UnitÃ )</span>
                        <div className="text-xl font-bold text-slate-800">
                            {[1, 2, 3].reduce((acc, i) => acc + (parseInt(currentAudit[`consumoF1_${i}`])||0) + (parseInt(currentAudit[`consumoF2_${i}`])||0) + (parseInt(currentAudit[`consumoF3_${i}`])||0), 0)} kWh/anno
                        </div>
                    </div>
                </div>

                {/* CONSUMI GAS */}
                <div className="bg-white border border-red-200 p-3 rounded-lg mt-3 mb-3">
                     <p className="font-bold text-xs text-red-800 mb-2 uppercase flex items-center gap-1"><Flame size={12}/> Consumi Gas/Metano (Smc)</p>
                     <div className="grid grid-cols-3 gap-2 items-end">
                         <Input label="Contatore 1 (Smc)" type="number" value={currentAudit.consumoGas1 || ''} onChange={v => setCurrentAudit({...currentAudit, consumoGas1: v})} placeholder="0" />
                         <Input label="Contatore 2 (Smc)" type="number" value={currentAudit.consumoGas2 || ''} onChange={v => setCurrentAudit({...currentAudit, consumoGas2: v})} placeholder="0" />
                         <div className="bg-red-50 p-2 rounded text-center border border-red-100">
                             <span className="block text-[10px] font-bold text-red-800 uppercase">TOTALE SMC</span>
                             <span className="font-bold text-slate-800">{(parseInt(currentAudit.consumoGas1)||0) + (parseInt(currentAudit.consumoGas2)||0)}</span>
                         </div>
                     </div>
                </div>

                <Textarea label="Note Produttive" value={currentAudit.noteAzienda || ''} onChange={v => setCurrentAudit({...currentAudit, noteAzienda: v})} placeholder="Dettagli su picchi di consumo, ferie estive, ampliamenti futuri..." />
            </Section>)}
            {currentAudit.tipoCliente === 'Residenziale' && (<Section title="2. Dati Abitativi (Residenziale)" icon="home" color="green"><div className="grid md:grid-cols-2 gap-5"><Input label="Nucleo Familiare" type="number" value={currentAudit.nucleoFamiliare || ''} onChange={v => setCurrentAudit({...currentAudit, nucleoFamiliare: v})} placeholder="Es. 4" /><Input label="Abitudini Consumo" value={currentAudit.abitudini || ''} onChange={v => setCurrentAudit({...currentAudit, abitudini: v})} placeholder="Es. Prevalentemente Sera" /></div><Input label="Grandi Elettrodomestici" value={currentAudit.elettrodomestici || ''} onChange={v => setCurrentAudit({...currentAudit, elettrodomestici: v})} placeholder="Es. Induzione, 3 Split Aria Cond., Asciugatrice" /><div className="bg-green-50 p-4 rounded-lg border border-green-100"><Checkbox label="Possiede Auto Elettrica / Wallbox" checked={currentAudit.autoElettrica || false} onChange={c => setCurrentAudit({...currentAudit, autoElettrica: c})} /></div>
            
            <div className="bg-white border border-green-200 p-3 rounded-lg mt-3 mb-3">
                    <p className="font-bold text-xs text-green-800 mb-2 uppercase">Consumi Elettrici (kWh)</p>
                    <div className="grid grid-cols-4 gap-2 items-end">
                        <Input label="F1" type="number" value={currentAudit.consumoF1 || ''} onChange={v => setCurrentAudit({...currentAudit, consumoF1: v})} placeholder="0" />
                        <Input label="F2" type="number" value={currentAudit.consumoF2 || ''} onChange={v => setCurrentAudit({...currentAudit, consumoF2: v})} placeholder="0" />
                        <Input label="F3" type="number" value={currentAudit.consumoF3 || ''} onChange={v => setCurrentAudit({...currentAudit, consumoF3: v})} placeholder="0" />
                        <div className="bg-green-100 p-2 rounded text-center">
                            <span className="block text-[10px] font-bold text-green-800 uppercase">TOTALE</span>
                            <span className="font-bold text-slate-800">{(parseInt(currentAudit.consumoF1)||0) + (parseInt(currentAudit.consumoF2)||0) + (parseInt(currentAudit.consumoF3)||0)}</span>
                        </div>
                    </div>
            </div>

            {/* CONSUMI GAS RESIDENZIALE */}
            <div className="bg-white border border-red-200 p-3 rounded-lg mt-3 mb-3">
                    <p className="font-bold text-xs text-red-800 mb-2 uppercase flex items-center gap-1"><Flame size={12}/> Consumi Gas/Metano (Smc)</p>
                    <div className="grid grid-cols-3 gap-2 items-end">
                        <Input label="Contatore 1" type="number" value={currentAudit.consumoGas1 || ''} onChange={v => setCurrentAudit({...currentAudit, consumoGas1: v})} placeholder="0" />
                        <Input label="Contatore 2" type="number" value={currentAudit.consumoGas2 || ''} onChange={v => setCurrentAudit({...currentAudit, consumoGas2: v})} placeholder="0" />
                        <div className="bg-red-50 p-2 rounded text-center border border-red-100">
                            <span className="block text-[10px] font-bold text-red-800 uppercase">TOTALE SMC</span>
                            <span className="font-bold text-slate-800">{(parseInt(currentAudit.consumoGas1)||0) + (parseInt(currentAudit.consumoGas2)||0)}</span>
                        </div>
                    </div>
            </div>
            
            </Section>)}
            {currentAudit.tipoCliente === 'ASD' && (<Section title="2. Consumi & Superfici (ASD)" icon="trophy" color="yellow">
                
                {/* DOCCE ASD */}
                <div className="bg-yellow-50 p-4 rounded-lg border border-yellow-100 mb-4">
                    <div className="flex justify-between items-center mb-6 border-b border-yellow-200 pb-2">
                         <p className="font-bold text-sm text-yellow-800 flex items-center gap-2"><div className="w-2 h-2 bg-yellow-500 rounded-full"></div>Locali Docce</p>
                         <div className="bg-white px-3 py-1 rounded-md border border-yellow-300 shadow-sm text-sm font-bold text-yellow-800 flex items-center gap-2">
                             Totale Generale Docce: <span className="text-lg">
                                { [1,2,3,4,5,6,7,8,9].reduce((acc, i) => acc + (parseInt(currentAudit[`numDocce${i}`]) || 0), 0) + [1,2,3].reduce((acc, i) => acc + (parseInt(currentAudit[`numDocceArbitri${i}`]) || 0), 0) }
                             </span>
                         </div>
                    </div>
                    
                    {/* SPOGLIATOI ATLETI */}
                    <p className="text-xs font-bold text-yellow-800 uppercase mb-3 border-l-4 border-yellow-500 pl-2">Dettaglio Consumi Docce per Spogliatoio (Atleti)</p>
                    <div className="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4 mb-4">
                        {[1,2,3,4,5,6,7,8,9].map(i => (
                            <div key={`g${i}`} className="bg-white p-3 rounded-lg border border-yellow-200 shadow-sm hover:shadow-md transition">
                                <p className="text-[10px] font-bold text-slate-400 mb-2 uppercase flex justify-between">
                                    <span>Spogliatoio {i}</span>
                                    <span className="text-yellow-600">Giocatori</span>
                                </p>
                                <div className="space-y-2">
                                    <div className="grid grid-cols-2 gap-2">
                                        <Input label="N. Docce" type="number" value={currentAudit[`numDocce${i}`] || ''} onChange={v => setCurrentAudit({...currentAudit, [`numDocce${i}`]: v})} placeholder="0" />
                                        <Input label="Mq" type="number" value={currentAudit[`mqDocce${i}`] || ''} onChange={v => setCurrentAudit({...currentAudit, [`mqDocce${i}`]: v})} placeholder="Mq" />
                                    </div>
                                    <div className={`grid ${currentAudit[`emissioneDocce${i}`] === 'Radiatori' || currentAudit[`emissioneDocce${i}`] === 'Radiatori Elettrici' ? 'grid-cols-3' : 'grid-cols-2'} gap-2`}>
                                        <Select label="Emissione" value={currentAudit[`emissioneDocce${i}`] || ''} onChange={v => setCurrentAudit({...currentAudit, [`emissioneDocce${i}`]: v})} options={['Radiatori', 'Fan Coil', 'Pavimento', 'Split', 'Radiatori Elettrici']} />
                                        <Input label="N. Elementi" type="number" value={currentAudit[`elementiDocce${i}`] || ''} onChange={v => setCurrentAudit({...currentAudit, [`elementiDocce${i}`]: v})} placeholder="N." />
                                        {currentAudit[`emissioneDocce${i}`] === 'Radiatori' && (
                                            <Select label="Materiale" value={currentAudit[`matDocce${i}`] || ''} onChange={v => setCurrentAudit({...currentAudit, [`matDocce${i}`]: v})} options={['Ghisa', 'Acciaio', 'Alluminio']} />
                                        )}
                                        {currentAudit[`emissioneDocce${i}`] === 'Radiatori Elettrici' && (
                                            <Input label="Watt/cad." type="number" value={currentAudit[`wattDocce${i}`] || ''} onChange={v => setCurrentAudit({...currentAudit, [`wattDocce${i}`]: v})} placeholder="W" />
                                        )}
                                    </div>
                                </div>
                            </div>
                        ))}
                    </div>

                    {/* TOTALE ATLETI BARRA */}
                    <div className="bg-yellow-100 border-l-4 border-yellow-400 p-3 rounded-r-lg mb-8 flex justify-between items-center shadow-sm">
                        <div className="text-center">
                            <span className="block text-[10px] font-bold text-yellow-800 uppercase tracking-wider">Docce Atleti</span>
                            <span className="text-xl font-extrabold text-slate-800">{[1,2,3,4,5,6,7,8,9].reduce((acc, i) => acc + (parseInt(currentAudit[`numDocce${i}`]) || 0), 0)}</span>
                        </div>
                        <div className="text-center">
                            <span className="block text-[10px] font-bold text-yellow-800 uppercase tracking-wider">Mq Totali</span>
                            <span className="text-xl font-extrabold text-slate-800">{[1,2,3,4,5,6,7,8,9].reduce((acc, i) => acc + (parseFloat(currentAudit[`mqDocce${i}`]) || 0), 0)} mq</span>
                        </div>
                        <div className="text-center">
                            <span className="block text-[10px] font-bold text-yellow-800 uppercase tracking-wider">Elementi Tot.</span>
                            <span className="text-xl font-extrabold text-slate-800">{[1,2,3,4,5,6,7,8,9].reduce((acc, i) => acc + (parseInt(currentAudit[`elementiDocce${i}`]) || 0), 0)}</span>
                        </div>
                        <div className="text-center">
                            <span className="block text-[10px] font-bold text-yellow-800 uppercase tracking-wider">Potenza Elett.</span>
                            <span className="text-xl font-extrabold text-slate-800">{[1,2,3,4,5,6,7,8,9].reduce((acc, i) => currentAudit[`emissioneDocce${i}`] === 'Radiatori Elettrici' ? acc + ((parseInt(currentAudit[`elementiDocce${i}`]) || 0) * (parseInt(currentAudit[`wattDocce${i}`]) || 0)) : acc, 0)} W</span>
                        </div>
                    </div>

                    {/* SPOGLIATOI ARBITRI */}
                    <p className="text-xs font-bold text-yellow-800 uppercase mb-3 border-l-4 border-yellow-500 pl-2">Spogliatoi Arbitri</p>
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                        {[1,2,3].map(i => (
                            <div key={`a${i}`} className="bg-white p-3 rounded-lg border border-yellow-200 shadow-sm hover:shadow-md transition">
                                <p className="text-[10px] font-bold text-slate-400 mb-2 uppercase flex justify-between">
                                    <span>Spogliatoio {i}</span>
                                    <span className="text-yellow-600">Arbitri</span>
                                </p>
                                <div className="space-y-2">
                                    <div className="grid grid-cols-2 gap-2">
                                        <Input label="N. Docce" type="number" value={currentAudit[`numDocceArbitri${i}`] || ''} onChange={v => setCurrentAudit({...currentAudit, [`numDocceArbitri${i}`]: v})} placeholder="0" />
                                        <Input label="Mq" type="number" value={currentAudit[`mqDocceArbitri${i}`] || ''} onChange={v => setCurrentAudit({...currentAudit, [`mqDocceArbitri${i}`]: v})} placeholder="Mq" />
                                    </div>
                                    <div className={`grid ${currentAudit[`emissioneDocceArbitri${i}`] === 'Radiatori' || currentAudit[`emissioneDocceArbitri${i}`] === 'Radiatori Elettrici' ? 'grid-cols-3' : 'grid-cols-2'} gap-2`}>
                                        <Select label="Emissione" value={currentAudit[`emissioneDocceArbitri${i}`] || ''} onChange={v => setCurrentAudit({...currentAudit, [`emissioneDocceArbitri${i}`]: v})} options={['Radiatori', 'Fan Coil', 'Pavimento', 'Split', 'Radiatori Elettrici']} />
                                        <Input label="N. Elementi" type="number" value={currentAudit[`elementiDocceArbitri${i}`] || ''} onChange={v => setCurrentAudit({...currentAudit, [`elementiDocceArbitri${i}`]: v})} placeholder="N." />
                                        {currentAudit[`emissioneDocceArbitri${i}`] === 'Radiatori' && (
                                            <Select label="Materiale" value={currentAudit[`matDocceArbitri${i}`] || ''} onChange={v => setCurrentAudit({...currentAudit, [`matDocceArbitri${i}`]: v})} options={['Ghisa', 'Acciaio', 'Alluminio']} />
                                        )}
                                        {currentAudit[`emissioneDocceArbitri${i}`] === 'Radiatori Elettrici' && (
                                            <Input label="Watt/cad." type="number" value={currentAudit[`wattDocceArbitri${i}`] || ''} onChange={v => setCurrentAudit({...currentAudit, [`wattDocceArbitri${i}`]: v})} placeholder="W" />
                                        )}
                                    </div>
                                </div>
                            </div>
                        ))}
                    </div>

                    {/* TOTALE ARBITRI BARRA */}
                    <div className="bg-yellow-100 border-l-4 border-yellow-400 p-3 rounded-r-lg flex justify-between items-center shadow-sm">
                        <div className="text-center">
                            <span className="block text-[10px] font-bold text-yellow-800 uppercase tracking-wider">Docce Arbitri</span>
                            <span className="text-xl font-extrabold text-slate-800">{[1,2,3].reduce((acc, i) => acc + (parseInt(currentAudit[`numDocceArbitri${i}`]) || 0), 0)}</span>
                        </div>
                        <div className="text-center">
                            <span className="block text-[10px] font-bold text-yellow-800 uppercase tracking-wider">Mq Totali</span>
                            <span className="text-xl font-extrabold text-slate-800">{[1,2,3].reduce((acc, i) => acc + (parseFloat(currentAudit[`mqDocceArbitri${i}`]) || 0), 0)} mq</span>
                        </div>
                        <div className="text-center">
                            <span className="block text-[10px] font-bold text-yellow-800 uppercase tracking-wider">Elementi Tot.</span>
                            <span className="text-xl font-extrabold text-slate-800">{[1,2,3].reduce((acc, i) => acc + (parseInt(currentAudit[`elementiDocceArbitri${i}`]) || 0), 0)}</span>
                        </div>
                        <div className="text-center">
                            <span className="block text-[10px] font-bold text-yellow-800 uppercase tracking-wider">Potenza Elett.</span>
                            <span className="text-xl font-extrabold text-slate-800">{[1,2,3].reduce((acc, i) => currentAudit[`emissioneDocceArbitri${i}`] === 'Radiatori Elettrici' ? acc + ((parseInt(currentAudit[`elementiDocceArbitri${i}`]) || 0) * (parseInt(currentAudit[`wattDocceArbitri${i}`]) || 0)) : acc, 0)} W</span>
                        </div>
                    </div>
                </div>

                <div className="grid md:grid-cols-2 gap-5 mb-3">
                    <Input label="Utenti/Die (Media)" type="number" value={currentAudit.numUtenti || ''} onChange={v => setCurrentAudit({...currentAudit, numUtenti: v})} placeholder="Es. 40" />
                    <Select label="Orientamento FV" value={currentAudit.orientamento || ''} onChange={v => setCurrentAudit({...currentAudit, orientamento: v})} options={['Sud', 'Est/Ovest', 'Sud-Est', 'Sud-Ovest', 'Nord', 'Piano']} />
                </div>

                {/* RIGA SUPERFICI TECNICHE AGGIORNATA */}
                <div className="bg-yellow-50/50 p-3 rounded-lg border border-yellow-200 grid md:grid-cols-3 gap-5 mb-4">
                    <Input label="Superficie Tetto Utile (mq)" type="number" value={currentAudit.superficieTetto || ''} onChange={v => setCurrentAudit({...currentAudit, superficieTetto: v})} placeholder="Es. 200" />
                    <Input label="Centrale Termica 1 (mq)" type="number" value={currentAudit.ct1 || ''} onChange={v => setCurrentAudit({...currentAudit, ct1: v})} placeholder="Mq CT1" />
                    <Input label="Centrale Termica 2 (mq)" type="number" value={currentAudit.ct2 || ''} onChange={v => setCurrentAudit({...currentAudit, ct2: v})} placeholder="Mq CT2" />
                </div>
                
                {/* CONSUMI MULTI-UNITÃ€ (UNITA 1, 2, 3) */}
                <div className="space-y-4 my-4">
                    <p className="font-bold text-sm text-yellow-800 uppercase border-b border-yellow-200 pb-1">Dettaglio Consumi Elettrici per UnitÃ  (POD)</p>
                    {[1, 2, 3].map(i => (
                        <div key={i} className="p-3 bg-yellow-50/40 border border-yellow-100 rounded-lg">
                             <p className="text-[10px] font-bold text-yellow-700 mb-2 uppercase">UnitÃ  / POD {i}</p>
                             <div className="grid grid-cols-4 gap-2 items-end">
                                 <Input label="F1" type="number" value={currentAudit[`consumoF1_${i}`] || ''} onChange={v => setCurrentAudit({...currentAudit, [`consumoF1_${i}`]: v})} placeholder="0" />
                                 <Input label="F2" type="number" value={currentAudit[`consumoF2_${i}`] || ''} onChange={v => setCurrentAudit({...currentAudit, [`consumoF2_${i}`]: v})} placeholder="0" />
                                 <Input label="F3" type="number" value={currentAudit[`consumoF3_${i}`] || ''} onChange={v => setCurrentAudit({...currentAudit, [`consumoF3_${i}`]: v})} placeholder="0" />
                                 <div className="bg-white border border-yellow-200 p-2 rounded text-center">
                                     <span className="block text-[9px] text-gray-400">TOTALE</span>
                                     <span className="font-bold text-sm">{(parseInt(currentAudit[`consumoF1_${i}`])||0) + (parseInt(currentAudit[`consumoF2_${i}`])||0) + (parseInt(currentAudit[`consumoF3_${i}`])||0)}</span>
                                 </div>
                             </div>
                        </div>
                    ))}
                    {/* GRANDE TOTALE */}
                    <div className="bg-yellow-100 p-3 rounded-lg border border-yellow-300 text-center">
                        <span className="block text-xs font-bold text-yellow-900 uppercase mb-1">CONSUMO TOTALE ELETTRICO (Tutte le UnitÃ )</span>
                        <div className="text-xl font-bold text-slate-800">
                            {[1, 2, 3].reduce((acc, i) => acc + (parseInt(currentAudit[`consumoF1_${i}`])||0) + (parseInt(currentAudit[`consumoF2_${i}`])||0) + (parseInt(currentAudit[`consumoF3_${i}`])||0), 0)} kWh/anno
                        </div>
                    </div>
                </div>

                {/* CONSUMI GAS ASD */}
                <div className="bg-white border border-red-200 p-3 rounded-lg mt-3 mb-3">
                        <p className="font-bold text-xs text-red-800 mb-2 uppercase flex items-center gap-1"><Flame size={12}/> Consumi Gas/Metano (Smc)</p>
                        <div className="grid grid-cols-3 gap-2 items-end">
                            <Input label="Contatore 1" type="number" value={currentAudit.consumoGas1 || ''} onChange={v => setCurrentAudit({...currentAudit, consumoGas1: v})} placeholder="0" />
                            <Input label="Contatore 2" type="number" value={currentAudit.consumoGas2 || ''} onChange={v => setCurrentAudit({...currentAudit, consumoGas2: v})} placeholder="0" />
                            <div className="bg-red-50 p-2 rounded text-center border border-red-100">
                                <span className="block text-[10px] font-bold text-red-800 uppercase">TOTALE SMC</span>
                                <span className="font-bold text-slate-800">{(parseInt(currentAudit.consumoGas1)||0) + (parseInt(currentAudit.consumoGas2)||0)}</span>
                            </div>
                        </div>
                </div>

                <Textarea label="Orari Utilizzo" value={currentAudit.orari || ''} onChange={v => setCurrentAudit({...currentAudit, orari: v})} placeholder="Es. Lun-Ven 17-23" />
                <div className="bg-yellow-50 p-4 rounded-lg border border-yellow-100 mt-2">
                    <div className="font-bold text-sm text-yellow-800 mb-3 flex items-center gap-2"><div className="w-2 h-2 bg-yellow-500 rounded-full"></div>Illuminazione Campo</div>
                    <div className="grid md:grid-cols-2 gap-5">
                        <Input label="N. Fari" type="number" value={currentAudit.numFari || ''} onChange={v => setCurrentAudit({...currentAudit, numFari: v})} placeholder="Es. 4" />
                        <Input label="Potenza (W)" value={currentAudit.potenzaFari || ''} onChange={v => setCurrentAudit({...currentAudit, potenzaFari: v})} placeholder="Es. 2000W" />
                    </div>
                    <div className="bg-yellow-100/50 p-2.5 rounded-lg border border-yellow-200 flex flex-col justify-center mt-3">
                        <label className="block text-xs font-bold text-yellow-800 mb-1 uppercase">Totale Potenza</label>
                        <div className="text-lg font-bold text-slate-700">{((parseInt(currentAudit.numFari) || 0) * (parseInt(currentAudit.potenzaFari) || 0) / 1000).toFixed(1)} kW</div>
                    </div>
                </div>
                <Textarea label="Note Consumi" value={currentAudit.noteConsumi || ''} onChange={v => setCurrentAudit({...currentAudit, noteConsumi: v})} placeholder="Dettagli su utilizzo extra, tornei..." />
            </Section>)}
            
            {/* 3. DATI TECNICI & UNITÃ€ */}
            <Section title="3. Dati Tecnici & UnitÃ " icon="tool" color="orange">
                <div className="grid md:grid-cols-2 gap-5"><Select label="Tipo Tetto" value={currentAudit.tipoTetto || ''} onChange={v => setCurrentAudit({...currentAudit, tipoTetto: v})} options={['Piano - Guaina', 'Piano - Ghiaia', 'Falda - Tegole', 'Falda - Lamiera', 'Shed (Industriale)', 'Altro']} /><Input label="Ombreggianti" value={currentAudit.ombreggianti || ''} onChange={v => setCurrentAudit({...currentAudit, ombreggianti: v})} placeholder="Es. Camini, Antenne, Alberi, Edifici..." /></div>
                
                {/* CAMPi AGGIUNTIVI PER AZIENDA */}
                {currentAudit.tipoCliente === 'Azienda' && (
                    <div className="grid md:grid-cols-2 gap-5 bg-orange-50 p-3 rounded-lg border border-orange-100 mb-2">
                         <Input label="Superficie Tetto Utile (mq)" type="number" value={currentAudit.superficieTetto || ''} onChange={v => setCurrentAudit({...currentAudit, superficieTetto: v})} placeholder="Es. 500" />
                         <Select label="Orientamento FV" value={currentAudit.orientamento || ''} onChange={v => setCurrentAudit({...currentAudit, orientamento: v})} options={['Sud', 'Est/Ovest', 'Sud-Est', 'Sud-Ovest', 'Nord (Sconsigliato)', 'Piano (360Â°)']} />
                    </div>
                )}

                {/* LOOP UNITÃ€ CON TOTALI CALCOLATI AL VOLO */}
                <div className="space-y-4 my-2">
                    {[1, 2, 3].map(i => (
                        <div key={i} className="p-4 bg-orange-50/50 border border-orange-100 rounded-lg relative">
                            <span className="absolute top-0 left-0 bg-orange-200 text-orange-800 text-[10px] font-bold px-2 py-0.5 rounded-br-lg">UNITÃ€ {i}</span>
                            <div className="mt-4">
                                <div className="mb-3">
                                    <Input label={`Imp. Termico Attuale U${i}`} value={currentAudit[`impiantoTermico${i}`] || ''} onChange={v => setCurrentAudit({...currentAudit, [`impiantoTermico${i}`]: v})} placeholder="Es. Caldaia 24kW / Pompa di Calore" />
                                </div>
                                <div className="grid md:grid-cols-4 gap-3">
                                    <Input label={`Volume (mc)`} type="number" value={currentAudit[`metriCubi${i}`] || ''} onChange={v => setCurrentAudit({...currentAudit, [`metriCubi${i}`]: v})} placeholder="Es. 500" />
                                    <Select label={`Sistema Emissione`} value={currentAudit[`sistemaEmissione${i}`] || ''} onChange={v => setCurrentAudit({...currentAudit, [`sistemaEmissione${i}`]: v})} options={['Radiatori', 'Fan Coil', 'Pavimento', 'Split', 'Altro']} />
                                    <Input label={`N. Elementi`} type="number" value={currentAudit[`numTerminali${i}`] || ''} onChange={v => setCurrentAudit({...currentAudit, [`numTerminali${i}`]: v})} placeholder="Es. 10" />
                                    <Input label={`Contatore`} value={currentAudit[`contatore${i}`] || ''} onChange={v => setCurrentAudit({...currentAudit, [`contatore${i}`]: v})} placeholder="Es. 15kW" />
                                </div>
                            </div>
                        </div>
                    ))}
                    {/* TOTALI */}
                    <div className="grid md:grid-cols-3 gap-4 bg-orange-100/50 p-3 rounded-lg border border-orange-200 mt-2">
                         <div className="text-center">
                             <label className="block text-xs font-bold text-orange-800 mb-1 uppercase">Totale Volume</label>
                             <div className="text-lg font-bold text-slate-700">{[1,2,3].reduce((acc, i) => acc + (parseFloat(currentAudit[`metriCubi${i}`]) || 0), 0)} mc</div>
                         </div>
                         <div className="text-center">
                             <label className="block text-xs font-bold text-orange-800 mb-1 uppercase">Totale Elementi</label>
                             <div className="text-lg font-bold text-slate-700">{[1,2,3].reduce((acc, i) => acc + (parseInt(currentAudit[`numTerminali${i}`]) || 0), 0)}</div>
                         </div>
                         <div className="text-center">
                             <label className="block text-xs font-bold text-orange-800 mb-1 uppercase">Totale Potenza</label>
                             <div className="text-lg font-bold text-slate-700">{[1,2,3].reduce((acc, i) => acc + (parseFloat(currentAudit[`contatore${i}`]) || 0), 0)} kW</div>
                         </div>
                    </div>
                </div>

                {/* ACCUMULO DIFFERENZIATO PER ASD */}
                {currentAudit.tipoCliente === 'ASD' ? (
                    <div className="grid md:grid-cols-3 gap-4 mb-4">
                        <Input label="Accumulo Locale 1 (L)" type="number" value={currentAudit.accumulo1 || ''} onChange={v => setCurrentAudit({...currentAudit, accumulo1: v})} placeholder="Es. 300" />
                        <Input label="Accumulo Locale 2 (L)" type="number" value={currentAudit.accumulo2 || ''} onChange={v => setCurrentAudit({...currentAudit, accumulo2: v})} placeholder="Es. 200" />
                        <div className="bg-orange-50/50 p-2.5 rounded-lg border border-orange-200">
                            <label className="block text-xs font-bold text-orange-800 mb-1 uppercase">Totale Litri</label>
                            <div className="text-lg font-bold text-slate-700">{(parseInt(currentAudit.accumulo1) || 0) + (parseInt(currentAudit.accumulo2) || 0)} L</div>
                        </div>
                    </div>
                ) : (
                    <div className="grid md:grid-cols-2 gap-5">
                        <Select label="Accumulo" value={currentAudit.accumulo || ''} onChange={v => setCurrentAudit({...currentAudit, accumulo: v})} options={['No', 'SÃ¬']} />
                        <Input label="Dettagli Accumulo" value={currentAudit.dettagliAccumulo || ''} onChange={v => setCurrentAudit({...currentAudit, dettagliAccumulo: v})} placeholder="Es. 200L" />
                    </div>
                )}
                
                <Textarea label="Note Tecniche (Amianto, Accessi...)" value={currentAudit.noteTecniche || ''} onChange={v => setCurrentAudit({...currentAudit, noteTecniche: v})} placeholder="Dettagli tecnici rilevanti..." />
            </Section>
            
            {/* 4. OPZIONI & DOCS (Aggiornato: spostato dopo per lasciare spazio alla 5) */}
            <Section title="4. Opzioni & Documenti" icon="file" color="blue"><div className="flex flex-col md:flex-row gap-4 p-4 bg-blue-50/50 rounded-lg border border-blue-100 mb-4"><Checkbox label="Foto Tetto / Planimetria" checked={currentAudit.checkFoto || false} onChange={c => setCurrentAudit({...currentAudit, checkFoto: c})} /><Checkbox label="Ultime 3 Bollette LUCE" checked={currentAudit.checkLuce || false} onChange={c => setCurrentAudit({...currentAudit, checkLuce: c})} /><Checkbox label={`Ultime 3 Bollette GAS ${currentAudit.tipoCliente === 'Residenziale' ? '(o CI)' : ''}`} checked={currentAudit.checkGas || false} onChange={c => setCurrentAudit({...currentAudit, checkGas: c})} /></div><div className="flex gap-6 mb-4 px-2"><Checkbox label="Interesse Leasing/Finanz." checked={currentAudit.optLeasing || false} onChange={c => setCurrentAudit({...currentAudit, optLeasing: c})} /><Checkbox label="Incentivi / CER" checked={currentAudit.optIncentivi || false} onChange={c => setCurrentAudit({...currentAudit, optIncentivi: c})} /></div><Textarea label="Note Budget" value={currentAudit.budgetNote || ''} onChange={v => setCurrentAudit({...currentAudit, budgetNote: v})} placeholder="Es. Budget prefissato..." /><Input label="Link Drive" value={currentAudit.linkDrive || ''} onChange={v => setCurrentAudit({...currentAudit, linkDrive: v})} placeholder="Link Cloud..." isLink={true} /><Input label="Link Google Earth" value={currentAudit.linkGoogleEarth || ''} onChange={v => setCurrentAudit({...currentAudit, linkGoogleEarth: v})} placeholder="Link Maps/Earth..." isLink={true} /><Input label="Sito Web" value={currentAudit.linkSito || ''} onChange={v => setCurrentAudit({...currentAudit, linkSito: v})} placeholder="www..." isLink={true} /><Input label="IA" value={currentAudit.ia || ''} onChange={v => setCurrentAudit({...currentAudit, ia: v})} placeholder="Link analisi AI..." isLink={true} /><Input label="IA Link 2" value={currentAudit.ia2 || ''} onChange={v => setCurrentAudit({...currentAudit, ia2: v})} placeholder="Link analisi AI 2..." isLink={true} /><Input label="IA Link 3" value={currentAudit.ia3 || ''} onChange={v => setCurrentAudit({...currentAudit, ia3: v})} placeholder="Link analisi AI 3..." isLink={true} /><Textarea label="Note Generali / Documenti" value={currentAudit.noteOpzioni || ''} onChange={v => setCurrentAudit({...currentAudit, noteOpzioni: v})} placeholder="Note aggiuntive su documenti mancanti o dettagli..." /></Section>

            {/* 5. LA MIA PROPOSTA (NUOVO) */}
            <Section title="5. La mia proposta per il Dimensionamento" icon="zap" color="indigo">
                <div className="flex justify-between items-center mb-4">
                    <span className="text-sm text-indigo-700 font-medium">Compila tu o chiedi all'AI (Analisi Commerciale Avanzata)</span>
                    <button onClick={generateAIProposal} disabled={isGenerating} className="bg-indigo-600 text-white px-3 py-1.5 rounded-lg text-xs font-bold flex items-center gap-2 hover:bg-indigo-700 shadow-sm transition disabled:opacity-50">
                        {isGenerating ? <Loader2 size={14} className="animate-spin" /> : <Sparkles size={14} />} {isGenerating ? 'Analizzando...' : 'Genera Strategia AI'}
                    </button>
                </div>
                
                <div className="grid md:grid-cols-2 gap-5 mb-5">
                    <Input label="Potenza Fotovoltaico (kW)" value={currentAudit.propostaFV || ''} onChange={v => setCurrentAudit({...currentAudit, propostaFV: v})} placeholder="Es. 20 kWp (50 pannelli)" />
                    <Input label="Accumulo (kWh)" value={currentAudit.propostaAccumulo || ''} onChange={v => setCurrentAudit({...currentAudit, propostaAccumulo: v})} placeholder="Es. 30 kWh LFP" />
                </div>
                <Input label="Soluzione Termica" value={currentAudit.propostaTermico || ''} onChange={v => setCurrentAudit({...currentAudit, propostaTermico: v})} placeholder="Es. 2x Pompa di Calore ACS 300L" />
                <div className="mt-5"><Textarea label="Note di Dimensionamento / Dettagli Tecnici" value={currentAudit.propostaNote || ''} onChange={v => setCurrentAudit({...currentAudit, propostaNote: v})} placeholder="Es. Installazione su falda sud, Inverter ibrido, Linea vita necessaria..." /></div>

                {/* NUOVI CAMPI COMMERCIALI AI */}
                <div className="mt-6 border-t border-indigo-100 pt-6">
                    <h4 className="text-sm font-bold text-indigo-800 flex items-center gap-2 mb-4"><Target size={16}/> Strategia di Chiusura</h4>
                    <div className="space-y-4">
                        <div>
                            <label className="block text-xs font-bold text-slate-500 mb-1.5 uppercase tracking-wide">I 3 Pain Points risolti (Le leve del bisogno)</label>
                            <textarea rows={3} value={currentAudit.propostaPainPoints || ''} onChange={e => setCurrentAudit({...currentAudit, propostaPainPoints: e.target.value})} placeholder="Es. 1. Protezione dal rincaro bollette per le celle frigo..." className="w-full p-3 bg-indigo-50/30 border border-indigo-200 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none transition text-slate-700 text-sm" />
                        </div>
                        <div>
                            <label className="block text-xs font-bold text-slate-500 mb-1.5 uppercase tracking-wide">Argomentazione Forte di Chiusura (Pitch)</label>
                            <textarea rows={2} value={currentAudit.propostaLeva || ''} onChange={e => setCurrentAudit({...currentAudit, propostaLeva: e.target.value})} placeholder="Es. Con l'iperammortamento al 6%, l'impianto si ripaga in 3 anni azzerando il costo fisso del..." className="w-full p-3 bg-emerald-50/50 border border-emerald-200 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 outline-none transition text-slate-800 font-medium text-sm" />
                        </div>
                    </div>
                </div>
            </Section>
            
            {/* 6. RIEPILOGO RISULTATI (TOTALI EVIDENZIATI) */}
            <Section title="6. Riepilogo Risultati" color="slate">
                <div className="space-y-4">
                    {/* Consumi Principali - Tutte le tipologie */}
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div className="bg-sky-50 border-l-4 border-sky-400 p-4 rounded-r-xl shadow-sm flex justify-between items-center">
                            <div>
                                <span className="block text-xs font-bold text-sky-800 uppercase tracking-wider">Consumo Totale Elettrico</span>
                                <span className="text-sm text-sky-600">Tutte le unitÃ /fasce</span>
                            </div>
                            <span className="text-2xl font-black text-sky-900">{totElec} <span className="text-sm font-bold">kWh/anno</span></span>
                        </div>
                        <div className="bg-rose-50 border-l-4 border-rose-400 p-4 rounded-r-xl shadow-sm flex justify-between items-center">
                            <div>
                                <span className="block text-xs font-bold text-rose-800 uppercase tracking-wider">Totale Gas / Metano</span>
                                <span className="text-sm text-rose-600">Somma contatori</span>
                            </div>
                            <span className="text-2xl font-black text-rose-900">{totGas} <span className="text-sm font-bold">Smc/anno</span></span>
                        </div>
                    </div>

                    {/* Specifico ASD */}
                    {currentAudit.tipoCliente === 'ASD' && (
                        <>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div className="bg-yellow-100 border-l-4 border-yellow-500 p-4 rounded-r-xl shadow-sm flex justify-between items-center">
                                    <div>
                                        <span className="block text-xs font-bold text-yellow-800 uppercase tracking-wider">Docce Atleti</span>
                                        <span className="text-sm text-yellow-700 font-medium">{totDocceAtleti} docce | {totMqAtleti} mq | {totElemAtleti} elem.</span>
                                    </div>
                                    {totWattAtleti > 0 && <span className="text-lg font-black text-yellow-900">{totWattAtleti} <span className="text-xs">W Elett.</span></span>}
                                </div>

                                <div className="bg-green-100 border-l-4 border-green-500 p-4 rounded-r-xl shadow-sm flex justify-between items-center">
                                    <div>
                                        <span className="block text-xs font-bold text-green-800 uppercase tracking-wider">Docce Arbitri</span>
                                        <span className="text-sm text-green-700 font-medium">{totDocceArbitri} docce | {totMqArbitri} mq | {totElemArbitri} elem.</span>
                                    </div>
                                    {totWattArbitri > 0 && <span className="text-lg font-black text-green-900">{totWattArbitri} <span className="text-xs">W Elett.</span></span>}
                                </div>
                            </div>
                            
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div className="bg-amber-50 border-l-4 border-amber-400 p-4 rounded-r-xl shadow-sm flex justify-between items-center">
                                    <div>
                                        <span className="block text-xs font-bold text-amber-800 uppercase tracking-wider">Potenza Fari Campo</span>
                                        <span className="text-sm text-amber-600 font-medium">{currentAudit.numFari || 0} fari da {currentAudit.potenzaFari || 0}W</span>
                                    </div>
                                    <span className="text-xl font-black text-amber-900">{totFariKw} <span className="text-sm">kW</span></span>
                                </div>
                                <div className="bg-blue-50 border-l-4 border-blue-400 p-4 rounded-r-xl shadow-sm flex justify-between items-center">
                                    <div>
                                        <span className="block text-xs font-bold text-blue-800 uppercase tracking-wider">Accumulo ACS</span>
                                        <span className="text-sm text-blue-600 font-medium">Locale 1 + Locale 2</span>
                                    </div>
                                    <span className="text-xl font-black text-blue-900">{totAccLitriASD} <span className="text-sm">Litri</span></span>
                                </div>
                            </div>
                        </>
                    )}

                    {/* Totali Tecnici di base (Volume e Tetto) */}
                    <div className="bg-slate-100 border-l-4 border-slate-400 p-4 rounded-r-xl shadow-sm">
                        <div className="flex flex-col sm:flex-row justify-between items-center gap-4">
                            <div className="flex-1 text-center w-full sm:border-r border-slate-300">
                                <span className="block text-[10px] font-bold text-slate-500 uppercase tracking-wider">Volume Totale</span>
                                <span className="text-xl font-black text-slate-800">{totVolume} <span className="text-xs font-medium">mc</span></span>
                            </div>
                            <div className="flex-1 text-center w-full sm:border-r border-slate-300">
                                <span className="block text-[10px] font-bold text-slate-500 uppercase tracking-wider">Terminali Termici</span>
                                <span className="text-xl font-black text-slate-800">{totTerminali} <span className="text-xs font-medium">elem.</span></span>
                            </div>
                            <div className="flex-1 text-center w-full">
                                <span className="block text-[10px] font-bold text-slate-500 uppercase tracking-wider">Superficie Tetto</span>
                                <span className="text-xl font-black text-slate-800">{currentAudit.superficieTetto || 0} <span className="text-xs font-medium">mq</span></span>
                            </div>
                        </div>
                    </div>
                </div>
            </Section>

            <div className="h-10"></div>
        </div>
    </div>
  );
}

// --- UTILS & PLACEHOLDERS ---
const MenuItem = ({ icon, label, active, onClick, badge }) => (<button onClick={onClick} className={`w-full flex items-center gap-3 px-3 py-2.5 rounded-lg transition-all duration-200 ${active ? 'bg-blue-600 text-white shadow-lg shadow-blue-900/20' : 'text-slate-300 hover:text-white hover:bg-[#1a3550]'}`}>{icon} <span className="font-medium text-sm flex-1 text-left">{label}</span> {badge && <span className="text-[10px] uppercase font-bold bg-[#1a3550] text-slate-300 px-1.5 py-0.5 rounded border border-[#142a40]">{badge}</span>}</button>);
const PlaceholderModule = ({ title, icon, desc }) => (<div className="flex flex-col items-center justify-center h-full text-center p-8 bg-white rounded-xl shadow-sm border border-slate-200"><div className="bg-slate-50 p-6 rounded-full mb-4 text-slate-400">{icon}</div><h2 className="text-2xl font-bold text-slate-800 mb-2">{title}</h2><p className="text-slate-500 max-w-md">{desc}</p></div>);
const Section = ({ title, color, children }) => { const colors = { red: 'border-l-red-500', yellow: 'border-l-yellow-500', orange: 'border-l-orange-500', blue: 'border-l-blue-500', purple: 'border-l-purple-500', green: 'border-l-green-500', indigo: 'border-l-indigo-500', slate: 'border-l-slate-500' }; return (<div className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden"><div className={`p-4 border-b border-slate-100 flex items-center gap-2 bg-white ${colors[color] || colors.blue} border-l-4`}><h3 className="font-bold text-slate-800">{title}</h3></div><div className="p-6 space-y-5">{children}</div></div>); };
const Input = ({ label, type = "text", value, onChange, placeholder, isLink = false }) => { const openLink = () => { if (!value) return; let url = value.trim(); if (!/^https?:\/\//i.test(url)) url = 'https://' + url; window.open(url, '_blank'); }; return (<div><label className="block text-xs font-bold text-slate-500 mb-1.5 uppercase tracking-wide">{label}</label><div className="relative"><input type={type} value={value} onChange={e => onChange(e.target.value)} placeholder={placeholder} className={`w-full p-2.5 bg-white border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition text-slate-700 ${isLink ? 'pr-10 text-blue-600 underline' : ''}`} />{isLink && value && (<button onClick={openLink} className="absolute right-2 top-1/2 transform -translate-y-1/2 text-blue-600 bg-blue-50 hover:bg-blue-100 p-1.5 rounded-md transition" type="button"><ExternalLink size={16} /></button>)}</div></div>); };
const Textarea = ({ label, value, onChange, placeholder }) => (<div><label className="block text-xs font-bold text-slate-500 mb-1.5 uppercase tracking-wide">{label}</label><textarea rows={2} value={value} onChange={e => onChange(e.target.value)} placeholder={placeholder} className="w-full p-2.5 bg-white border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition text-slate-700" /></div>);
const Select = ({ label, value, onChange, options }) => (<div><label className="block text-xs font-bold text-slate-500 mb-1.5 uppercase tracking-wide">{label}</label><div className="relative"><select value={value} onChange={e => onChange(e.target.value)} className="w-full p-2.5 bg-white border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition text-slate-700 appearance-none"><option value="">-- Seleziona --</option>{options.map(o => <option key={o} value={o}>{o}</option>)}</select><div className="absolute right-3 top-1/2 transform -translate-y-1/2 pointer-events-none text-slate-400"><svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 9l-7 7-7-7"></path></svg></div></div></div>);
const Checkbox = ({ label, checked, onChange }) => (<label className="flex items-center cursor-pointer select-none group"><div className={`w-5 h-5 rounded border flex items-center justify-center mr-3 transition ${checked ? 'bg-blue-600 border-blue-600 text-white' : 'bg-white border-slate-300 text-transparent group-hover:border-blue-400'}`}><svg className="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="3" d="M5 13l4 4L19 7"></path></svg></div><input type="checkbox" checked={checked} onChange={e => onChange(e.target.checked)} className="hidden" /><span className={`text-sm font-medium transition ${checked ? 'text-slate-800' : 'text-slate-600'}`}>{label}</span></label>);

// --- MODULO: ROI CALCULATOR B2B ---
function RoiCalculatorModule() {
    const [kwp, setKwp] = useState('50');
    const [costPerKw, setCostPerKw] = useState('1100');
    const [energyCost, setEnergyCost] = useState('0.22');
    const [pun, setPun] = useState('0.10');
    const [selfConsumption, setSelfConsumption] = useState('80');
    const [taxCredit, setTaxCredit] = useState('6'); // Es. Transizione 5.0 base o superammortamento
    const [productionYield, setProductionYield] = useState('1200'); // kWh/kWp Nord Italia standard

    // Calcoli Finanziari
    const totalInvestment = parseFloat(kwp || 0) * parseFloat(costPerKw || 0);
    const yearlyProduction = parseFloat(kwp || 0) * parseFloat(productionYield || 0);
    
    const selfConsumedKwh = yearlyProduction * (parseFloat(selfConsumption || 0) / 100);
    const exportedKwh = yearlyProduction - selfConsumedKwh;
    
    const savingsAverted = selfConsumedKwh * parseFloat(energyCost || 0);
    const revenueExported = exportedKwh * parseFloat(pun || 0);
    
    const totalYearlyCashflow = savingsAverted + revenueExported;
    const taxBenefitTotal = totalInvestment * (parseFloat(taxCredit || 0) / 100);
    const taxBenefitYearly = taxBenefitTotal / 5; // Spalmato su 5 anni per semplicitÃ  commerciale

    const paybackYears = totalYearlyCashflow > 0 ? totalInvestment / (totalYearlyCashflow + taxBenefitYearly) : 0;
    const roiPercentage = totalInvestment > 0 ? (totalYearlyCashflow / totalInvestment) * 100 : 0;

    const formatCurrency = (val) => new Intl.NumberFormat('it-IT', { style: 'currency', currency: 'EUR', maximumFractionDigits: 0 }).format(val);

    // FUNZIONE STAMPA GUIDA AL CLIENTE
    const handlePrintGuide = () => {
        const html = `
            <html>
            <head>
                <title>Guida Parametri ROI - Cliente</title>
                <style>
                    body { font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; padding: 40px; color: #333; line-height: 1.6; font-size: 14px; max-width: 800px; margin: 0 auto; background: #fff; }
                    h1 { color: #214263; border-bottom: 2px solid #214263; padding-bottom: 10px; margin-bottom: 30px; font-size: 24px; }
                    h3 { color: #1a3550; font-size: 18px; margin-top: 30px; border-left: 4px solid #10b981; padding-left: 10px; }
                    .param-box { background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px; padding: 15px; margin-bottom: 15px; page-break-inside: avoid; }
                    .param-title { font-weight: bold; color: #0f172a; font-size: 15px; margin-bottom: 5px; }
                    .param-desc { color: #475569; font-size: 13px; }
                    .highlight { color: #10b981; font-weight: bold; }
                    .footer { margin-top: 50px; text-align: center; font-size: 11px; color: #94a3b8; border-top: 1px solid #e2e8f0; padding-top: 20px; }
                </style>
            </head>
            <body>
                <h1>ðŸ“Š Guida alla Lettura del Business Plan Energetico</h1>
                <p>Gentile Cliente, questo documento illustra in modo trasparente i parametri tecnici e finanziari utilizzati per elaborare la simulazione economica (ROI e Tempo di Rientro) del Suo futuro impianto fotovoltaico aziendale.</p>
                
                <h3>1. Parametri di Dimensionamento</h3>
                
                <div class="param-box">
                    <div class="param-title">Potenza Impianto (kWp)</div>
                    <div class="param-desc">La capacitÃ  produttiva massima dell'impianto in condizioni standard. Rappresenta il "motore" del risparmio: maggiore Ã¨ la potenza in relazione ai consumi diurni, maggiore sarÃ  l'energia generata per abbattere i costi aziendali.</div>
                </div>
                
                <div class="param-box">
                    <div class="param-title">Costo Specifico (â‚¬/kWp)</div>
                    <div class="param-desc">L'investimento unitario "chiavi in mano" per ogni kilowatt installato. Comprende tutte le voci necessarie: moduli fotovoltaici, inverter, strutture di fissaggio, manodopera specializzata, progettazione ingegneristica e pratiche autorizzative/GSE.</div>
                </div>
                
                <div class="param-box">
                    <div class="param-title">Resa Specifica (kWh/kWp/anno)</div>
                    <div class="param-desc">La stima prudenziale dell'energia effettivamente prodotta da 1 kWp di impianto nell'arco di un anno, calcolata in base alla posizione geografica del Suo immobile e all'orientamento/inclinazione della copertura.</div>
                </div>

                <h3>2. Parametri Economici e di Consumo</h3>

                <div class="param-box">
                    <div class="param-title">Costo Energia in Bolletta (â‚¬/kWh)</div>
                    <div class="param-desc">Il costo medio della materia prima energia (inclusi oneri variabili, dispacciamento e accise) che la Sua azienda <span class="highlight">evita di pagare</span> al fornitore per ogni kWh autoprodotto e consumato istantaneamente.</div>
                </div>

                <div class="param-box">
                    <div class="param-title">Autoconsumo Stimato (%)</div>
                    <div class="param-desc">La percentuale di energia prodotta dall'impianto che viene consumata in tempo reale dalle utenze aziendali. Questo Ã¨ il parametro cruciale per massimizzare il ritorno sull'investimento (il kWh risparmiato vale piÃ¹ di quello venduto).</div>
                </div>

                <div class="param-box">
                    <div class="param-title">Valore Energia Immessa / PUN (â‚¬/kWh)</div>
                    <div class="param-desc">Il prezzo a cui l'energia prodotta in eccesso (ad esempio nei weekend o in caso di fermo produttivo) viene ritirata e remunerata sulla rete nazionale tramite il meccanismo del Ritiro Dedicato gestito dal GSE.</div>
                </div>

                <div class="param-box">
                    <div class="param-title">Credito d'Imposta / Agevolazioni (%)</div>
                    <div class="param-desc">L'impatto percentuale degli incentivi statali attuali (es. PNRR Transizione 5.0, Nuova Sabatini, bandi regionali) che abbattono significativamente il costo reale dell'investimento recuperando liquiditÃ  in compensazione fiscale.</div>
                </div>

                <h3>3. Indicatori Finanziari Strategici (KPI)</h3>

                <div class="param-box">
                    <div class="param-title">Tempo di Rientro (Payback Period)</div>
                    <div class="param-desc">Il numero di anni necessari affinchÃ© i flussi di cassa netti positivi generati dall'impianto (risparmio netto in bolletta + valorizzazione immissioni in rete + benefici fiscali) eguaglino l'esborso dell'investimento iniziale. Da quel momento, l'impianto genera utile puro.</div>
                </div>

                <div class="param-box">
                    <div class="param-title">Rendimento Annuo sull'Investimento (ROI)</div>
                    <div class="param-desc">Il tasso percentuale di redditivitÃ  annua del capitale investito. Nell'attuale scenario di mercato, l'efficienza energetica industriale rappresenta uno degli investimenti aziendali piÃ¹ sicuri, prevedibili e con la resa percentuale piÃ¹ elevata rispetto agli strumenti finanziari tradizionali.</div>
                </div>

                <div class="footer">
                    Documento ad uso informativo per la valutazione preliminare dell'investimento energetico.<br>
                    <strong>Generato da Giulio - Consulente Energetico B2B</strong>
                </div>
            </body>
            </html>
        `;
        const win = window.open('', '_blank', 'height=800,width=800'); 
        if(win) { 
            win.document.write(html); 
            win.document.close(); 
            win.focus(); 
            setTimeout(()=>win.print(), 250); 
        } else {
            alert("Sblocca i popup del browser per poter stampare la guida!");
        }
    };

    return (
        <div className="max-w-5xl mx-auto space-y-6">
            <div className="flex flex-col sm:flex-row justify-between items-start sm:items-end gap-4 mb-4">
                <div>
                    <h2 className="text-2xl font-bold text-slate-800 flex items-center gap-2"><PieChart className="text-indigo-600" size={28} /> Calcolatore ROI (B2B)</h2>
                    <p className="text-slate-500">Genera stime economiche istantanee per impianti commerciali e industriali.</p>
                </div>
                <button onClick={handlePrintGuide} className="bg-white border border-indigo-200 text-indigo-700 px-4 py-2 rounded-lg font-bold shadow-sm hover:bg-indigo-50 flex items-center gap-2 transition">
                    <Printer size={18} /> Stampa Guida Cliente
                </button>
            </div>

            <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                {/* SETTINGS PANEL */}
                <div className="lg:col-span-1 bg-white p-6 rounded-xl shadow-sm border border-slate-200 space-y-5">
                    <p className="font-bold text-sm text-indigo-800 uppercase border-b border-slate-100 pb-2 mb-4 flex items-center gap-2"><Settings size={16}/> Parametri Impianto</p>
                    
                    <Input label="Potenza Impianto (kWp)" type="number" value={kwp} onChange={setKwp} placeholder="Es. 50" />
                    <Input label="Costo Specifico (â‚¬/kWp)" type="number" value={costPerKw} onChange={setCostPerKw} placeholder="Es. 1100" />
                    <div className="h-px w-full bg-slate-100 my-4"></div>
                    <Input label="Costo Energia in Bolletta (â‚¬/kWh)" type="number" value={energyCost} onChange={setEnergyCost} placeholder="Es. 0.22" />
                    <Input label="Autoconsumo Stimato (%)" type="number" value={selfConsumption} onChange={setSelfConsumption} placeholder="Es. 80" />
                    <Input label="Valore Energia Immessa / PUN (â‚¬/kWh)" type="number" value={pun} onChange={setPun} placeholder="Es. 0.10" />
                    <div className="h-px w-full bg-slate-100 my-4"></div>
                    <Input label="Resa Specifica (kWh/kWp/anno)" type="number" value={productionYield} onChange={setProductionYield} placeholder="Es. 1200" />
                    <Input label="Credito d'Imposta / Agevolazioni (%)" type="number" value={taxCredit} onChange={setTaxCredit} placeholder="Es. 6" />
                </div>

                {/* RESULTS PANEL */}
                <div className="lg:col-span-2 space-y-6 flex flex-col">
                    {/* PRIMARY KPIs */}
                    <div className="grid grid-cols-2 gap-4">
                        <div className="bg-indigo-600 text-white p-6 rounded-xl shadow-lg relative overflow-hidden">
                            <div className="absolute top-0 right-0 p-4 opacity-20"><TrendingUp size={64}/></div>
                            <p className="text-indigo-200 text-xs font-bold uppercase tracking-wider mb-1">Tempo di Rientro</p>
                            <div className="text-4xl font-black">{paybackYears > 0 ? paybackYears.toFixed(1) : '-'} <span className="text-xl font-medium">Anni</span></div>
                            <p className="text-indigo-100 text-sm mt-2">Incluso beneficio fiscale</p>
                        </div>
                        <div className="bg-emerald-600 text-white p-6 rounded-xl shadow-lg relative overflow-hidden">
                            <div className="absolute top-0 right-0 p-4 opacity-20"><DollarSign size={64}/></div>
                            <p className="text-emerald-200 text-xs font-bold uppercase tracking-wider mb-1">Rendimento Annuo (ROI)</p>
                            <div className="text-4xl font-black">{roiPercentage > 0 ? roiPercentage.toFixed(1) : '-'} <span className="text-xl font-medium">%</span></div>
                            <p className="text-emerald-100 text-sm mt-2">Cashflow su Investimento</p>
                        </div>
                    </div>

                    {/* DETAILED BREAKDOWN */}
                    <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-200 flex-1">
                        <p className="font-bold text-sm text-slate-800 uppercase border-b border-slate-100 pb-2 mb-4 flex items-center gap-2"><BarChart3 size={16}/> Breakdown Economico</p>
                        
                        <div className="space-y-4">
                            <div className="flex justify-between items-center p-3 bg-slate-50 rounded-lg">
                                <span className="text-slate-600 font-medium">Investimento Totale (CAPEX)</span>
                                <span className="text-lg font-bold text-slate-800">{formatCurrency(totalInvestment)}</span>
                            </div>
                            
                            <div className="grid grid-cols-2 gap-4">
                                <div className="p-3 border border-slate-100 rounded-lg">
                                    <span className="block text-[10px] uppercase font-bold text-slate-400 mb-1">Risparmio Bolletta (Annuo)</span>
                                    <span className="text-xl font-bold text-emerald-600">+{formatCurrency(savingsAverted)}</span>
                                    <span className="block text-xs text-slate-500 mt-1">{selfConsumedKwh.toLocaleString('it-IT', {maximumFractionDigits:0})} kWh autoconsumati</span>
                                </div>
                                <div className="p-3 border border-slate-100 rounded-lg">
                                    <span className="block text-[10px] uppercase font-bold text-slate-400 mb-1">Ricavi Immissione (Annuo)</span>
                                    <span className="text-xl font-bold text-blue-600">+{formatCurrency(revenueExported)}</span>
                                    <span className="block text-xs text-slate-500 mt-1">{exportedKwh.toLocaleString('it-IT', {maximumFractionDigits:0})} kWh immessi</span>
                                </div>
                            </div>

                            <div className="flex justify-between items-center p-3 border border-indigo-100 bg-indigo-50/30 rounded-lg">
                                <div>
                                    <span className="text-indigo-800 font-bold block">Cashflow Operativo Annuo</span>
                                    <span className="text-xs text-indigo-600">LiquiditÃ  effettiva generata dall'impianto</span>
                                </div>
                                <span className="text-2xl font-black text-indigo-700">{formatCurrency(totalYearlyCashflow)}</span>
                            </div>

                            {taxCredit > 0 && (
                                <div className="flex justify-between items-center p-3 text-sm text-slate-600 border-t border-dashed border-slate-200 pt-4">
                                    <span>Beneficio Fiscale Totale (Credito {taxCredit}%): <strong>{formatCurrency(taxBenefitTotal)}</strong></span>
                                    <span>Quota annua (5 anni): <strong>{formatCurrency(taxBenefitYearly)}/anno</strong></span>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    );
}

// --- MODULO: CALENDARIO UNIFICATO ---
function CalendarModule({ user, appId, navigateToModule }) {
    const [currentDate, setCurrentDate] = useState(new Date());
    const [selectedDate, setSelectedDate] = useState(new Date().toISOString().split('T')[0]);
    const [audits, setAudits] = useState([]);
    const [reminders, setReminders] = useState([]);
    const [appointments, setAppointments] = useState([]);
    const [loading, setLoading] = useState(true);
    
    // Modal nuovo evento manuale
    const [showModal, setShowModal] = useState(false);
    const [newEvent, setNewEvent] = useState({ title: '', date: selectedDate, time: '09:00', notes: '' });

    useEffect(() => {
        if (!user || !db) return;
        const unsubAudits = onSnapshot(collection(db, 'artifacts', appId, 'users', user.uid, 'audits'), snap => setAudits(snap.docs.map(d => ({id: d.id, ...d.data()}))));
        const unsubReminders = onSnapshot(collection(db, 'artifacts', appId, 'users', user.uid, 'reminders'), snap => setReminders(snap.docs.map(d => ({id: d.id, ...d.data()}))));
        const unsubAppts = onSnapshot(collection(db, 'artifacts', appId, 'users', user.uid, 'appointments'), snap => setAppointments(snap.docs.map(d => ({id: d.id, ...d.data()}))));
        
        setLoading(false);
        return () => { unsubAudits(); unsubReminders(); unsubAppts(); };
    }, [user, appId]);

    // Consolidamento automatico di tutte le fonti in un singolo stream di eventi
    const allEvents = useMemo(() => {
        let evs = [];
        audits.forEach(a => {
            if (a.prossimoIncontro) evs.push({ id: `mtg_${a.id}`, realId: a.id, title: `ðŸ¤ Incontro: ${a.nomeSocieta}`, date: a.prossimoIncontro, time: a.oraIncontro || '09:00', type: 'meeting', color: 'bg-purple-100 text-purple-700 border-purple-300' });
            if (a.dataRilievo) evs.push({ id: `ril_${a.id}`, realId: a.id, title: `ðŸ” Rilievo: ${a.nomeSocieta}`, date: a.dataRilievo, time: '09:00', type: 'audit', color: 'bg-green-100 text-green-700 border-green-300' });
        });
        reminders.forEach(r => {
            if (r.dueDate && !r.completed) evs.push({ id: `tsk_${r.id}`, realId: r.id, title: `ðŸ“Œ Task: ${r.text}`, date: r.dueDate, time: r.dueTime || '12:00', type: 'task', color: 'bg-orange-100 text-orange-700 border-orange-300' });
        });
        appointments.forEach(a => {
            evs.push({ id: `app_${a.id}`, realId: a.id, title: `ðŸ“… ${a.title}`, date: a.date, time: a.time || '09:00', type: 'generic', color: 'bg-blue-100 text-blue-700 border-blue-300', notes: a.notes });
        });
        // Ordina per orario (con fallback sicuro per evitare crash su .localeCompare)
        return evs.sort((a, b) => (a.time || '').localeCompare(b.time || ''));
    }, [audits, reminders, appointments]);

    const handleSaveEvent = async () => {
        if (!newEvent.title) return;
        await addDoc(collection(db, 'artifacts', appId, 'users', user.uid, 'appointments'), newEvent);
        setShowModal(false);
        setNewEvent({ title: '', date: selectedDate, time: '09:00', notes: '' });
    };

    const handleDeleteEvent = async (id) => {
        if(window.confirm("Eliminare questo appuntamento?")) {
            await deleteDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'appointments', id));
        }
    };

    // Logica rendering griglia calendario
    const year = currentDate.getFullYear();
    const month = currentDate.getMonth();
    const daysInMonth = new Date(year, month + 1, 0).getDate();
    const firstDayIndex = new Date(year, month, 1).getDay();
    const startDay = firstDayIndex === 0 ? 6 : firstDayIndex - 1; // LunedÃ¬ = 0
    const monthNames = ["Gennaio", "Febbraio", "Marzo", "Aprile", "Maggio", "Giugno", "Luglio", "Agosto", "Settembre", "Ottobre", "Novembre", "Dicembre"];
    
    const days = [];
    for (let i = 0; i < startDay; i++) days.push(null);
    for (let i = 1; i <= daysInMonth; i++) days.push(i);

    const prevMonth = () => setCurrentDate(new Date(year, month - 1, 1));
    const nextMonth = () => setCurrentDate(new Date(year, month + 1, 1));
    const isToday = (d) => {
        const today = new Date();
        return d && today.getDate() === d && today.getMonth() === month && today.getFullYear() === year;
    };

    const selectedEvents = allEvents.filter(e => e.date === selectedDate);

    if (loading) return <div className="p-10 text-center"><Loader2 className="animate-spin mx-auto text-blue-500"/></div>;

    return (
        <div className="max-w-6xl mx-auto h-full flex flex-col space-y-6">
            <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                <div>
                    <h2 className="text-2xl font-bold text-slate-800 flex items-center gap-2"><CalendarDays className="text-blue-600" size={28} /> Agenda Operativa</h2>
                    <p className="text-slate-500 text-sm mt-1">Visione unificata di Incontri Audit, Rilievi e Task prioritarie.</p>
                </div>
                <button onClick={() => { setNewEvent({...newEvent, date: selectedDate}); setShowModal(true); }} className="bg-blue-600 text-white px-4 py-2 rounded-lg font-bold shadow-md hover:bg-blue-700 flex items-center gap-2 transition">
                    <Plus size={18} /> Nuovo Evento
                </button>
            </div>

            <div className="grid grid-cols-1 lg:grid-cols-3 gap-6 flex-1 min-h-0">
                {/* CALENDARIO MENSILE (2/3 Spazio) */}
                <div className="lg:col-span-2 bg-white rounded-xl shadow-sm border border-slate-200 p-6 flex flex-col">
                    <div className="flex justify-between items-center mb-6">
                        <h3 className="text-xl font-black text-slate-800 uppercase tracking-tight">{monthNames[month]} {year}</h3>
                        <div className="flex gap-2">
                            <button onClick={prevMonth} className="p-2 bg-slate-100 rounded-lg hover:bg-slate-200 text-slate-600 transition"><ChevronLeft size={20}/></button>
                            <button onClick={() => setCurrentDate(new Date())} className="px-3 py-2 bg-slate-100 rounded-lg hover:bg-slate-200 text-slate-800 font-bold text-sm transition">Oggi</button>
                            <button onClick={nextMonth} className="p-2 bg-slate-100 rounded-lg hover:bg-slate-200 text-slate-600 transition"><ChevronRight size={20}/></button>
                        </div>
                    </div>
                    
                    <div className="grid grid-cols-7 gap-2 text-center text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">
                        <div>Lun</div><div>Mar</div><div>Mer</div><div>Gio</div><div>Ven</div><div>Sab</div><div>Dom</div>
                    </div>
                    
                    <div className="grid grid-cols-7 gap-2 flex-1">
                        {days.map((d, i) => {
                            if (!d) return <div key={`empty-${i}`} className="p-2 rounded-lg bg-slate-50/50 border border-transparent"></div>;
                            
                            const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
                            const dayEvents = allEvents.filter(e => e.date === dateStr);
                            const isSelected = selectedDate === dateStr;
                            
                            return (
                                <div 
                                    key={i} 
                                    onClick={() => setSelectedDate(dateStr)}
                                    className={`p-2 rounded-xl border flex flex-col gap-1 cursor-pointer transition-all min-h-[80px]
                                        ${isSelected ? 'border-blue-500 bg-blue-50 ring-2 ring-blue-200' : 'border-slate-200 hover:border-blue-300 hover:shadow-sm bg-white'}
                                    `}
                                >
                                    <div className="flex justify-between items-start">
                                        <span className={`w-6 h-6 flex items-center justify-center rounded-full text-sm font-bold ${isToday(d) ? 'bg-blue-600 text-white shadow-md' : 'text-slate-700'}`}>{d}</span>
                                        {dayEvents.length > 0 && <span className="text-[10px] font-bold bg-slate-100 text-slate-500 px-1.5 rounded">{dayEvents.length}</span>}
                                    </div>
                                    <div className="flex-1 flex flex-col gap-1 mt-1 overflow-hidden">
                                        {dayEvents.slice(0, 3).map((ev, idx) => (
                                            <div key={idx} className={`text-[9px] font-bold truncate px-1.5 py-0.5 rounded border ${ev.color}`}>
                                                {ev.time} {ev.title}
                                            </div>
                                        ))}
                                        {dayEvents.length > 3 && <div className="text-[10px] text-slate-400 font-medium pl-1">+{dayEvents.length - 3} altri</div>}
                                    </div>
                                </div>
                            );
                        })}
                    </div>
                </div>

                {/* AGENDA DEL GIORNO SELEZIONATO (1/3 Spazio) */}
                <div className="bg-[#f8fafc] rounded-xl shadow-inner border border-slate-200 p-6 flex flex-col">
                    <div className="mb-6 pb-4 border-b border-slate-200">
                        <p className="text-sm font-bold text-slate-500 uppercase tracking-wider mb-1">Agenda del giorno</p>
                        <h3 className="text-2xl font-black text-[#1a2b3c]">
                            {selectedDate.split('-').reverse().join('/')}
                        </h3>
                    </div>

                    <div className="flex-1 overflow-y-auto space-y-3 custom-scrollbar pr-2">
                        {selectedEvents.length === 0 ? (
                            <div className="text-center py-10 text-slate-400 flex flex-col items-center justify-center">
                                <CalendarDays size={48} className="opacity-20 mb-3"/>
                                <p className="font-medium">Nessun impegno.</p>
                                <p className="text-xs mt-1">Sfrutta il tempo per fare follow-up!</p>
                            </div>
                        ) : (
                            selectedEvents.map(ev => (
                                <div key={ev.id} className={`p-4 rounded-xl border-l-4 bg-white shadow-sm hover:shadow-md transition relative group ${ev.type === 'meeting' ? 'border-purple-500' : ev.type === 'audit' ? 'border-green-500' : ev.type === 'task' ? 'border-orange-500' : 'border-blue-500'}`}>
                                    <div className="flex justify-between items-start mb-1">
                                        <span className="text-sm font-black text-slate-800">{ev.time}</span>
                                        {ev.type === 'generic' && (
                                            <button onClick={() => handleDeleteEvent(ev.realId)} className="text-slate-300 hover:text-red-500 opacity-0 group-hover:opacity-100 transition"><Trash2 size={14}/></button>
                                        )}
                                        {ev.type !== 'generic' && (
                                            <button onClick={() => navigateToModule(ev.type === 'task' ? 'reminders' : 'audits')} className="text-[10px] bg-slate-100 hover:bg-slate-200 text-slate-600 px-2 py-1 rounded font-bold transition opacity-0 group-hover:opacity-100">Vai alla scheda</button>
                                        )}
                                    </div>
                                    <p className="font-bold text-[#1a2b3c] leading-snug">{ev.title}</p>
                                    {ev.notes && <p className="text-xs text-slate-500 mt-2 italic border-t border-slate-100 pt-2"><span className="font-medium not-italic text-slate-400">Note:</span> {ev.notes}</p>}
                                </div>
                            ))
                        )}
                    </div>
                </div>
            </div>

            {/* MODALE NUOVO EVENTO MANUALE */}
            {showModal && (
                <div className="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4 backdrop-blur-sm">
                    <div className="bg-white rounded-2xl p-6 w-full max-w-sm shadow-2xl animate-in fade-in zoom-in duration-200">
                        <div className="flex justify-between items-center mb-5 border-b border-slate-100 pb-3">
                            <h3 className="font-bold text-lg text-slate-800 flex items-center gap-2"><CalendarIcon className="text-blue-600"/> Aggiungi Evento</h3>
                            <button onClick={() => setShowModal(false)} className="text-slate-400 hover:bg-slate-100 p-1.5 rounded-lg transition"><X size={20}/></button>
                        </div>
                        <div className="space-y-4">
                            <Input label="Titolo Evento" value={newEvent.title} onChange={v => setNewEvent({...newEvent, title: v})} placeholder="Es. Chiamata fornitore, Formazione..." />
                            <div className="grid grid-cols-2 gap-4">
                                <Input label="Data" type="date" value={newEvent.date} onChange={v => setNewEvent({...newEvent, date: v})} />
                                <Input label="Ora" type="time" value={newEvent.time} onChange={v => setNewEvent({...newEvent, time: v})} />
                            </div>
                            <Textarea label="Note (Opzionale)" value={newEvent.notes} onChange={v => setNewEvent({...newEvent, notes: v})} placeholder="Dettagli..." />
                            
                            <button onClick={handleSaveEvent} className="w-full bg-blue-600 text-white py-3 rounded-lg font-bold mt-2 hover:bg-blue-700 shadow-md transition flex justify-center items-center gap-2">
                                <Save size={18}/> Salva in Agenda
                            </button>
                        </div>
                    </div>
                </div>
            )}
        </div>
    );
}

// --- UTILS & PLACEHOLDERS ---
